<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparrow CRM</title>
    <meta name="description" content="A free, private, offline-first CRM that lives in a single HTML file.">

    <!-- STYLES -->
    <style>
        :root {
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --midnight-green: #13505b; --cerulean: #0c7489; --persian-orange: #d38b5d; --golden-brown: #99621e; --uranian-blue: #b8e1ff;
            --bg-deep: var(--midnight-green); --bg-main: #1A6776; --bg-surface: #2a8ea1; --bg-inset: #104854;
            --text-primary: #f0f8ff; --text-secondary: var(--uranian-blue); --text-tertiary: #92c1de;
            --accent-primary: var(--persian-orange); --accent-primary-hover: #e6a079;
            --border-color: #3b9eaf; --border-radius: 6px;
            --shadow-color: rgba(0, 0, 0, 0.3); --shadow-md: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            --danger-color: #e53e3e; --danger-hover: #c53030; --success-color: #48bb78;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-family-sans); background-color: var(--bg-deep); color: var(--text-primary); font-size: 16px; line-height: 1.6; }
        h1, h2, h3 { margin: 0 0 0.75em 0; line-height: 1.2; color: var(--text-secondary); }
        h1 { font-size: 2rem; } h2 { font-size: 1.5rem; } h3 { font-size: 1.2rem; }
        a { color: var(--accent-primary); text-decoration: none; } a:hover { text-decoration: underline; }
        input, select, textarea, button { font-family: inherit; font-size: 1rem; color: var(--text-primary); }
        .hidden { display: none !important; }
        #app-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: var(--bg-deep); padding: 1rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; flex-wrap: wrap; gap: 1.5rem; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 0.75rem; }
        .logo-area .logo-svg { width: 40px; height: 40px; } .logo-area .logo-svg path { fill: var(--text-secondary); }
        .logo-area h1 { font-size: 1.75rem; margin: 0; color: var(--text-primary); }
        .search-area { flex-grow: 1; }
        .search-bar { width: 100%; max-width: 400px; padding: 0.5rem 1rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; transition: all 0.2s ease; }
        .search-bar:focus { box-shadow: 0 0 0 3px var(--accent-primary-hover); border-color: var(--accent-primary); }
        .actions-area { display: flex; gap: 0.75rem; }
        main { flex-grow: 1; padding: 1.5rem; background: var(--bg-main); }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border: 1px solid transparent; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .btn:disabled { background-color: #555 !important; border-color: #666 !important; color: #999 !important; cursor: not-allowed !important; opacity: 0.7; }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-primary); border-color: var(--accent-primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); border-color: var(--accent-primary-hover); }
        .btn-secondary { background-color: var(--bg-surface); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-deep); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        #welcomeScreen { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem; text-align: center; }
        #welcomeScreen .logo-svg { width: 80px; height: 80px; margin-bottom: 1rem; } #welcomeScreen .logo-svg path { fill: var(--text-secondary); }
        #welcomeScreen h1 { font-size: 2.5rem; } #welcomeScreen p { font-size: 1.2rem; color: var(--text-tertiary); max-width: 600px; margin-bottom: 2rem; }
        .drop-zone { border: 3px dashed var(--border-color); border-radius: 1rem; padding: 3rem; cursor: pointer; transition: all 0.2s ease; }
        .drop-zone.dragover { background-color: var(--bg-inset); border-color: var(--accent-primary); }
        #contactGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .contact-card { position: relative; background-color: var(--bg-surface); border-radius: var(--border-radius); padding: 1.25rem; box-shadow: var(--shadow-md); cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column; }
        .contact-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--accent-primary); }
        .contact-card h3 { color: var(--text-primary); margin-bottom: 0.75rem; font-size: 1.25rem; flex-shrink: 0; padding-right: 50px; }
        .contact-card-fields { flex-grow: 1; }
        .contact-card-field { font-size: 0.9rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.25rem; }
        .contact-card-field strong { color: var(--text-secondary); }
        .contact-card-tags { position: absolute; top: 1rem; right: 1rem; display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: flex-end; max-width: 50%; }
        .tag-badge { background-color: var(--bg-inset); color: var(--text-tertiary); padding: 0.1rem 0.5rem; font-size: 0.75rem; border-radius: 10px; white-space: nowrap; }
        #loadMoreContainer { margin-top: 2rem; text-align: center; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-main); margin: auto; padding: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); width: 90vw; max-width: 1400px; box-shadow: var(--shadow-md); position: relative; height: 90vh; display: flex; flex-direction: column; }
        #confirmModal .modal-content, #settingsModal .modal-content { width: 90%; max-width: 800px; height: auto; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; flex-shrink: 0; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 1rem; -ms-overflow-style: none; scrollbar-width: none; }
        .modal-body::-webkit-scrollbar { display: none; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; flex-shrink: 0; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; color: var(--text-tertiary); cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: var(--text-primary); }
        .detail-section { margin-bottom: 2rem; }
        .detail-section h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        #contact-fields-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 0 2rem; }
        .detail-field-group { display: grid; grid-template-columns: 150px 1fr; gap: 0.5rem 1rem; padding: 0.5rem 0; align-items: center; border-radius: 4px; border-bottom: 1px solid var(--bg-inset); cursor: pointer; }
        .detail-field-label { font-weight: 600; color: var(--text-secondary); text-align: right; padding-right: 1rem; white-space: normal; word-break: break-word; pointer-events: none; }
        .detail-field-value { position: relative; padding: 0.25rem 0.5rem; border-radius: 4px; min-height: 28px; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; pointer-events: none; }
        .detail-field-group:hover { background-color: var(--bg-inset); }
        .detail-field-group:hover .contextual-actions { opacity: 1; }
        .value-text { flex-grow: 1; }
        .contextual-actions { flex-shrink: 0; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s ease; pointer-events: all; }
        .contextual-actions button, .contextual-actions a button { background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 2px 6px; cursor: pointer; }
        .contextual-actions button:hover, .contextual-actions a button:hover { background: var(--bg-deep); }
        .inline-edit-input { width: 100%; padding: 0.25rem 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: 4px; pointer-events: all; }
        .inline-edit-input:focus { border-color: var(--accent-primary); outline: none; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: var(--text-secondary); font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent-primary); }
        #fields-list { list-style: none; padding: 0; }
        #fields-list li { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: var(--border-radius); }
        #fields-list li:nth-child(odd) { background-color: var(--bg-inset); }
        .field-name { flex-grow: 1; margin-left: 0.5rem; }
        .field-order-btn, .field-delete-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-tertiary); font-size: 1.2rem; line-height: 1;}
        .field-order-btn:disabled { cursor: not-allowed; opacity: 0.3; }
        .field-order-btn:hover:not(:disabled), .field-delete-btn:hover { color: var(--text-primary); background-color: var(--bg-surface); border-radius: 4px; }
        #fields-list .field-type-select { background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 0.25rem 0.5rem; color: var(--text-primary); }
        .ghost-mode-group { display: flex; align-items: center; gap: 0.5rem; }
        #delete-all-container, .danger-zone-section { margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--danger-hover); }
        #save-reminder { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--golden-brown); color: var(--text-primary); padding: 1rem; text-align: center; z-index: 500; display: flex; justify-content: center; align-items: center; gap: 1rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #save-reminder.visible { transform: translateY(0); }
        #notification-container { position: fixed; top: 85px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notification { padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); color: var(--text-primary); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .notification.visible { opacity: 1; transform: translateX(0); }
        .notification.info { background-color: var(--bg-surface); }
        .notification.success { background-color: var(--success-color); }
        .notification.danger { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div id="notification-container"><div id="notif-11855022-4992-4aef-8738-371f31903fda" class="notification info">Saving...</div><div id="notif-125f2e35-aa15-40b2-b2b2-2d0a48395576" class="notification info">Saving...</div><div id="notif-06b9fabe-2864-4781-9ff6-bffd3dda8168" class="notification success visible">Settings updated. Save the file to make them permanent.</div><div id="notif-d0b5eea1-67c2-449a-925a-ff1c8336984c" class="notification info">Saving...</div><div id="notif-790b47b2-1e5a-43a2-88ab-20f0e25ba606" class="notification info visible">Saving...</div><div id="notif-7d03767c-9d3f-409c-9d9d-939e69bc45d0" class="notification info">Saving...</div></div>
    <div id="app-wrapper">
        <div id="welcomeScreen" class="">
            <div class="logo-svg"></div><h1>Welcome to Sparrow CRM</h1>
            <p>Your private, portable, and powerful offline CRM. Get started by importing your contacts from a CSV file. All data stays on your machine.</p>
            <div id="file-drop-zone" class="drop-zone">
                <button id="import-csv-btn-welcome" class="btn btn-primary">Select or Drop CSV File</button>
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
            </div>
        </div>
        <div id="appScreen" class="hidden">
            <header>
                <div class="logo-area"><div class="logo-svg"></div><h1>Sparrow CRM</h1></div>
                <div class="search-area"><input type="search" id="main-search-input" class="search-bar" placeholder="Search contacts..."></div>
                <div class="actions-area"><button id="import-csv-btn-header" class="btn btn-secondary">Import CSV</button><button id="export-csv-btn" class="btn btn-secondary">Export All</button><button id="settings-btn" class="btn btn-secondary">Settings</button></div>
            </header>
            <main><div id="contactGrid"><div class="contact-card" data-contact-id="15041d60-2dd3-4919-ab28-fe1fc1b255cf"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Ela Suyunova</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14266231</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 594000</div></div></div><div class="contact-card" data-contact-id="44a45c94-fa5f-48e5-a4a3-5cac02760048"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Cheryl Lyn Aldridge</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14255943</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 168000</div></div></div><div class="contact-card" data-contact-id="aae407b1-bbe4-4a8a-95cc-21b256e7f265"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Crystal Rose Bender</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14240610</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-22</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 225000</div></div></div><div class="contact-card" data-contact-id="2ee5bda7-96ff-4e51-b76b-6264269bd0e3"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Paul Courtright</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14169393</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-02</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 38911</div></div></div><div class="contact-card" data-contact-id="72a3178e-6e41-4f7e-a051-9d5353c2799e"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Michael Mayers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14155731</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 191947</div></div></div><div class="contact-card" data-contact-id="70e5fea3-252a-4df9-b960-e3f40f2a29ff"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Osvaldo Licea Pena</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14152008</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-08</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 241544</div></div></div><div class="contact-card" data-contact-id="30099d77-546a-47be-a8e5-4ed071df3aca"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Cole Bastian</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14145005</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 135000</div></div></div><div class="contact-card" data-contact-id="f26ead36-fa2a-4d8e-8396-f6e12e245d05"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Tyler Jennings Ward</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14144599</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-16</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 311966</div></div></div><div class="contact-card" data-contact-id="78621115-a57b-43d8-a85a-5d7db8a3874f"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Charles Gross</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14109854</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-21</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 230000</div></div></div><div class="contact-card" data-contact-id="fb6c20cf-ca4f-4d8e-8612-a2fda42965ca"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Amanda LeClair</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14107066</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 353479</div></div></div><div class="contact-card" data-contact-id="51c09822-3d9b-4dd8-a018-b99784830289"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Jesus Idania Balderrama</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14097553</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 302421</div></div></div><div class="contact-card" data-contact-id="d0914999-22da-4626-be69-6b9082816d47"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Matthew Earl Hoag</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14084200</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-23</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 200000</div></div></div><div class="contact-card" data-contact-id="038bcab9-1435-4cbe-a040-6eba026d629c"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Kevin Roberto Berber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14067335</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 284747</div></div></div><div class="contact-card" data-contact-id="19d8d1e6-6b07-40ab-bc58-658d33f2fbca"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Shundraus Lewers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14038850</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 360000</div></div></div><div class="contact-card" data-contact-id="8f32c523-86f4-401c-957e-754b7fdb1a26"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Clarisa Estefany Lainez Baca</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14010400</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 290638</div></div></div><div class="contact-card" data-contact-id="8e6e10e8-fd64-4b6b-a192-d2f2c4b36fe1"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Glo Marissa Skurnicki</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13996270</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-23</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 279120</div></div></div><div class="contact-card" data-contact-id="ca09a668-9c3c-4ca6-8089-9b4a325cd757"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Cassidy Brothers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13969733</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-20</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 152192</div></div></div><div class="contact-card" data-contact-id="723779bb-e92c-4ec2-a1eb-e44718c3642c"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Amanda Cooper</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13967424</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 360000</div></div></div><div class="contact-card" data-contact-id="8fe2ec73-645d-4290-98a1-9c99c7373fb6"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Stephanie Dionne Frazier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13962857</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 135646</div></div></div><div class="contact-card" data-contact-id="24278ea7-398d-47b9-a9d3-7db7320c7ea2"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Daniel Martinez</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13954615</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-06</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 404557</div></div></div><div class="contact-card" data-contact-id="8037fa1c-a015-4871-a8b0-eef006184ec9"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Hilary Rodoni</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13923484</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-05</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 350000</div></div></div><div class="contact-card" data-contact-id="5f0fb96b-1f48-480a-95e8-1b7b829d7311"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>James Oloo Onyango</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13918966</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-02</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 1017500</div></div></div><div class="contact-card" data-contact-id="2dc0d8e7-dfe6-4944-8a0a-22d1c6d78962"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Robert Westbrook</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13907253</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-21</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 347310</div></div></div><div class="contact-card" data-contact-id="ee5d4cc5-acf0-4cff-9e01-daf67112edbd"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Aaron Cody Peltier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13903736</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-14</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 206060</div></div></div><div class="contact-card" data-contact-id="b4a0cab7-fa2f-4247-a7cd-b33bffc56010"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Patricia M Kenny</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13839427</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-27</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 190272</div></div></div><div class="contact-card" data-contact-id="c5d59454-8c76-40e2-a11f-5fa31dbd1c37"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Michael Cade Poole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13824925</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 433860</div></div></div><div class="contact-card" data-contact-id="918cf7ed-ebc0-4665-ab1d-7fca9e574687"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Scott Alan Barber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13819143</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-05</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 390000</div></div></div><div class="contact-card" data-contact-id="d97791c2-1106-4ce9-9cf4-facc28fa04ee"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Alien Ortega Padron</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13769151</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 283240</div></div></div><div class="contact-card" data-contact-id="6ea931e3-e30d-4623-9738-39a5b4f6c895"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Cassidy Smith</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13607539</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 240562</div></div></div><div class="contact-card" data-contact-id="31542921-1f51-428f-93c2-76a54e92f51f"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Bhavik Bhanderi</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13593776</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-13</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 629625</div></div></div><div class="contact-card" data-contact-id="8062bf8f-a270-4dbf-b657-fa1a3c9aaf66"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>James Dean Fenton</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13543744</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 425000</div></div></div><div class="contact-card" data-contact-id="d7b0596e-55ae-4c03-afed-0bdf634358ae"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Andrew Sean Goforth</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13444991</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 778500</div></div></div><div class="contact-card" data-contact-id="fd680084-5921-4f6a-93f3-1af27cdeacad"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Kelly L Newbill</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13412987</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 428367</div></div></div><div class="contact-card" data-contact-id="33cb23b6-669c-41bd-b585-65c4ed5b1390"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Sam Sungsoo Jun</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13205521</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-08</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 210000</div></div></div><div class="contact-card" data-contact-id="2f0a7745-1b7f-4d98-b330-83d8b006d75b"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Rose Lippincott</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12887296</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-20</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 125125</div></div></div><div class="contact-card" data-contact-id="42f14383-a2bd-432e-8e90-3ca87fb98b23"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Cary Robert Cole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12336217</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 1539172</div></div></div><div class="contact-card" data-contact-id="807910e7-e7dc-46e1-8a6a-6f17e4a71926"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Norma Sue Risch</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 11098628</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 285000</div></div></div><div class="contact-card" data-contact-id="c1f7a9ed-0096-4a83-a76f-59ccbdc08ffa"><div class="contact-card-tags"><span class="tag-badge">arive</span></div><h3>Benjamin Bouchette Patin</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 10759656</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 640000</div></div></div></div><div id="loadMoreContainer" class="hidden"><button id="loadMoreBtn" class="btn btn-secondary">Load More</button></div></main>
        </div>
    </div>
    <div id="contactDetailModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Ela Suyunova</h2><button class="modal-close-btn">√ó</button></div><div class="modal-body"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container"><div class="detail-field-group" data-field-name="Primary Borrower" title="Primary Borrower"><div class="detail-field-label">Primary Borrower</div><div class="detail-field-value"><span class="value-text">Ela Suyunova</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="Ela Suyunova">üìã</button></div></div></div><div class="detail-field-group" data-field-name="ARIVE Loan Id" title="ARIVE Loan Id"><div class="detail-field-label">ARIVE Loan Id</div><div class="detail-field-value"><span class="value-text">14266231</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="14266231">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Brokerage Branch Name" title="Brokerage Branch Name"><div class="detail-field-label">Brokerage Branch Name</div><div class="detail-field-value"><span class="value-text">UMortgage+ (1201)</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="UMortgage+ (1201)">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Loan Funded" title="Loan Funded"><div class="detail-field-label">Loan Funded</div><div class="detail-field-value"><span class="value-text">2025-05-28</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="2025-05-28">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Total Loan Amount" title="Total Loan Amount"><div class="detail-field-label">Total Loan Amount</div><div class="detail-field-value"><span class="value-text">594000</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="594000">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Compensation Percentage" title="Compensation Percentage"><div class="detail-field-label">Compensation Percentage</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Description" title="Referral Contact Description"><div class="detail-field-label">Referral Contact Description</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Email" title="Referral Contact Email"><div class="detail-field-label">Referral Contact Email</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Name" title="Referral Contact Name"><div class="detail-field-label">Referral Contact Name</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Phone" title="Referral Contact Phone"><div class="detail-field-label">Referral Contact Phone</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div></div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container"></div></div><div class="detail-section"><h3>Add New Info</h3><div class="add-new-field-form"><div class="form-group"><label for="new-field-name">Field Name / Label</label><input type="text" id="new-field-name"></div><div class="form-group"><label for="new-field-type">Type</label><select id="new-field-type"><option value="text">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option><option value="relationship">relationship</option></select></div><button id="add-new-field-btn" class="btn btn-secondary">Add</button></div><div id="relationship-creator-ui" class="hidden" style="margin-top:1rem;"><div class="form-group"><label for="relationship-search">Find Contact</label><input type="text" id="relationship-search"><div id="relationship-search-results" class="relationship-search-results"></div></div></div></div><div class="danger-zone-section"><h3>Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="modal-footer"><button class="btn btn-secondary modal-close-btn">Close</button><button id="modal-save-changes-btn" class="btn btn-primary" disabled="">Save Changes</button></div></div></div>
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Settings</h2><button class="modal-close-btn">√ó</button></div>
            <div class="modal-body">
                <h3>Manage Fields</h3><p>Use arrows to reorder fields. The top-most visible field is the contact's title.</p><ul id="fields-list"><li data-field-name="Primary Borrower">
                    <div class="field-order-controls" style="display:flex;flex-direction:column;">
                        <button class="field-order-btn" data-action="up" title="Move Up" disabled="">‚ñ≤</button>
                        <button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button>
                    </div>
                    <span class="field-name">Primary Borrower</span>
                    <select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select>
                    <label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label>
                    <button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button>
                </li><li data-field-name="ARIVE Loan Id">
                    <div class="field-order-controls" style="display:flex;flex-direction:column;">
                        <button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button>
                        <button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button>
                    </div>
                    <span class="field-name">ARIVE Loan Id</span>
                    <select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select>
                    <label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label>
                    <button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button>
                </li><li data-field-name="Brokerage Branch Name">
                    <div class="field-order-controls" style="display:flex;flex-direction:column;">
                        <button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button>
                        <button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button>
                    </div>
                    <span class="field-name">Brokerage Branch Name</span>
                    <select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select>
                    <label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label>
                    <button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button>
                </li><li data-field-name="Loan Funded">
                    <div class="field-order-controls" style="display:flex;flex-direction:column;">
                        <button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button>
                        <button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button>
                    </div>
                    <span class="field-name">Loan Funded</span>
                    <select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select>
                    <label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label>
                    <button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button>
                </li><li data-field-name="Total Loan Amount">
                    <div class="field-order-controls" style="display:flex;flex-direction:column;">
                        <button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button>
                        <button class="field-order-btn" data-action="down" title="Move Down" disabled="">‚ñº</button>
                    </div>
                    <span class="field-name">Total Loan Amount</span>
                    <select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select>
                    <label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label>
                    <button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button>
                </li></ul>
                <h3 style="margin-top:2rem;">Data Management</h3><div class="form-group ghost-mode-group"><input type="checkbox" id="ghostModeCheckbox" style="width:auto;"><label for="ghostModeCheckbox">Ghost Mode (clears session data on close)</label></div>
                <div id="delete-all-container"><h3>Danger Zone</h3><button id="delete-all-btn" class="btn btn-danger">DELETE ALL DATA</button><p style="font-size:0.9rem;color:var(--text-tertiary);">This permanently deletes all contacts, relationships, and custom fields from this file.</p></div>
            </div>
            <div class="modal-footer"><button id="save-settings-btn" class="btn btn-primary">Save Settings</button></div>
        </div>
    </div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="confirm-title">FINAL CONFIRMATION</h2></div><div class="modal-body"><p id="confirm-message">This is your last chance. Clicking OK will permanently erase everything.</p></div><div class="modal-footer"><button id="confirm-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-ok-btn" class="btn btn-danger">OK</button></div></div></div>
    <div id="save-reminder" class=""><span id="save-reminder-text">To enable one-click saving, grant permission to edit this file.</span><button id="save-now-btn" class="btn btn-primary">Grant Permission &amp; Save</button></div>
    <script id="sparrow-data" type="application/json">{
  "contacts": [],
  "tasks": [],
  "activities": [],
  "links": [],
  "relationships": [],
  "settings": {
    "fields": [],
    "customActivityTypes": [
      "Phone Call",
      "SMS",
      "Email",
      "Meeting"
    ],
    "ghostMode": true
  }
}</script>
    <script>
    const LOG_PREFIX = '[SparrowCRM]', CONTACTS_PER_PAGE = 50, FIELD_TYPES = ['text', 'longtext', 'number', 'date', 'phone', 'email', 'url', 'boolean', 'currency'], RELATIONSHIP_FIELD_TYPE = 'relationship';
    const SVG_LOGO_CONTENT = `<?xml version="1.0" encoding="utf-8"?><svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(1.92623, 0, 0, 1.927014, -60.113792, -58.564831)"><g data-name="Bird Nest" id="Bird_Nest"><path d="M64,32A32,32,0,0,0,32,64a31.51,31.51,0,0,0,.61,6.18s0,0,0,0,0,0,0,.07c.05.26.11.52.17.78s.11.49.17.73.11.43.17.65.16.57.25.85.1.35.16.52c.11.33.22.66.34,1,0,.13.08.25.13.38.15.39.3.78.46,1.16l.08.18a32,32,0,0,0,5.74,9l.06.06c.32.35.64.69,1,1l.1.1c.33.33.66.65,1,1l.09.08a29.29,29.29,0,0,0,2.28,1.89l.53.38c.2.15.4.3.61.44l.72.47.45.29.82.49.37.22.91.49.29.15c.33.17.67.34,1,.49l.16.08a32.52,32.52,0,0,0,4.87,1.78l.18,0,1,.25.46.1c.29.07.59.13.89.18l.61.11.81.13.74.09.73.08.92.07.58,0c.51,0,1,0,1.53,0s1,0,1.54,0l.57,0,.93-.07.72-.08.74-.09.82-.13.6-.11q.45-.07.9-.18l.45-.1,1-.25.18,0a31.57,31.57,0,0,0,4.88-1.78l.15-.07,1-.5.28-.15c.31-.16.61-.32.92-.5l.36-.2.83-.5.43-.28c.25-.16.5-.32.74-.49l.57-.41c.19-.13.39-.26.57-.41a28.88,28.88,0,0,0,2.27-1.87l.12-.11c.33-.3.66-.62,1-.93l.11-.12c.33-.33.64-.66,1-1l.08-.08q.49-.54,1-1.11h0a31.78,31.78,0,0,0,4.76-7.82l.09-.22c.16-.38.3-.75.45-1.13,0-.14.1-.27.14-.41.12-.31.22-.63.33-1s.12-.37.17-.56.16-.54.23-.81.13-.46.19-.69l.15-.66c.06-.28.13-.56.18-.84,0,0,0,0,0-.06h0A32,32,0,0,0,64,32Zm0,2A30,30,0,0,1,94,64a30.58,30.58,0,0,1-.42,5H65V67.55l18.35.7h0A1,1,0,0,0,84,66.49L78.81,62h.8a1,1,0,1,0,0-2H76.48l-3.73-3.2a14.35,14.35,0,0,0-6.22-3.93l-7.28-2.28a5.48,5.48,0,0,0-10.08-.48,1.27,1.27,0,0,0-.27.18l-5,5a1,1,0,0,0-.21,1.09,1,1,0,0,0,.92.62h5.06l3.38,5.33a13,13,0,0,0,9.84,5.14H63V69H34.47A29.51,29.51,0,0,1,34,64,30,30,0,0,1,64,34ZM93.18,71.12c-.18.73-.38,1.45-.61,2.16l-.15.44c-.23.68-.48,1.34-.76,2-.06.15-.14.3-.21.45-.23.53-.48,1-.74,1.55-.09.18-.18.37-.28.56-.3.55-.62,1.08-1,1.61l-.43.67c-.34.51-.69,1-1.06,1.49l-.46.59q-.51.65-1,1.26L86,84.4c-.41.44-.82.86-1.25,1.27l-.4.38c-.51.47-1,.91-1.56,1.34l-.35.27c-.58.45-1.17.89-1.78,1.3l-.08.05c-.67.44-1.35.85-2,1.24h0c-.7.38-1.41.74-2.14,1.07l-.13.06c-.73.33-1.48.63-2.23.9h0a30.66,30.66,0,0,1-4.68,1.23l-.28,0c-.75.12-1.5.22-2.27.29l-.36,0c-.78.06-1.57.1-2.36.1s-1.58,0-2.36-.1l-.36,0c-.76-.07-1.52-.17-2.27-.29l-.28,0A30.53,30.53,0,0,1,54.1,92.3l0,0c-.76-.26-1.5-.56-2.23-.89l-.14-.06c-.73-.33-1.44-.69-2.14-1.07h0c-.69-.39-1.37-.8-2-1.24l-.1-.06c-.61-.4-1.2-.84-1.77-1.28l-.36-.28c-.53-.43-1.05-.87-1.55-1.34-.14-.12-.27-.26-.41-.39-.42-.4-.83-.82-1.23-1.24l-.5-.55c-.35-.4-.7-.81-1-1.23L40.08,82c-.36-.48-.71-1-1-1.48-.15-.22-.3-.45-.44-.68-.33-.52-.64-1.05-.94-1.6l-.3-.58c-.25-.49-.5-1-.72-1.51-.07-.16-.15-.31-.22-.48-.27-.64-.52-1.3-.75-2l-.16-.46c-.22-.7-.43-1.42-.61-2.14l0-.13H93.21ZM48.67,53.35s0,.09,0,.14a3.38,3.38,0,0,0,.08.34,6.13,6.13,0,0,0,.18.61c.05.13.1.25.16.38l.08.18H47Zm8.83-1.72a3.77,3.77,0,0,1,.11.87,3.5,3.5,0,0,1-5.72,2.71L51.66,55a3.4,3.4,0,0,1-1-2.49,3.23,3.23,0,0,1,.19-1.13,3.5,3.5,0,0,1,6.7.26ZM53,57.86l.28.06a5.14,5.14,0,0,0,.88.08,5.91,5.91,0,0,0,1-.1h0a5.18,5.18,0,0,0,1-.28l.07,0a5.92,5.92,0,0,0,.83-.43l.08,0a5.82,5.82,0,0,0,.72-.57l.09-.08a6.39,6.39,0,0,0,.59-.68l.08-.1a6.06,6.06,0,0,0,.45-.78l.06-.12a5.08,5.08,0,0,0,.31-.85l0-.14a5.51,5.51,0,0,0,.14-.92s0,0,0-.07l6.33,2a12.33,12.33,0,0,1,5.38,3.42l.09.09,2,1.72H66.66a6.26,6.26,0,0,1-5.2-2.78l-.26-.4a1,1,0,0,0-1.39-.27,1,1,0,0,0-.27,1.38l.26.4A8.22,8.22,0,0,0,66.66,62h9.08l4.82,4.14L63,65.47a11,11,0,0,1-8.28-4.28l-2.17-3.42C52.66,57.81,52.81,57.83,53,57.86Z"/></g></g></svg>`;
    const SVG_FAVICON_CONTENT = `<?xml version="1.0" encoding="utf-8"?><svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><style>path{fill:black;}@media(prefers-color-scheme:dark){path{fill:white;}}</style><g transform="matrix(1.92623, 0, 0, 1.927014, -60.113792, -58.564831)"><g data-name="Bird Nest" id="Bird_Nest"><path d="M64,32A32,32,0,0,0,32,64a31.51,31.51,0,0,0,.61,6.18s0,0,0,0,0,0,0,.07c.05.26.11.52.17.78s.11.49.17.73.11.43.17.65.16.57.25.85.1.35.16.52c.11.33.22.66.34,1,0,.13.08.25.13.38.15.39.3.78.46,1.16l.08.18a32,32,0,0,0,5.74,9l.06.06c.32.35.64.69,1,1l.1.1c.33.33.66.65,1,1l.09.08a29.29,29.29,0,0,0,2.28,1.89l.53.38c.2.15.4.3.61.44l.72.47.45.29.82.49.37.22.91.49.29.15c.33.17.67.34,1,.49l.16.08a32.52,32.52,0,0,0,4.87,1.78l.18,0,1,.25.46.1c.29.07.59.13.89.18l.61.11.81.13.74.09.73.08.92.07.58,0c.51,0,1,0,1.53,0s1,0,1.54,0l.57,0,.93-.07.72-.08.74-.09.82-.13.6-.11q.45-.07.9-.18l.45-.1,1-.25.18,0a31.57,31.57,0,0,0,4.88-1.78l.15-.07,1-.5.28-.15c.31-.16.61-.32.92-.5l.36-.2.83-.5.43-.28c.25-.16.5-.32.74-.49l.57-.41c.19-.13.39-.26.57-.41a28.88,28.88,0,0,0,2.27-1.87l.12-.11c.33-.3.66-.62,1-.93l.11-.12c.33-.33.64-.66,1-1l.08-.08q.49-.54,1-1.11h0a31.78,31.78,0,0,0,4.76-7.82l.09-.22c.16-.38.3-.75.45-1.13,0-.14.1-.27.14-.41.12-.31.22-.63.33-1s.12-.37.17-.56.16-.54.23-.81.13-.46.19-.69l.15-.66c.06-.28.13-.56.18-.84,0,0,0,0,0-.06h0A32,32,0,0,0,64,32Zm0,2A30,30,0,0,1,94,64a30.58,30.58,0,0,1-.42,5H65V67.55l18.35.7h0A1,1,0,0,0,84,66.49L78.81,62h.8a1,1,0,1,0,0-2H76.48l-3.73-3.2a14.35,14.35,0,0,0-6.22-3.93l-7.28-2.28a5.48,5.48,0,0,0-10.08-.48,1.27,1.27,0,0,0-.27.18l-5,5a1,1,0,0,0-.21,1.09,1,1,0,0,0,.92.62h5.06l3.38,5.33a13,13,0,0,0,9.84,5.14H63V69H34.47A29.51,29.51,0,0,1,34,64,30,30,0,0,1,64,34ZM93.18,71.12c-.18.73-.38,1.45-.61,2.16l-.15.44c-.23.68-.48,1.34-.76,2-.06.15-.14.3-.21.45-.23.53-.48,1-.74,1.55-.09.18-.18.37-.28.56-.3.55-.62,1.08-1,1.61l-.43.67c-.34.51-.69,1-1.06,1.49l-.46.59q-.51.65-1,1.26L86,84.4c-.41.44-.82.86-1.25,1.27l-.4.38c-.51.47-1,.91-1.56,1.34l-.35.27c-.58.45-1.17.89-1.78,1.3l-.08.05c-.67.44-1.35.85-2,1.24h0c-.7.38-1.41.74-2.14,1.07l-.13.06c-.73.33-1.48.63-2.23.9h0a30.66,30.66,0,0,1-4.68,1.23l-.28,0c-.75.12-1.5.22-2.27.29l-.36,0c-.78.06-1.57.1-2.36.1s-1.58,0-2.36-.1l-.36,0c-.76-.07-1.52-.17-2.27-.29l-.28,0A30.53,30.53,0,0,1,54.1,92.3l0,0c-.76-.26-1.5-.56-2.23-.89l-.14-.06c-.73-.33-1.44-.69-2.14-1.07h0c-.69-.39-1.37-.8-2-1.24l-.1-.06c-.61-.4-1.2-.84-1.77-1.28l-.36-.28c-.53-.43-1.05-.87-1.55-1.34-.14-.12-.27-.26-.41-.39-.42-.4-.83-.82-1.23-1.24l-.5-.55c-.35-.4-.7-.81-1-1.23L40.08,82c-.36-.48-.71-1-1-1.48-.15-.22-.3-.45-.44-.68-.33-.52-.64-1.05-.94-1.6l-.3-.58c-.25-.49-.5-1-.72-1.51-.07-.16-.15-.31-.22-.48-.27-.64-.52-1.3-.75-2l-.16-.46c-.22-.7-.43-1.42-.61-2.14l0-.13H93.21ZM48.67,53.35s0,.09,0,.14a3.38,3.38,0,0,0,.08.34,6.13,6.13,0,0,0,.18.61c.05.13.1.25.16.38l.08.18H47Zm8.83-1.72a3.77,3.77,0,0,1,.11.87,3.5,3.5,0,0,1-5.72,2.71L51.66,55a3.4,3.4,0,0,1-1-2.49,3.23,3.23,0,0,1,.19-1.13,3.5,3.5,0,0,1,6.7.26ZM53,57.86l.28.06a5.14,5.14,0,0,0,.88.08,5.91,5.91,0,0,0,1-.1h0a5.18,5.18,0,0,0,1-.28l.07,0a5.92,5.92,0,0,0,.83-.43l.08,0a5.82,5.82,0,0,0,.72-.57l.09-.08a6.39,6.39,0,0,0,.59-.68l.08-.1a6.06,6.06,0,0,0,.45-.78l.06-.12a5.08,5.08,0,0,0,.31-.85l0-.14a5.51,5.51,0,0,0,.14-.92s0,0,0-.07l6.33,2a12.33,12.33,0,0,1,5.38,3.42l.09.09,2,1.72H66.66a6.26,6.26,0,0,1-5.2-2.78l-.26-.4a1,1,0,0,0-1.39-.27,1,1,0,0,0-.27,1.38l.26.4A8.22,8.22,0,0,0,66.66,62h9.08l4.82,4.14L63,65.47a11,11,0,0,1-8.28-4.28l-2.17-3.42C52.66,57.81,52.81,57.83,53,57.86Z"/></g></g></svg>`;
    
    // Global state, will be populated on init
    let AppState = { contacts: [], tasks: [], activities: [], links: [], relationships: [], settings: { fields: [], customActivityTypes: ['Phone Call', 'SMS', 'Email', 'Meeting'], ghostMode: false, }, ui: { isFsaSupported: false, fileHandle: null, unsavedChanges: false, currentFilter: '', renderedContactsCount: 0, } };
    let DOM = {}; // DOM references populated on init

    // --- UTILITY FUNCTIONS ---
    const Utils = {
        generateUUID: () => crypto.randomUUID(),
        showModal: (modal) => modal.classList.add("visible"),
        hideModal: (modal) => modal.classList.remove("visible"),
        debounce: (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; },
        showConfirm: (title, message, okClass = 'btn-primary') => {
            return new Promise((resolve) => {
                DOM.confirmModal.title.textContent = title; DOM.confirmModal.message.textContent = message;
                DOM.confirmModal.okBtn.className = `btn ${okClass}`; Utils.showModal(DOM.confirmModal.el);
                const okHandler = () => { cleanup(); resolve(true); }; const cancelHandler = () => { cleanup(); resolve(false); };
                DOM.confirmModal.okBtn.addEventListener('click', okHandler); DOM.confirmModal.cancelBtn.addEventListener('click', cancelHandler);
                function cleanup() { Utils.hideModal(DOM.confirmModal.el); DOM.confirmModal.okBtn.removeEventListener('click', okHandler); DOM.confirmModal.cancelBtn.removeEventListener('click', cancelHandler); }
            });
        },
        formatFieldValue: (value, type) => {
            if (value === null || value === undefined || value === '') return '';
            switch (type) {
                case 'currency': { const num = parseFloat(String(value).replace(/[^0-9.-]+/g,"")); return isNaN(num) ? value : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num); }
                case 'date': { const d = new Date(value); if (d instanceof Date && !isNaN(d.getTime())) { const utcDate = new Date(d.valueOf() + d.getTimezoneOffset() * 60000); return utcDate.toLocaleDateString('en-US', { year: '2-digit', month: 'numeric', day: 'numeric' }); } return value; }
                default: return value;
            }
        },
        getContactDisplayName: (contact) => {
            if (!contact) return "Unknown Contact";
            const sortedVisibleFields = AppState.settings.fields.filter(f => f.visible).sort((a, b) => a.order - b.order);
            if (sortedVisibleFields.length > 0) { const primaryFieldName = sortedVisibleFields[0].name; const primaryValue = contact.fields[primaryFieldName]; if (primaryValue) return primaryValue; }
            const firstName = contact.fields['First Name'] || contact.fields['firstName'] || ''; const lastName = contact.fields['Last Name'] || contact.fields['lastName'] || '';
            const fullName = `${firstName} ${lastName}`.trim(); if (fullName) return fullName;
            const email = contact.fields['Email'] || contact.fields['email'] || ''; if (email) return email;
            return `Contact ${contact.sparrow_contact_id.substring(0, 8)}`;
        }
    };

    // --- CORE LOGIC (DATA MANIPULATION) ---
    const Core = {
        setUnsavedChanges: (status) => {
            if (AppState.ui.unsavedChanges === status) return;
            console.log(`${LOG_PREFIX} Unsaved changes status set to: ${status}`);
            AppState.ui.unsavedChanges = status;
            DOM.saveReminder.classList.toggle('visible', status);
            const contactModalSaveBtn = document.getElementById('modal-save-changes-btn');
            if(contactModalSaveBtn) contactModalSaveBtn.disabled = !status;
            if(status) {
                if(AppState.ui.isFsaSupported) {
                    if (AppState.ui.fileHandle) { DOM.saveReminderText.textContent = "You have unsaved changes."; DOM.saveNowBtn.textContent = "Save Now"; }
                    else { DOM.saveReminderText.textContent = "To enable one-click saving, grant permission to edit this file."; DOM.saveNowBtn.textContent = "Grant Permission & Save"; }
                } else { DOM.saveReminderText.textContent = "You have unsaved changes. Download a new copy to save."; DOM.saveNowBtn.textContent = "Download & Save"; }
            }
        },
        parseCSV: (text) => {
            const result=[],lines=text.trim().split(/\r\n|\n/),headers=lines[0].split(",").map(h=>h.trim().replace(/"/g,""));
            for(let i=1;i<lines.length;i++){const line=lines[i];if(!line.trim())continue;const values=[];let currentVal="",inQuotes=!1;for(let char of line){if(char==='"')inQuotes=!inQuotes;else if(char===","&&!inQuotes)values.push(currentVal.trim()),currentVal="";else currentVal+=char}values.push(currentVal.trim());if(values.every(v=>v==="")){console.log(`${LOG_PREFIX} Skipping empty row at line ${i+1}.`);continue}if(values.length===headers.length){const obj={};for(let j=0;j<headers.length;j++)obj[headers[j]]=values[j].replace(/^"|"$/g,"").replace(/""/g,'"');result.push(obj)}else console.warn(`${LOG_PREFIX} Mismatched row length at line ${i+1}. Skipping.`)}
            console.log(`${LOG_PREFIX} Parsed ${result.length} rows.`);return result;
        },
        processCSVData: async (data) => {
            const importTag=prompt("Enter a tag for this import (e.g., 'Leads'). Leave blank for none.",""),newHeaders=Object.keys(data[0]);newHeaders.forEach(h=>{if(!AppState.settings.fields.find(f=>f.name===h))AppState.settings.fields.push({name:h,type:"text",visible:!0,order:AppState.settings.fields.length})});AppState.contacts.forEach(c=>{newHeaders.forEach(h=>{if(!c.fields.hasOwnProperty(h))Object.assign(c.fields,{[h]:""})})});for(const row of data){let existingContact=null;if(row.sparrow_contact_id)existingContact=AppState.contacts.find(c=>c.sparrow_contact_id===row.sparrow_contact_id);if(!existingContact&&row.Email){const m=AppState.contacts.filter(c=>c.fields.Email&&c.fields.Email.toLowerCase()===row.Email.toLowerCase());if(m.length===1)existingContact=m[0]}if(existingContact){if(await Utils.showConfirm("Update Contact?",`Found existing contact for '${Utils.getContactDisplayName(existingContact)}'. Update with new data?`)){Object.entries(row).forEach(([k,v])=>{if(v!==null&&v!=="")existingContact.fields[k]=v});if(importTag&&!existingContact.tags.includes(importTag))existingContact.tags.push(importTag)}}else{const newContact={sparrow_contact_id:Utils.generateUUID(),tags:importTag?[importTag]:[],fields:{}};AppState.settings.fields.forEach(f=>{newContact.fields[f.name]=row[f.name]||""});AppState.contacts.push(newContact)}}Core.setUnsavedChanges(!0);UI.renderApp();
        },
        saveData: async () => {
            DOM.saveReminder.classList.remove('visible'); const savingNotifId = UI.showNotification('Saving...', 'info', 0);
            try {
                if (AppState.ui.isFsaSupported) {
                    if (!AppState.ui.fileHandle) { AppState.ui.fileHandle = await window.showSaveFilePicker({ types: [{ description: 'Sparrow CRM File', accept: {'text/html': ['.html']} }] }); }
                    const writable = await AppState.ui.fileHandle.createWritable(); await writable.write(Core.generateHtmlToSave()); await writable.close();
                    Core.setUnsavedChanges(false); UI.showNotification('File saved successfully.', 'success');
                } else {
                    const blob = new Blob([Core.generateHtmlToSave()],{type:'text/html'}), a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sparrow-crm-data.html'; a.click(); a.remove(); URL.revokeObjectURL(a.href);
                    Core.setUnsavedChanges(false); UI.showNotification('File downloaded successfully.', 'success');
                }
            } catch (err) {
                if (err.name !== 'AbortError') { console.error(`${LOG_PREFIX} Error saving file:`, err); UI.showNotification(`Error saving file: ${err.message}`, 'danger'); }
                else { UI.showNotification('Save cancelled.', 'info'); }
            } finally { UI.hideNotification(savingNotifId); }
        },
        generateHtmlToSave: () => { const dataToSave = { ...AppState }; delete dataToSave.ui; return document.documentElement.outerHTML.replace(/<script id="sparrow-data" type="application\/json">.*?<\/script>/s, `<script id="sparrow-data" type="application/json">${JSON.stringify(dataToSave, null, 2)}<\/script>`); },
        exportToCSV: () => {
            if(AppState.contacts.length === 0) { UI.showNotification("No contacts to export.","info"); return; }
            const headers = AppState.settings.fields.map(f => f.name); if(!headers.includes("sparrow_contact_id")) headers.unshift("sparrow_contact_id"); if(!headers.includes("tags")) headers.push("tags");
            const csvRows = [headers.join(",")];
            AppState.contacts.forEach(c => { const values = headers.map(h => { let v; if(h === "sparrow_contact_id") v = c.sparrow_contact_id; else if(h === "tags") v = c.tags.join(";"); else v = c.fields[h] || ""; const s = String(v); return s.includes(",") || s.includes('"') || s.includes("\n") ? `"${s.replace(/"/g,'""')}"` : s; }); csvRows.push(values.join(",")) });
            const blob = new Blob([csvRows.join("\n")], {type:"text/csv;charset=utf-8;"}), a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `sparrow-crm-export-${new Date().toISOString().split("T")[0]}.csv`; a.click(); a.remove(); URL.revokeObjectURL(a.href);
        },
        updateContactField: (contactId, fieldName, newValue, originalValue) => { if (newValue === originalValue) { return; } const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); if (contact) { contact.fields[fieldName] = newValue; Core.setUnsavedChanges(true); } },
        deleteField: async(fieldName) => { if (await Utils.showConfirm("Delete Field?", `Are you sure you want to permanently delete the field "${fieldName}"? This will remove the field and all its data from every contact.`, 'btn-danger')) { AppState.settings.fields = AppState.settings.fields.filter(f => f.name !== fieldName).map((f, i) => ({...f, order: i})); AppState.contacts.forEach(contact => { delete contact.fields[fieldName]; }); Core.setUnsavedChanges(true); UI.renderSettingsModal(); UI.showNotification(`Field "${fieldName}" deleted.`, "success"); } },
        deleteAllData: async() => { if (!(await Utils.showConfirm("DELETE ALL DATA?","This action will erase all contacts, relationships, and custom fields from this file.","btn-danger"))) return; if (await Utils.showConfirm("FINAL CONFIRMATION", "This is your last chance. Clicking OK will permanently erase everything.", "btn-danger")) { AppState.contacts = []; AppState.tasks = []; AppState.activities = []; AppState.links = []; AppState.relationships = []; AppState.settings.fields = []; UI.resetToWelcomeScreen(); if (AppState.ui.fileHandle) { await Core.saveData(); UI.showNotification("All data deleted and file updated.", "success"); } else { Core.setUnsavedChanges(true); UI.showNotification("All data has been deleted. Save the file to make it permanent.", "success"); } } else { UI.showNotification("Delete cancelled.", "info"); } }
    };

    // --- UI RENDERING FUNCTIONS ---
    const UI = {
        showNotification: (message, type = 'info', duration = 3000) => {
            const notifId = 'notif-' + Utils.generateUUID(), notif = document.createElement('div');
            notif.id = notifId; notif.className = `notification ${type}`; notif.textContent = message;
            DOM.notificationContainer.appendChild(notif); setTimeout(() => notif.classList.add('visible'), 10);
            if (duration > 0) { setTimeout(() => UI.hideNotification(notifId), duration); } return notifId;
        },
        hideNotification: (notifId) => { const notif = document.getElementById(notifId); if(notif) { notif.classList.remove('visible'); notif.addEventListener('transitionend', () => notif.remove()); } },
        resetToWelcomeScreen: () => { Utils.hideModal(DOM.settingsModal); DOM.appScreen.classList.add('hidden'); DOM.welcomeScreen.classList.remove('hidden'); },
        renderApp: () => { DOM.welcomeScreen.classList.add('hidden'); DOM.appScreen.classList.remove('hidden'); UI.renderContactGrid(); },
        renderContactGrid: (loadMore = false) => {
            const filterText = DOM.mainSearchInput.value.toLowerCase();
            if (filterText !== AppState.ui.currentFilter || !loadMore) { AppState.ui.currentFilter = filterText; AppState.ui.renderedContactsCount = 0; DOM.contactGrid.innerHTML = ''; }
            const filteredContacts = AppState.contacts.filter(c => Object.values(c.fields).some(v => String(v).toLowerCase().includes(filterText)) || c.tags.some(t => t.toLowerCase().includes(filterText)));
            const allVisibleFields = AppState.settings.fields.filter(f => f.visible).sort((a, b) => a.order - b.order);
            const otherDisplayFields = allVisibleFields.slice(1, 5);
            const contactsToRender = filteredContacts.slice(AppState.ui.renderedContactsCount, AppState.ui.renderedContactsCount + CONTACTS_PER_PAGE);
            const fragment = document.createDocumentFragment();
            contactsToRender.forEach(contact => {
                const card = document.createElement('div'); card.className = 'contact-card'; card.dataset.contactId = contact.sparrow_contact_id;
                const tagsHTML = `<div class="contact-card-tags">${contact.tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('')}</div>`;
                let cardHTML = `${tagsHTML}<h3>${Utils.getContactDisplayName(contact)}</h3><div class="contact-card-fields">`;
                otherDisplayFields.forEach(field => { const rawValue = contact.fields[field.name]; if (rawValue) { cardHTML += `<div class="contact-card-field"><strong>${field.name}:</strong> ${Utils.formatFieldValue(rawValue, field.type)}</div>`; } });
                card.innerHTML = cardHTML + `</div>`; fragment.appendChild(card);
            });
            DOM.contactGrid.appendChild(fragment); AppState.ui.renderedContactsCount += contactsToRender.length;
            DOM.loadMoreContainer.classList.toggle('hidden', AppState.ui.renderedContactsCount >= filteredContacts.length);
        },
        renderContactModal: (contactId) => {
            const contact = AppState.contacts.find(c=>c.sparrow_contact_id === contactId); if(!contact) return;
            const sortedFields=AppState.settings.fields.sort((a,b)=>a.order - b.order);
            const fieldsHTML=sortedFields.map(f=>{if(!f.visible)return"";const raw=contact.fields[f.name]||"",formatted=Utils.formatFieldValue(raw,f.type);let actions=`<button title="Copy" data-action="copy" data-value="${raw}">üìã</button>`;if(f.type==="email")actions+=`<a href="mailto:${raw}" title="Email"><button>üìß</button></a>`;else if(f.type==="phone")actions+=`<a href="tel:${raw}" title="Call"><button>üìû</button></a>`;return`<div class="detail-field-group" data-field-name="${f.name}" title="${f.name}"><div class="detail-field-label">${f.name}</div><div class="detail-field-value"><span class="value-text">${formatted}</span><div class="contextual-actions">${actions}</div></div></div>`}).join("");
            const relationships = AppState.relationships.filter(r=>r.source_contact_id===contactId).map(r=>{const t=AppState.contacts.find(c=>c.sparrow_contact_id===r.target_contact_id);return`<div class="detail-field-group"><div class="detail-field-label" title="${r.label}">${r.label}</div><div class="detail-field-value" style="pointer-events:all;cursor:default"><a href="#${r.target_contact_id}" class="relationship-link">${Utils.getContactDisplayName(t)}</a></div></div>`}).join("");
            const fieldTypeOptions = [...FIELD_TYPES, RELATIONSHIP_FIELD_TYPE].map(t => `<option value="${t}">${t}</option>`).join('');
            const modalHTML = `<div class="modal-header"><h2>${Utils.getContactDisplayName(contact)}</h2><button class="modal-close-btn">&times;</button></div><div class="modal-body"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container">${fieldsHTML}</div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container">${relationships}</div></div><div class="detail-section"><h3>Add New Info</h3><div class="add-new-field-form"><div class="form-group"><label for="new-field-name">Field Name / Label</label><input type="text" id="new-field-name"></div><div class="form-group"><label for="new-field-type">Type</label><select id="new-field-type">${fieldTypeOptions}</select></div><button id="add-new-field-btn" class="btn btn-secondary">Add</button></div><div id="relationship-creator-ui" class="hidden" style="margin-top:1rem;"><div class="form-group"><label for="relationship-search">Find Contact</label><input type="text" id="relationship-search"><div id="relationship-search-results" class="relationship-search-results"></div></div></div></div><div class="danger-zone-section"><h3>Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="modal-footer"><button class="btn btn-secondary modal-close-btn">Close</button><button id="modal-save-changes-btn" class="btn btn-primary" disabled>Save Changes</button></div>`;
            DOM.contactDetailModal.querySelector('.modal-content').innerHTML = modalHTML;
            Events.setupContactModalEventListeners(contactId);
            Utils.showModal(DOM.contactDetailModal);
        },
        renderSettingsModal: () => {
            const modalContent = DOM.settingsModal.querySelector('.modal-content');
            const fields = AppState.settings.fields.sort((a,b) => a.order - b.order);
            const fieldsListHTML = fields.map((field, index) => {
                return `<li data-field-name="${field.name}">
                    <div class="field-order-controls" style="display:flex;flex-direction:column;">
                        <button class="field-order-btn" data-action="up" title="Move Up" ${index===0?'disabled':''}>‚ñ≤</button>
                        <button class="field-order-btn" data-action="down" title="Move Down" ${index===fields.length-1?'disabled':''}>‚ñº</button>
                    </div>
                    <span class="field-name">${field.name}</span>
                    <select class="field-type-select">${FIELD_TYPES.map(t=>`<option value="${t}" ${field.type===t?'selected':''}>${t}</option>`).join('')}</select>
                    <label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" ${field.visible?'checked':''}> Visible</label>
                    <button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button>
                </li>`;
            }).join('');
            modalContent.querySelector('#fields-list').innerHTML = fieldsListHTML;
            modalContent.querySelector('#ghostModeCheckbox').checked = AppState.settings.ghostMode;
            Utils.showModal(DOM.settingsModal);
        }
    };

    // --- EVENT LISTENERS ---
    const Events = {
        init: () => {
            // Populate DOM object now that the document is loaded
            DOM.welcomeScreen = document.getElementById('welcomeScreen'); DOM.appScreen = document.getElementById('appScreen');
            DOM.importCsvWelcomeBtn = document.getElementById('import-csv-btn-welcome'); DOM.importCsvHeaderBtn = document.getElementById('import-csv-btn-header');
            DOM.csvFileInput = document.getElementById('csv-file-input'); DOM.fileDropZone = document.getElementById('file-drop-zone');
            DOM.contactGrid = document.getElementById('contactGrid'); DOM.mainSearchInput = document.getElementById('main-search-input');
            DOM.contactDetailModal = document.getElementById('contactDetailModal'); DOM.settingsModal = document.getElementById('settingsModal');
            DOM.settingsBtn = document.getElementById('settings-btn'); DOM.exportCsvBtn = document.getElementById('export-csv-btn');
            DOM.saveReminder = document.getElementById('save-reminder'); DOM.saveReminderText = document.getElementById('save-reminder-text');
            DOM.saveNowBtn = document.getElementById('save-now-btn'); DOM.loadMoreContainer = document.getElementById('loadMoreContainer');
            DOM.loadMoreBtn = document.getElementById('loadMoreBtn'); DOM.ghostModeCheckbox = document.getElementById('ghostModeCheckbox');
            DOM.notificationContainer = document.getElementById('notification-container');
            DOM.confirmModal = { el: document.getElementById('confirmModal'), title: document.getElementById('confirm-title'), message: document.getElementById('confirm-message'), okBtn: document.getElementById('confirm-ok-btn'), cancelBtn: document.getElementById('confirm-cancel-btn') };

            const importTrigger=()=>DOM.csvFileInput.click(); DOM.importCsvWelcomeBtn.addEventListener("click",importTrigger); DOM.importCsvHeaderBtn.addEventListener("click",importTrigger);
            DOM.csvFileInput.addEventListener("change",Events.handleFileSelect); DOM.fileDropZone.addEventListener("dragover",Events.handleDragOver);
            DOM.fileDropZone.addEventListener("dragleave",Events.handleDragLeave); DOM.fileDropZone.addEventListener("drop",Events.handleDrop);
            DOM.mainSearchInput.addEventListener("input",Utils.debounce(()=>{const t=DOM.mainSearchInput.value,e=new URL(window.location);t?e.searchParams.set("q",t):e.searchParams.delete("q"),history.replaceState(null,"",e.toString()),UI.renderContactGrid()},300));
            DOM.exportCsvBtn.addEventListener("click",Core.exportToCSV); DOM.settingsBtn.addEventListener("click",UI.renderSettingsModal);
            DOM.saveNowBtn.addEventListener("click",Core.saveData); DOM.loadMoreBtn.addEventListener("click",()=>UI.renderContactGrid(!0));
            document.body.addEventListener("click",t=>{if(t.target.classList.contains("modal-close-btn")){t.target.closest(".modal")?.classList.remove('visible')}});
            DOM.settingsModal.addEventListener("click",Events.handleSettingsModalClick);
            DOM.contactGrid.addEventListener("click",t=>{const e=t.target.closest(".contact-card");e&&(window.location.hash=e.dataset.contactId)});
            window.addEventListener("hashchange",()=>{const t=window.location.hash.substring(1),e=DOM.contactDetailModal.classList.contains("visible"),o=AppState.contacts.find(e=>e.sparrow_contact_id===t);if(t&&o){if(!e)UI.renderContactModal(t)}else if(!t&&e)Utils.hideModal(DOM.contactDetailModal)});
            window.addEventListener("beforeunload",t=>{if(AppState.ui.unsavedChanges){t.preventDefault();t.returnValue=""}});
        },
        handleFileSelect: (e) => { const file = e.target.files[0]; if (file) Events.readFile(file); e.target.value = ''; },
        handleDragOver: (e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.add('dragover'); },
        handleDragLeave: (e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('dragover'); },
        handleDrop: (e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('dragover'); const file = e.dataTransfer.files[0]; if (file && (file.type === "text/csv" || file.name.endsWith('.csv'))) Events.readFile(file); else UI.showNotification("Please drop a valid .csv file.", "danger"); },
        readFile: (file) => { const reader = new FileReader; reader.onload = e => { try { const data = Core.parseCSV(e.target.result); data.length > 0 ? Core.processCSVData(data) : UI.showNotification("CSV file is empty or could not be parsed.", "danger"); } catch(err) { console.error(`${LOG_PREFIX} Error processing file:`, err); UI.showNotification(`Error processing file: ${err.message}`, "danger"); }}; reader.readAsText(file); },
        handleSettingsModalClick: (e) => {
            const button = e.target.closest('button'); if (!button) return;
            if(button.id === "save-settings-btn") {
                const newFields = []; DOM.settingsModal.querySelectorAll('#fields-list li').forEach((li, index) => { const name = li.dataset.fieldName; const originalField = AppState.settings.fields.find(f => f.name === name); if(originalField) { newFields.push({ ...originalField, type: li.querySelector('.field-type-select').value, visible: li.querySelector('.field-visibility-toggle').checked, order: index }); } });
                AppState.settings.fields = newFields; AppState.settings.ghostMode = DOM.settingsModal.querySelector('#ghostModeCheckbox').checked;
                if (AppState.settings.ghostMode) localStorage.removeItem('sparrow-crm-state');
                Core.setUnsavedChanges(true); Utils.hideModal(DOM.settingsModal); UI.renderContactGrid(); UI.showNotification("Settings updated. Save the file to make them permanent.", "success");
            } else if (button.id === 'delete-all-btn') { Core.deleteAllData(); }
            else {
                const action = button.dataset.action; const fieldName = button.closest('li')?.dataset.fieldName; if (!action || !fieldName) return;
                let fields = AppState.settings.fields; const fieldIndex = fields.findIndex(f => f.name === fieldName); if (fieldIndex === -1) return;
                if(action === 'up' && fieldIndex > 0) { [fields[fieldIndex], fields[fieldIndex - 1]] = [fields[fieldIndex - 1], fields[fieldIndex]]; }
                else if(action === 'down' && fieldIndex < fields.length - 1) { [fields[fieldIndex], fields[fieldIndex + 1]] = [fields[fieldIndex + 1], fields[fieldIndex]]; }
                else if(action === 'delete') { Core.deleteField(fieldName); e.stopImmediatePropagation(); return; } // Prevent re-render from bubbling
                fields.forEach((f, i) => f.order = i);
                UI.renderSettingsModal();
            }
        },
        setupContactModalEventListeners: (contactId) => { const modalContent = DOM.contactDetailModal.querySelector('.modal-content'); if (modalContent) { modalContent.addEventListener('click', Events.handleContactModalClick); modalContent.addEventListener('focusout', Events.handleContactModalFocusOut); modalContent.addEventListener('keydown', Events.handleContactModalKeyDown); modalContent.addEventListener('input', Events.handleContactModalInput); document.getElementById('modal-save-changes-btn').addEventListener('click', Core.saveData); } },
        handleContactModalClick: e => {
            const contactId = window.location.hash.substring(1);
            if (e.target.closest('#modal-delete-contact-btn')) { Core.deleteContact(contactId); return; }
            const actionBtn = e.target.closest('[data-action="copy"]'); if(actionBtn) { navigator.clipboard.writeText(actionBtn.dataset.value).then(() => UI.showNotification('Copied!', 'info', 1500)); return; }
            const relationshipLink = e.target.closest('.relationship-link'); if (relationshipLink) { e.preventDefault(); window.location.hash = relationshipLink.dataset.contactId; return; }
            if (e.target.closest('#add-new-field-btn')) { const nameInput = document.getElementById('new-field-name'), typeSelect = document.getElementById('new-field-type'); if (typeSelect.value === RELATIONSHIP_FIELD_TYPE) { UI.showNotification("Type a label, then search for and click a contact below.", "info"); } else { Core.addCustomField(contactId, nameInput.value, typeSelect.value); nameInput.value = ''; } return; }
            const relSearchResult = e.target.closest('.relationship-search-result'); if(relSearchResult) { Core.addRelationship(contactId, relSearchResult.dataset.contactId, document.getElementById('new-field-name').value); return; }
            const fieldGroup = e.target.closest('.detail-field-group');
            if (fieldGroup && !fieldGroup.querySelector('input, textarea')) {
                const valueContainer = fieldGroup.querySelector('.detail-field-value'); const fieldName = fieldGroup.dataset.fieldName;
                const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); const originalValue = contact.fields[fieldName] || '';
                valueContainer.innerHTML = `<input type="text" class="inline-edit-input" value="${originalValue}" data-original-value="${originalValue}">`;
                valueContainer.querySelector('.inline-edit-input').focus();
            }
        },
        handleContactModalFocusOut: e => { if (e.target.classList.contains('inline-edit-input')) { const input=e.target,valueContainer=input.parentElement,fieldName=valueContainer.closest('.detail-field-group').dataset.fieldName,contactId=window.location.hash.substring(1); Core.updateContactField(contactId, fieldName, input.value, input.dataset.originalValue); const fieldDef=AppState.settings.fields.find(f=>f.name===fieldName),formattedValue=Utils.formatFieldValue(input.value,fieldDef.type);let actionsHTML=`<button title="Copy" data-action="copy" data-value="${input.value}">üìã</button>`;if(fieldDef.type==='email'){actionsHTML+=`<a href="mailto:${input.value}" title="Email"><button>üìß</button></a>`}else if(fieldDef.type==='phone'){actionsHTML+=`<a href="tel:${input.value}" title="Call"><button>üìû</button></a>`} valueContainer.innerHTML=`<span class="value-text">${formattedValue}</span><div class="contextual-actions">${actionsHTML}</div>`; } },
        handleContactModalKeyDown: e => { if (e.target.classList.contains('inline-edit-input')) { if (e.key === 'Enter') { e.target.blur(); } else if (e.key === 'Escape') { const input = e.target; input.value = input.dataset.originalValue; e.target.blur(); } } },
        handleContactModalInput: e => { if('new-field-type'===e.target.id){document.getElementById('relationship-creator-ui').classList.toggle('hidden','relationship'!==e.target.value)}else if('relationship-search'===e.target.id){const t=e.target.value.toLowerCase(),o=document.getElementById('relationship-search-results');o.innerHTML="";if(t.length<2)return;const n=window.location.hash.substring(1),s=AppState.contacts.filter(e=>e.sparrow_contact_id!==n&&Utils.getContactDisplayName(e).toLowerCase().includes(t));s.slice(0,5).forEach(e=>{const t=document.createElement('div');t.className='relationship-search-result';t.dataset.contactId=e.sparrow_contact_id;t.textContent=Utils.getContactDisplayName(e);o.appendChild(t)})}}
    };
    
    // --- APP INITIALIZATION ---
    function init() {
        console.log(`${LOG_PREFIX} Initializing application...`);
        // Populate DOM object now that the document is loaded
        Events.init();
        
        let loadedState = null;
        const dataScript = document.getElementById('sparrow-data');
        if (dataScript && dataScript.textContent.trim().length > 2) { try { loadedState = JSON.parse(dataScript.textContent); } catch (e) { console.error(`${LOG_PREFIX} Failed to parse data.`, e); } }
        else if (localStorage.getItem('sparrow-crm-state')) { try { loadedState = JSON.parse(localStorage.getItem('sparrow-crm-state')); } catch (e) { console.error(`${LOG_PREFIX} Failed to parse local storage data.`, e); } }
        if (loadedState) {
            AppState = { ...AppState, ...loadedState, ui: AppState.ui };
            window.addEventListener('unload', () => { if (!AppState.settings.ghostMode) { try { const stateToStore = { ...AppState }; delete stateToStore.ui; localStorage.setItem('sparrow-crm-state', JSON.stringify(stateToStore)); } catch (e) { console.error(e); } } else { localStorage.removeItem('sparrow-crm-state'); } });
        }
        
        AppState.ui.isFsaSupported = 'showOpenFilePicker' in window;
        AppState.contacts.length > 0 ? UI.renderApp() : UI.resetToWelcomeScreen();
        const searchParams = new URLSearchParams(window.location.search);
        if (searchParams.has('q')) { const query = searchParams.get('q'); DOM.mainSearchInput.value = query; UI.renderContactGrid(); }
        const hash = window.location.hash.substring(1);
        if (hash && AppState.contacts.find(c => c.sparrow_contact_id === hash)) { UI.renderContactModal(hash); }
    }
    document.addEventListener('DOMContentLoaded', init);
    </script>

</body></html>