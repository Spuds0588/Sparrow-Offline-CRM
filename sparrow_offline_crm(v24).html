<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparrow CRM</title>
    <meta name="description" content="A free, private, offline-first CRM that lives in a single HTML file.">

    <!-- STYLES -->
    <style>
        :root {
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --midnight-green: #13505b; --cerulean: #0c7489; --persian-orange: #d38b5d; --golden-brown: #99621e; --uranian-blue: #b8e1ff;
            --bg-deep: var(--midnight-green); --bg-main: #1A6776; --bg-surface: #2a8ea1; --bg-inset: #104854;
            --text-primary: #f0f8ff; --text-secondary: var(--uranian-blue); --text-tertiary: #92c1de;
            --accent-primary: var(--persian-orange); --accent-primary-hover: #e6a079;
            --border-color: #3b9eaf; --border-radius: 6px;
            --shadow-color: rgba(0, 0, 0, 0.3); --shadow-md: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            --danger-color: #e53e3e; --danger-hover: #c53030; --success-color: #48bb78;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-family-sans); background-color: var(--bg-deep); color: var(--text-primary); font-size: 16px; line-height: 1.6; }
        h1, h2, h3 { margin: 0 0 0.75em 0; line-height: 1.2; color: var(--text-secondary); }
        a { color: var(--accent-primary); text-decoration: none; } a:hover { text-decoration: underline; }
        input, select, textarea, button { font-family: inherit; font-size: 1rem; color: var(--text-primary); }
        .hidden { display: none !important; }
        #app-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: var(--bg-deep); padding: 1rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; flex-wrap: wrap; gap: 1.5rem; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 0.75rem; }
        .logo-area h1 { font-size: 1.75rem; margin: 0; color: var(--text-primary); }
        .search-area { flex-grow: 1; }
        .search-bar { width: 100%; max-width: 400px; padding: 0.5rem 1rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; transition: all 0.2s ease; }
        .search-bar:focus { box-shadow: 0 0 0 3px var(--accent-primary-hover); border-color: var(--accent-primary); }
        .actions-area { display: flex; gap: 0.75rem; }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border: 1px solid transparent; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .btn:disabled { background-color: #555 !important; border-color: #666 !important; color: #999 !important; cursor: not-allowed !important; opacity: 0.7; }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-primary); border-color: var(--accent-primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); border-color: var(--accent-primary-hover); }
        .btn-secondary { background-color: var(--bg-surface); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-deep); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        #welcomeScreen { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem; text-align: center; }
        #welcomeScreen h1 { font-size: 2.5rem; } #welcomeScreen p { font-size: 1.2rem; color: var(--text-tertiary); max-width: 600px; margin-bottom: 2rem; }
        .drop-zone { border: 3px dashed var(--border-color); border-radius: 1rem; padding: 3rem; cursor: pointer; transition: all 0.2s ease; }
        .drop-zone.dragover { background-color: var(--bg-inset); border-color: var(--accent-primary); }
        #contactGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .contact-card { position: relative; background-color: var(--bg-surface); border-radius: var(--border-radius); padding: 1.25rem; box-shadow: var(--shadow-md); cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column; }
        .contact-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--accent-primary); }
        .contact-card h3 { color: var(--text-primary); margin-bottom: 0.75rem; font-size: 1.25rem; flex-shrink: 0; padding-right: 50px; }
        .contact-card-fields { flex-grow: 1; }
        .contact-card-field { font-size: 0.9rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.25rem; }
        .contact-card-field strong { color: var(--text-secondary); }
        .contact-card-tags { position: absolute; top: 1rem; right: 1rem; display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: flex-end; max-width: 50%; }
        .tag-badge { background-color: var(--bg-inset); color: var(--text-tertiary); padding: 0.1rem 0.5rem; font-size: 0.75rem; border-radius: 10px; white-space: nowrap; }
        #loadMoreContainer { margin-top: 2rem; text-align: center; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-main); margin: auto; padding: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); width: 90vw; max-width: 1400px; box-shadow: var(--shadow-md); position: relative; height: 90vh; display: flex; flex-direction: column; }
        .secondary-modal .modal-content { height: auto; width: 90%; max-width: 500px; z-index: 1010; }
        #confirmModal .modal-content, #settingsModal .modal-content { width: 90%; max-width: 800px; height: auto; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; flex-shrink: 0; }
        .modal-header .actions-area { margin-left: auto; padding-left: 2rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 1rem; -ms-overflow-style: none; scrollbar-width: none; }
        .modal-body::-webkit-scrollbar { display: none; }
        #contactDetailModal .modal-body { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; flex-shrink: 0; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; color: var(--text-tertiary); cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: var(--text-primary); }
        .detail-section { margin-bottom: 2rem; }
        .detail-section h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        #contact-fields-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 0 2rem; }
        .detail-field-group { display: grid; grid-template-columns: 150px 1fr; gap: 0.5rem 1rem; padding: 0.5rem 0; align-items: center; border-radius: 4px; border-bottom: 1px solid var(--bg-inset); cursor: pointer; }
        .detail-field-label { font-weight: 600; color: var(--text-secondary); text-align: right; padding-right: 1rem; white-space: normal; word-break: break-word; pointer-events: none; }
        .detail-field-value { position: relative; padding: 0.25rem 0.5rem; border-radius: 4px; min-height: 28px; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; pointer-events: none; }
        .detail-field-group:hover { background-color: var(--bg-inset); }
        .detail-field-group:hover .contextual-actions { opacity: 1; }
        .value-text { flex-grow: 1; }
        .contextual-actions { flex-shrink: 0; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s ease; pointer-events: all; }
        .contextual-actions button, .contextual-actions a button { background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 2px 6px; cursor: pointer; }
        .contextual-actions button:hover, .contextual-actions a button:hover { background: var(--bg-deep); }
        .inline-edit-input { width: 100%; padding: 0.25rem 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: 4px; pointer-events: all; }
        .inline-edit-input:focus { border-color: var(--accent-primary); outline: none; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: var(--text-secondary); font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent-primary); }
        #fields-list { list-style: none; padding: 0; }
        #fields-list li { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: var(--border-radius); }
        #fields-list li:nth-child(odd) { background-color: var(--bg-inset); }
        .field-name { flex-grow: 1; margin-left: 0.5rem; }
        .field-order-btn, .field-delete-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-tertiary); font-size: 1.2rem; line-height: 1;}
        .field-order-btn:disabled { cursor: not-allowed; opacity: 0.3; }
        .field-order-btn:hover:not(:disabled), .field-delete-btn:hover { color: var(--text-primary); background-color: var(--bg-surface); border-radius: 4px; }
        #fields-list .field-type-select { background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 0.25rem 0.5rem; color: var(--text-primary); }
        .ghost-mode-group { display: flex; align-items: center; gap: 0.5rem; }
        #delete-all-container, .danger-zone-section { margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--danger-hover); }
        #save-reminder { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--golden-brown); color: var(--text-primary); padding: 1rem; text-align: center; z-index: 500; display: flex; justify-content: center; align-items: center; gap: 1rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #save-reminder.visible { transform: translateY(0); }
        #notification-container { position: fixed; top: 85px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notification { padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); color: var(--text-primary); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .notification.visible { opacity: 1; transform: translateX(0); }
        .notification.info { background-color: var(--bg-surface); }
        .notification.success { background-color: var(--success-color); }
        .notification.danger { background-color: var(--danger-color); }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; border-radius: var(--border-radius); }
        .item-list li:nth-child(odd) { background-color: var(--bg-inset); }
        .item-list .item-title { flex-grow: 1; }
        .item-list .item-date { color: var(--text-tertiary); font-size: 0.9rem; cursor: pointer; }
        .item-list .item-actions button { background: none; border: none; cursor: pointer; padding: 4px; font-size: 1.2rem; color: var(--text-tertiary); }
        .item-list .item-actions button:hover { color: var(--text-primary); }
        .add-item-form { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
        .add-item-form .form-group { margin: 0; flex-grow: 1;}
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: var(--bg-surface); min-width: 160px; box-shadow: var(--shadow-md); z-index: 1; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .dropdown-content button { width: 100%; text-align: left; background: none; border: none; padding: 12px 16px; color: var(--text-primary); }
        .dropdown-content button:hover { background-color: var(--bg-deep); }
        .dropdown:hover .dropdown-content { display: block; }
    </style>
</head>
<body>
    <div id="notification-container"></div>
    <div id="app-wrapper">
        <div id="welcomeScreen" class=""><h1>Welcome to Sparrow CRM</h1><p>Your private, portable, and powerful offline CRM. Get started by importing your contacts from a CSV file. All data stays on your machine.</p><div id="file-drop-zone" class="drop-zone"><button id="import-csv-btn-welcome" class="btn btn-primary">Select or Drop CSV File</button><input type="file" id="csv-file-input" accept=".csv" class="hidden"></div></div>
        <div id="appScreen" class=""><header><div class="logo-area"><h1>Sparrow CRM</h1></div><div class="search-area"><input type="search" id="main-search-input" class="search-bar" placeholder="Search contacts..."></div><div class="actions-area"><button id="import-csv-btn-header" class="btn btn-secondary">Import CSV</button><div class="dropdown"><button id="export-data-btn" class="btn btn-secondary">Export Data</button><div class="dropdown-content"><button data-export-type="contacts">Export Contacts</button><button data-export-type="tasks">Export Tasks</button><button data-export-type="activities">Export Activities</button></div></div><button id="tasks-btn" class="btn btn-secondary">Tasks</button><button id="settings-btn" class="btn btn-secondary">Settings</button></div></header><main><div id="contactGrid"><div class="contact-card" data-contact-id="fd8fdb32-361e-44de-9691-4d04349c86b1"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Ela Suyunova</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14266231</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/28/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $594,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="54a1a3f8-3082-4ebc-812d-558e7b59fbf7"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Cheryl Lyn Aldridge</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14255943</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/29/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $168,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="9b340f5b-977b-4d15-8064-72eaad12d31e"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Crystal Rose Bender</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14240610</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/22/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $225,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="e111fe74-35e4-4f0b-81ed-674ae9881253"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Paul Courtright</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14169393</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/2/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $38,911.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="e52be28a-f104-46d9-bc30-a95337d540b5"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Michael Mayers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14155731</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/7/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $191,947.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="899bf9e0-8c35-49a4-912b-059594e1ac22"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Osvaldo Licea Pena</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14152008</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/8/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $241,544.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="10fc86e8-9478-4592-8c1c-75f059de1a2e"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Cole Bastian</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14145005</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/29/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $135,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="274f0294-abfe-483d-b708-858347726ea4"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Tyler Jennings Ward</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14144599</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/16/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $311,966.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="5a492aab-c1d7-4d7a-b657-d777836cc052"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Charles Gross</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14109854</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/21/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $230,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="67cee26b-67e8-4297-9522-c94400ad53c5"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Amanda LeClair</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14107066</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/1/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $353,479.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="4e3f23bf-57da-451b-bb60-189d7a6976c1"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Jesus Idania Balderrama</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14097553</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/28/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $302,421.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="1fbd7863-5921-43a0-9d05-19912f696aa0"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Matthew Earl Hoag</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14084200</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/23/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $200,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="a5772d81-af3b-49be-9a59-7c2015068091"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Kevin Roberto Berber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14067335</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/12/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $284,747.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="61d662bc-71e6-4be4-bb88-91bac6a5f609"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Shundraus Lewers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14038850</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/29/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $360,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="15207a44-faa9-4688-9a6a-cbf6bd7304d8"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Clarisa Estefany Lainez Baca</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14010400</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/30/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $290,638.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="216bedb2-6daa-4ac3-a968-e22c4b19c208"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Glo Marissa Skurnicki</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13996270</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/23/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $279,120.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="08d4c7af-9684-4e9e-9b88-d35600ad333e"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Cassidy Brothers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13969733</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/20/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $152,192.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="1c82be5f-e713-411e-a115-1ddde6db7ff5"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Amanda Cooper</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13967424</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/1/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $360,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="3064ded9-f641-416b-a5bb-0c30c6373a71"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Stephanie Dionne Frazier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13962857</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/30/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $135,646.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="c758af56-1b3c-4e6a-8c7d-382c7d7edf97"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Daniel Martinez</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13954615</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/6/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $404,557.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="3dcc0274-b44d-462c-95ef-e1d79bb3a22c"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Hilary Rodoni</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13923484</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/5/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $350,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="10bc3340-2bff-4612-a0ee-b5319c093e5a"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>James Oloo Onyango</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13918966</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/2/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $1,017,500.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="bd246405-9f79-489c-8ce3-f112262ada3a"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Robert Westbrook</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13907253</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/21/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $347,310.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="ca08b43b-3f68-4714-a158-a43dbad9b2cd"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Aaron Cody Peltier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13903736</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/14/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $206,060.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="9dd0457a-34b8-4a23-bfff-cec0fc2f2a37"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Patricia M Kenny</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13839427</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/27/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $190,272.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="558fe505-8833-457f-9879-24a45b55fd3a"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Michael Cade Poole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13824925</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/12/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $433,860.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="858f6dff-4d15-46f6-b0ea-8416078e8811"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Scott Alan Barber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13819143</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/5/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $390,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="94b949e2-59d2-4320-a824-cbd28f6fd77b"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Alien Ortega Padron</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13769151</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/28/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $283,240.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="481863b1-9174-4247-9791-6d680b69204b"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Cassidy Smith</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13607539</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/30/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $240,562.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="c362152a-d4a2-4f47-98e9-26185162566e"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Bhavik Bhanderi</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13593776</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/13/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $629,625.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="c83a7db4-9755-4cd8-ae64-fc2775192f98"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>James Dean Fenton</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13543744</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/7/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $425,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="b79a5eb3-b70f-472e-9f2d-00618c4d1c2c"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Andrew Sean Goforth</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13444991</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/30/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $778,500.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="1a8a9bab-0f4a-4508-9c7c-ff0d5e4ceb32"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Kelly L Newbill</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13412987</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/29/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $428,367.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="e6d3edce-14ff-4055-8d04-c90a3b4dbe68"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Sam Sungsoo Jun</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13205521</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/8/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $210,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="a99eb1a5-31ac-453e-a145-d47929cc5eea"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Rose Lippincott</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12887296</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/20/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $125,125.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="8bd38ae1-8e91-40ed-b7ec-05a10cf7c383"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Cary Robert Cole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12336217</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/12/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $1,539,172.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="a8c806d3-4b30-4689-ba3c-08b2e2f071d3"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Norma Sue Risch</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 11098628</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/1/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $285,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="9bb46a7c-e470-4a26-8773-c89be28146fe"><div class="contact-card-tags"><span class="tag-badge">test1</span></div><h3>Benjamin Bouchette Patin</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 10759656</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/7/25</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $640,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div></div><div id="loadMoreContainer" class="hidden"><button id="loadMoreBtn" class="btn btn-secondary">Load More</button></div></main></div>
        <div id="taskScreen" class="hidden"><header><h1>All Tasks</h1><button id="back-to-contacts-btn" class="btn btn-secondary">Back to Contacts</button></header><main><div id="global-task-container"><div class="detail-section"><h3>Add Global Task</h3><form class="add-item-form" data-form-type="global-task"><div class="form-group"><label for="global-task-title">New Task</label><input type="text" id="global-task-title" required=""></div><div class="form-group"><label for="global-task-due-date">Due Date</label><input type="date" id="global-task-due-date"></div><button type="submit" class="btn btn-secondary">Add Global Task</button></form></div></div><div id="all-tasks-list"><ul class="item-list"><li data-task-id="a7d16edd-4ca5-4dd9-98c6-c9ec21abdd0a"><span class="item-actions"><button data-action="toggle-task" title="Mark Complete">✓</button></span><span class="item-title" style="">New Quote</span><span><a href="#fd8fdb32-361e-44de-9691-4d04349c86b1" class="task-contact-link">Ela Suyunova</a></span><span class="item-date" data-action="edit-task-date">6/17/25</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li><li data-task-id="7b539264-d712-4b53-b80f-a406e2b5f562"><span class="item-actions"><button data-action="toggle-task" title="Mark Incomplete">⟲</button></span><span class="item-title" style="text-decoration:line-through;opacity:0.6;">Make a call</span><span><a href="#fd8fdb32-361e-44de-9691-4d04349c86b1" class="task-contact-link">Ela Suyunova</a></span><span class="item-date" data-action="edit-task-date">No date</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li><li data-task-id="49660fbd-f1d5-4d04-a6e3-4ed10811ef50"><span class="item-actions"><button data-action="toggle-task" title="Mark Incomplete">⟲</button></span><span class="item-title" style="text-decoration:line-through;opacity:0.6;">Also Call Him</span><span><a href="#e111fe74-35e4-4f0b-81ed-674ae9881253" class="task-contact-link">Paul Courtright</a></span><span class="item-date" data-action="edit-task-date">No date</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li></ul></div></main></div>
    </div>
    <!-- Main Modals -->
    <div id="contactDetailModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Paul Courtright</h2><div class="actions-area"><button id="add-task-btn-modal" class="btn btn-secondary">+ Task</button><button id="log-activity-btn-modal" class="btn btn-secondary">+ Activity</button><button id="add-field-btn-modal" class="btn btn-secondary">+ Field</button></div><button class="modal-close-btn">×</button></div><div class="modal-body"><div class="main-column"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container"><div class="detail-field-group" data-field-name="Primary Borrower" title="Primary Borrower"><div class="detail-field-label">Primary Borrower</div><div class="detail-field-value"><span class="value-text">Paul Courtright</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="Paul Courtright">📋</button></div></div></div><div class="detail-field-group" data-field-name="ARIVE Loan Id" title="ARIVE Loan Id"><div class="detail-field-label">ARIVE Loan Id</div><div class="detail-field-value"><span class="value-text">14169393</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="14169393">📋</button></div></div></div><div class="detail-field-group" data-field-name="Loan Funded" title="Loan Funded"><div class="detail-field-label">Loan Funded</div><div class="detail-field-value"><span class="value-text">5/2/25</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="2025-05-02">📋</button></div></div></div><div class="detail-field-group" data-field-name="Total Loan Amount" title="Total Loan Amount"><div class="detail-field-label">Total Loan Amount</div><div class="detail-field-value"><span class="value-text">$38,911.00</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="38911">📋</button></div></div></div><div class="detail-field-group" data-field-name="tags" title="tags"><div class="detail-field-label">tags</div><div class="detail-field-value"><span class="value-text">arive</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="arive">📋</button></div></div></div></div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container"></div></div><div class="danger-zone-section"><h3 style="color:var(--danger-color)">Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="sidebar-column"><div class="detail-section"><h3>Tasks</h3><div id="contact-tasks-container"><ul class="item-list"><li data-task-id="49660fbd-f1d5-4d04-a6e3-4ed10811ef50"><span class="item-actions"><button data-action="toggle-task" title="Mark Incomplete">⟲</button></span><span class="item-title" style="text-decoration:line-through;opacity:0.6;">Also Call Him</span><span class="item-date" data-action="edit-task-date">No date</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li></ul></div></div><div class="detail-section"><h3>Activity Log</h3><div id="contact-activities-container"><ul class="item-list"></ul></div></div></div></div><div class="modal-footer"><button id="modal-save-changes-btn" class="btn btn-primary">Grant Permission &amp; Save</button></div></div></div>
    <div id="settingsModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Settings</h2><button class="modal-close-btn">×</button></div><div class="modal-body"><h3>Manage Fields</h3><p>Use arrows to reorder fields. The top-most visible field is the contact's title.</p><ul id="fields-list"><li data-field-name="Primary Borrower"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up" disabled="">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">Primary Borrower</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="ARIVE Loan Id"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">ARIVE Loan Id</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="Loan Funded"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">Loan Funded</span><select class="field-type-select"><option value="text">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date" selected="">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="Total Loan Amount"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">Total Loan Amount</span><select class="field-type-select"><option value="text">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency" selected="">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="tags"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down" disabled="">▼</button></div><span class="field-name">tags</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li></ul><h3 style="margin-top:2rem;">Data Management</h3><div class="form-group ghost-mode-group"><input type="checkbox" id="ghostModeCheckbox" style="width:auto;"><label for="ghostModeCheckbox">Ghost Mode (disables temporary session recovery)</label></div><div id="delete-all-container"><h3>Danger Zone</h3><button id="delete-all-btn" class="btn btn-danger">DELETE ALL DATA</button><p style="font-size:0.9rem;color:var(--text-tertiary);">This permanently deletes all contacts, relationships, and custom fields from this file.</p></div></div><div class="modal-footer"><button id="save-settings-btn" class="btn btn-primary">Save Settings</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="confirm-title">FINAL CONFIRMATION</h2></div><div class="modal-body"><p id="confirm-message">This is your last chance. Clicking OK will permanently erase everything.</p></div><div class="modal-footer"><button id="confirm-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-ok-btn" class="btn btn-danger">OK</button></div></div></div>
    
    <!-- Secondary Modals -->
    <div id="addTaskModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Add New Task</h2><button class="modal-close-btn">×</button></div><form id="add-task-form"><div class="modal-body"><div class="form-group"><label for="new-task-title">Task Title</label><input type="text" id="new-task-title" required=""></div><div class="form-group"><label for="new-task-due-date">Due Date (Optional)</label><input type="date" id="new-task-due-date"></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Add Task</button></div></form></div></div>
    <div id="logActivityModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Log Activity</h2><button class="modal-close-btn">×</button></div><form id="log-activity-form"><div class="modal-body"><div class="form-group"><label for="new-activity-type">Activity Type</label><select id="new-activity-type"></select></div><div class="form-group"><label for="new-activity-desc">Description</label><input type="text" id="new-activity-desc" required=""></div><div class="form-group"><label for="new-activity-date">Date</label><input type="date" id="new-activity-date" required=""></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Log Activity</button></div></form></div></div>
    <div id="addFieldModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Add New Field / Relationship</h2><button class="modal-close-btn">×</button></div><form id="add-field-form"><div class="modal-body"><div class="form-group"><label for="new-field-name">Field Name / Relationship Label</label><input type="text" id="new-field-name" placeholder="e.g., Birthday or Spouse" required=""></div><div class="form-group"><label for="new-field-type">Type</label><select id="new-field-type"></select></div><div id="relationship-creator-ui" class="hidden" style="margin-top:1rem;"><div class="form-group"><label for="relationship-search">Find Contact to Link</label><input type="text" id="relationship-search" placeholder="Start typing a name..."><div id="relationship-search-results" class="relationship-search-results"></div></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Add</button></div></form></div></div>

    <div id="save-reminder" class=""><span id="save-reminder-text">To enable one-click saving, grant permission to edit this file.</span><button id="save-now-btn" class="btn btn-primary">Grant Permission &amp; Save</button></div>
    
    <script id="sparrow-data" type="application/json">{
  "contacts": [],
  "tasks": [],
  "activities": [],
  "links": [],
  "relationships": [],
  "settings": {
    "fields": [],
    "customActivityTypes": [
      "Phone Call",
      "SMS",
      "Email",
      "Meeting"
    ],
    "ghostMode": false
  }
}</script>
    <script>
    // Full, clean, non-minified script
    (function() {
        "use strict";
        const LOG_PREFIX = '[SparrowCRM]', CONTACTS_PER_PAGE = 50, FIELD_TYPES = ['text', 'longtext', 'number', 'date', 'phone', 'email', 'url', 'boolean', 'currency'], RELATIONSHIP_FIELD_TYPE = 'relationship';
        let AppState, DOM;

        const Utils = {
            generateUUID: () => crypto.randomUUID(),
            showModal: (modal) => modal.classList.add("visible"),
            hideModal: (modal) => {
                modal.classList.remove("visible");
                if (modal.id === 'contactDetailModal') {
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            },
            debounce: (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; },
            showConfirm: (title, message, okClass = 'btn-primary') => {
                return new Promise((resolve) => {
                    DOM.confirmModal.title.textContent = title; DOM.confirmModal.message.textContent = message;
                    DOM.confirmModal.okBtn.className = `btn ${okClass}`; Utils.showModal(DOM.confirmModal.el);
                    const okHandler = () => { cleanup(); resolve(true); }; const cancelHandler = () => { cleanup(); resolve(false); };
                    DOM.confirmModal.okBtn.addEventListener('click', okHandler); DOM.confirmModal.cancelBtn.addEventListener('click', cancelHandler);
                    function cleanup() { Utils.hideModal(DOM.confirmModal.el); DOM.confirmModal.okBtn.removeEventListener('click', okHandler); DOM.confirmModal.cancelBtn.removeEventListener('click', cancelHandler); }
                });
            },
            formatFieldValue: (value, type) => {
                if (value === null || value === undefined || value === '') return '';
                switch (type) {
                    case 'currency': { const num = parseFloat(String(value).replace(/[^0-9.-]+/g,"")); return isNaN(num) ? value : new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(num); }
                    case 'date': { if(!value) return ''; const d = new Date(value); if (d instanceof Date && !isNaN(d.getTime())) { const utcDate = new Date(d.valueOf() + d.getTimezoneOffset() * 60000); return utcDate.toLocaleDateString('en-US',{year:'2-digit',month:'numeric',day:'numeric'}); } return value; }
                    default: return value;
                }
            },
            getContactDisplayName: (contact) => {
                if (!contact) return "Unknown Contact";
                const sortedVisibleFields = AppState.settings.fields.filter(f => f.visible).sort((a, b) => a.order - b.order);
                if (sortedVisibleFields.length > 0) { const primaryFieldName = sortedVisibleFields[0].name; const primaryValue = contact.fields[primaryFieldName]; if (primaryValue) return primaryValue; }
                const firstName = contact.fields['First Name'] || contact.fields.firstName || ''; const lastName = contact.fields['Last Name'] || contact.fields.lastName || '';
                const fullName = `${firstName} ${lastName}`.trim(); if (fullName) return fullName;
                const email = contact.fields['Email'] || contact.fields.email || ''; if (email) return email;
                return `Contact ${contact.sparrow_contact_id.substring(0, 8)}`;
            }
        };
        
        const Core = {
            setUnsavedChanges: (status) => {
                if (AppState.ui.unsavedChanges === status) return;
                AppState.ui.unsavedChanges = status;
                DOM.saveReminder.classList.toggle('visible', status);
                const contactModalSaveBtn = document.getElementById('modal-save-changes-btn');
                if(contactModalSaveBtn) {
                    contactModalSaveBtn.disabled = !status;
                    contactModalSaveBtn.textContent = AppState.ui.fileHandle ? "Save Changes" : "Grant Permission & Save";
                }
                if(status) {
                    if(AppState.ui.isFsaSupported) {
                        if (AppState.ui.fileHandle) { DOM.saveReminderText.textContent = "You have unsaved changes."; DOM.saveNowBtn.textContent = "Save Now"; }
                        else { DOM.saveReminderText.textContent = "To enable one-click saving, grant permission to edit this file."; DOM.saveNowBtn.textContent = "Grant Permission & Save"; }
                    } else { DOM.saveReminderText.textContent = "You have unsaved changes. Download a new copy to save."; DOM.saveNowBtn.textContent = "Download & Save"; }
                }
            },
            parseCSV: (text) => {
                const result = [], lines = text.trim().split(/\r\n|\n/), headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ""));
                for(let i = 1; i < lines.length; i++){
                    const line = lines[i]; if(!line.trim()) continue;
                    const values = []; let currentVal = "", inQuotes = false;
                    for(let char of line){if(char === '"') inQuotes = !inQuotes; else if (char === "," && !inQuotes) { values.push(currentVal.trim()); currentVal = ""; } else { currentVal += char; } }
                    values.push(currentVal.trim());
                    if(values.every(v => v === "")) { console.log(`${LOG_PREFIX} Skipping empty row at line ${i+1}.`); continue; }
                    if(values.length === headers.length) { const obj={}; for(let j=0; j<headers.length; j++) obj[headers[j]] = values[j].replace(/^"|"$/g, "").replace(/""/g, '"'); result.push(obj); }
                    else { console.warn(`${LOG_PREFIX} Mismatched row length at line ${i+1}. Skipping.`); }
                }
                console.log(`${LOG_PREFIX} Parsed ${result.length} rows.`); return result;
            },
            processCSVData: async (data) => {
                const importTag = prompt("Enter a tag for this import (e.g., 'Leads'). Leave blank for none.", ""), newHeaders = Object.keys(data[0]);
                newHeaders.forEach(h => { if(!AppState.settings.fields.find(f => f.name === h)) AppState.settings.fields.push({name:h, type:"text", visible:true, order:AppState.settings.fields.length}); });
                AppState.contacts.forEach(c => { newHeaders.forEach(h => { if(!c.fields.hasOwnProperty(h)) Object.assign(c.fields, {[h]: ""}); }); });
                for(const row of data) {
                    let existingContact = null;
                    if (row.sparrow_contact_id) existingContact = AppState.contacts.find(c => c.sparrow_contact_id === row.sparrow_contact_id);
                    if (!existingContact && row.Email) { const m=AppState.contacts.filter(c=>c.fields.Email && c.fields.Email.toLowerCase()===row.Email.toLowerCase()); if(m.length===1) existingContact=m[0]; }
                    if (existingContact) {
                        if (await Utils.showConfirm("Update Contact?", `Found existing contact for '${Utils.getContactDisplayName(existingContact)}'. Update with new data?`)) {
                            Object.entries(row).forEach(([k,v]) => { if(v !== null && v !== "") existingContact.fields[k]=v; });
                            if (importTag && !existingContact.tags.includes(importTag)) existingContact.tags.push(importTag);
                        }
                    } else {
                        const newContact={sparrow_contact_id:Utils.generateUUID(), tags:importTag?[importTag]:[], fields:{}};
                        AppState.settings.fields.forEach(f => {newContact.fields[f.name] = row[f.name] || ""});
                        AppState.contacts.push(newContact);
                    }
                }
                Core.setUnsavedChanges(true); UI.renderApp();
            },
            saveData: async () => {
                DOM.saveReminder.classList.remove('visible'); const savingNotifId = UI.showNotification('Saving...', 'info', 0);
                try {
                    if (AppState.ui.isFsaSupported) {
                        if (!AppState.ui.fileHandle) { AppState.ui.fileHandle = await window.showSaveFilePicker({ types: [{ description: 'Sparrow CRM File', accept: {'text/html': ['.html']} }] }); }
                        const writable = await AppState.ui.fileHandle.createWritable(); await writable.write(Core.generateHtmlToSave()); await writable.close();
                        Core.setUnsavedChanges(false); UI.showNotification('File saved successfully.', 'success');
                    } else {
                        const blob = new Blob([Core.generateHtmlToSave()],{type:'text/html'}), a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sparrow-crm-data.html'; a.click(); a.remove(); URL.revokeObjectURL(a.href);
                        Core.setUnsavedChanges(false); UI.showNotification('File downloaded successfully.', 'success');
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') { console.error(`${LOG_PREFIX} Error saving file:`, err); UI.showNotification(`Error saving file: ${err.message}`, 'danger'); }
                    else { UI.showNotification('Save cancelled.', 'info'); }
                } finally { UI.hideNotification(savingNotifId); }
            },
            generateHtmlToSave: () => {
                const docClone = document.cloneNode(true);
                const notificationContainerClone = docClone.getElementById('notification-container');
                if (notificationContainerClone) { notificationContainerClone.innerHTML = ''; }
                const dataToSave = { ...AppState }; delete dataToSave.ui;
                const jsonString = JSON.stringify(dataToSave, null, 2);
                const scriptTagClone = docClone.getElementById('sparrow-data');
                scriptTagClone.textContent = jsonString;
                return `<!DOCTYPE html>\n` + docClone.documentElement.outerHTML;
            },
            generateCSVString: (dataType) => {
                const data = AppState[dataType]; if(!data || data.length === 0) return "";
                let headers, rows;
                if(dataType === 'contacts') {
                    headers = AppState.settings.fields.map(f => f.name);
                    if(!headers.includes('sparrow_contact_id')) headers.unshift('sparrow_contact_id');
                    if(!headers.includes('tags')) headers.push('tags');
                    rows = data.map(contact => headers.map(header => {
                        if (header === 'sparrow_contact_id') return contact.sparrow_contact_id;
                        if (header === 'tags') return contact.tags.join(';');
                        return contact.fields[header] || '';
                    }));
                } else {
                    headers = Object.keys(data[0]); rows = data.map(item => headers.map(header => item[header] || ''));
                }
                const csvRows = [headers.join(',')];
                rows.forEach(row => {
                    const values = row.map(value => {
                        const stringValue = String(value);
                        return stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') ? `"${stringValue.replace(/"/g,'""')}"` : stringValue;
                    });
                    csvRows.push(values.join(','))
                });
                return csvRows.join('\n');
            },
            exportData: (dataType) => {
                const csvString = Core.generateCSVString(dataType);
                if(!csvString){ UI.showNotification(`No ${dataType} to export.`,"info"); return }
                const blob = new Blob([csvString],{type:"text/csv;charset=utf-8;"}), a = document.createElement("a");
                a.href = URL.createObjectURL(blob); a.download = `sparrow-crm-${dataType}-${new Date().toISOString().split("T")[0]}.csv`;
                a.click(); a.remove(); URL.revokeObjectURL(a.href);
            },
            updateContactField: (contactId, fieldName, newValue, originalValue) => { if (newValue === originalValue) { return; } const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); if (contact) { contact.fields[fieldName] = newValue; Core.setUnsavedChanges(true); } },
            addTask: (contactId, taskData) => { const newTask = {sparrow_task_id: Utils.generateUUID(), sparrow_contact_id: contactId, title: taskData.title, dueDate: taskData.dueDate, status: 'To-Do'}; AppState.tasks.push(newTask); Core.setUnsavedChanges(true); if(contactId) { UI.renderContactModal(contactId); } else { UI.renderTaskView(); } },
            updateTask: (taskId, newValues) => { const task = AppState.tasks.find(t => t.sparrow_task_id === taskId); if(task) { Object.assign(task, newValues); Core.setUnsavedChanges(true); const contactId = task.sparrow_contact_id; if(contactId) { UI.renderContactModal(contactId); } else { UI.renderTaskView(); } } },
            deleteTask: async(taskId) => { const task = AppState.tasks.find(t => t.sparrow_task_id === taskId); if (!task) return; if (await Utils.showConfirm("Delete Task?", `Are you sure you want to delete the task: "${task.title}"?`, 'btn-danger')) { const contactId = task.sparrow_contact_id; AppState.tasks = AppState.tasks.filter(t => t.sparrow_task_id !== taskId); Core.setUnsavedChanges(true); if(contactId) { UI.renderContactModal(contactId); } else { UI.renderTaskView(); } } },
            logActivity: (contactId, activityData) => { const newActivity = {sparrow_activity_id: Utils.generateUUID(), sparrow_contact_id: contactId, type: activityData.type, date: activityData.date, description: activityData.description}; AppState.activities.unshift(newActivity); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); },
            deleteActivity: async(activityId) => { const activity = AppState.activities.find(a => a.sparrow_activity_id === activityId); if (!activity) return; if (await Utils.showConfirm("Delete Activity Log?", `Are you sure you want to delete this ${activity.type} log from ${new Date(activity.date).toLocaleDateString()}?`, 'btn-danger')) { const contactId = activity.sparrow_contact_id; AppState.activities = AppState.activities.filter(a => a.sparrow_activity_id !== activityId); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); } },
            addCustomField: (contactId, newFieldName, newFieldType) => { if (!newFieldName || AppState.settings.fields.find(f => f.name.toLowerCase() === newFieldName.toLowerCase())) { UI.showNotification(`Field "${newFieldName}" already exists or name is empty.`, "danger"); return; } AppState.settings.fields.push({ name: newFieldName, type: newFieldType, visible: true, order: AppState.settings.fields.length }); AppState.contacts.forEach(c => { c.fields[newFieldName] = ''; }); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); },
            addRelationship: (sourceId, targetId, label) => { if (!targetId || !label) { UI.showNotification("Please select a contact and provide a relationship label.", "danger"); return; } const newRelationship = { sparrow_relationship_id: Utils.generateUUID(), source_contact_id: sourceId, target_contact_id: targetId, label: label }; AppState.relationships.push(newRelationship); Core.setUnsavedChanges(true); UI.renderContactModal(sourceId); },
            deleteContact: async (contactId) => { const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); if (await Utils.showConfirm("Delete Contact?", `Are you sure you want to permanently delete ${Utils.getContactDisplayName(contact)}? This action cannot be undone.`, 'btn-danger')) { AppState.contacts = AppState.contacts.filter(c => c.sparrow_contact_id !== contactId); AppState.relationships = AppState.relationships.filter(r => r.source_contact_id !== contactId && r.target_contact_id !== contactId); Core.setUnsavedChanges(true); Utils.hideModal(DOM.contactDetailModal); UI.renderApp(); } },
            deleteField: async(fieldName) => { if (await Utils.showConfirm("Delete Field?", `Are you sure you want to permanently delete the field "${fieldName}"? This will remove the field and all its data from every contact.`, 'btn-danger')) { AppState.settings.fields = AppState.settings.fields.filter(f => f.name !== fieldName).map((f, i) => ({...f, order: i})); AppState.contacts.forEach(contact => { delete contact.fields[fieldName]; }); Core.setUnsavedChanges(true); UI.renderSettingsModal(); UI.showNotification(`Field "${fieldName}" deleted.`, "success"); } },
            deleteAllData: async() => { if (!(await Utils.showConfirm("DELETE ALL DATA?","This action will erase all contacts, relationships, and custom fields from this file.","btn-danger"))) return; if (await Utils.showConfirm("FINAL CONFIRMATION", "This is your last chance. Clicking OK will permanently erase everything.", "btn-danger")) { AppState.contacts = []; AppState.tasks = []; AppState.activities = []; AppState.links = []; AppState.relationships = []; AppState.settings.fields = []; UI.resetToWelcomeScreen(); if (AppState.ui.fileHandle) { await Core.saveData(); UI.showNotification("All data deleted and file updated.", "success"); } else { Core.setUnsavedChanges(true); UI.showNotification("All data has been deleted. Save the file to make it permanent.", "success"); } } else { UI.showNotification("Delete cancelled.", "info"); } }
        };
        const UI={showNotification:(t,e="info",o=3e3)=>{const n="notif-"+Utils.generateUUID(),s=document.createElement("div");return s.id=n,s.className=`notification ${e}`,s.textContent=t,DOM.notificationContainer.appendChild(s),setTimeout(()=>s.classList.add("visible"),10),o>0&&setTimeout(()=>UI.hideNotification(n),o),n},hideNotification:t=>{const e=document.getElementById(t);e&&(e.classList.remove("visible"),e.addEventListener("transitionend",()=>e.remove()))},resetToWelcomeScreen:()=>{Utils.hideModal(DOM.settingsModal),DOM.appScreen.classList.remove("hidden"),DOM.taskScreen.classList.add("hidden"),DOM.welcomeScreen.classList.remove("hidden")},renderApp:()=>{DOM.welcomeScreen.classList.add("hidden"),DOM.taskScreen.classList.add("hidden"),DOM.appScreen.classList.remove("hidden"),UI.renderContactGrid()},renderContactGrid:(t=!1)=>{const e=DOM.mainSearchInput.value.toLowerCase();e===AppState.ui.currentFilter&&t||(AppState.ui.currentFilter=e,AppState.ui.renderedContactsCount=0,DOM.contactGrid.innerHTML="");const o=AppState.contacts.filter(t=>Object.values(t.fields).some(t=>String(t).toLowerCase().includes(e))||t.tags.some(t=>t.toLowerCase().includes(e))),n=AppState.settings.fields.filter(t=>t.visible).sort((t,e)=>t.order-e.order).slice(1,5),s=o.slice(AppState.ui.renderedContactsCount,AppState.ui.renderedContactsCount+CONTACTS_PER_PAGE),c=document.createDocumentFragment();s.forEach(t=>{const e=document.createElement("div");e.className="contact-card",e.dataset.contactId=t.sparrow_contact_id;const o=`<div class="contact-card-tags">${t.tags.map(t=>`<span class="tag-badge">${t}</span>`).join("")}</div>`;let s=`${o}<h3>${Utils.getContactDisplayName(t)}</h3><div class="contact-card-fields">`;n.forEach(e=>{const o=t.fields[e.name];o&&(s+=`<div class="contact-card-field"><strong>${e.name}:</strong> ${Utils.formatFieldValue(o,e.type)}</div>`)}),e.innerHTML=s+"</div>",c.appendChild(e)}),DOM.contactGrid.appendChild(c),AppState.ui.renderedContactsCount+=s.length,DOM.loadMoreContainer.classList.toggle("hidden",AppState.ui.renderedContactsCount>=o.length)},renderContactModal:t=>{const e=AppState.contacts.find(e=>e.sparrow_contact_id===t);if(!e)return;const o=AppState.settings.fields.sort((t,e)=>t.order-e.order),n=o.map(t=>{if(!t.visible)return"";const o=e.fields[t.name]||"",n=Utils.formatFieldValue(o,t.type);let s=`<button title="Copy" data-action="copy" data-value="${o}">📋</button>`;return"email"===t.type?s+=`<a href="mailto:${o}" title="Email"><button>📧</button></a>`:"phone"===t.type&&(s+=`<a href="tel:${o}" title="Call"><button>📞</button></a>`),`<div class="detail-field-group" data-field-name="${t.name}" title="${t.name}"><div class="detail-field-label">${t.name}</div><div class="detail-field-value"><span class="value-text">${n}</span><div class="contextual-actions">${s}</div></div></div>`}).join(""),s=AppState.relationships.filter(e=>e.source_contact_id===t).map(t=>{const o=AppState.contacts.find(e=>e.sparrow_contact_id===t.target_contact_id);return`<div class="detail-field-group"><div class="detail-field-label" title="${t.label}">${t.label}</div><div class="detail-field-value" style="pointer-events:all;cursor:default"><a href="#${t.target_contact_id}" class="relationship-link">${Utils.getContactDisplayName(o)}</a></div></div>`}).join(""),c=AppState.tasks.filter(e=>e.sparrow_contact_id===t).sort((t,e)=>new Date(t.dueDate)-new Date(e.dueDate)),i=`<ul class="item-list">${c.map(t=>{const e="Completed"===t.status,o=e?"⟲":"✓";return`<li data-task-id="${t.sparrow_task_id}"><span class="item-actions"><button data-action="toggle-task" title="Mark ${e?"Incomplete":"Complete"}">${o}</button></span><span class="item-title" style="${e?"text-decoration:line-through;opacity:0.6;":""}">${t.title}</span><span class="item-date" data-action="edit-task-date">${t.dueDate?Utils.formatFieldValue(t.dueDate,'date'):"No date"}</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li>`}).join("")}</ul>`,l=AppState.activities.filter(e=>e.sparrow_contact_id===t),a=`<ul class="item-list">${l.map(t=>`<li data-activity-id="${t.sparrow_activity_id}"><span class="item-title"><strong>${t.type}:</strong> ${t.description}</span><span class="item-date">${Utils.formatFieldValue(t.date, 'date')}</span><span class="item-actions"><button data-action="delete-activity" title="Delete Activity">🗑️</button></span></li>`).join("")}</ul>`,d=AppState.ui.fileHandle?"Save Changes":"Grant Permission & Save",r=`<div class="modal-header"><h2>${Utils.getContactDisplayName(e)}</h2><div class="actions-area"><button id="add-task-btn-modal" class="btn btn-secondary">+ Task</button><button id="log-activity-btn-modal" class="btn btn-secondary">+ Activity</button><button id="add-field-btn-modal" class="btn btn-secondary">+ Field</button></div><button class="modal-close-btn">&times;</button></div><div class="modal-body"><div class="main-column"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container">${n}</div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container">${s}</div></div><div class="danger-zone-section"><h3 style="color:var(--danger-color)">Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="sidebar-column"><div class="detail-section"><h3>Tasks</h3><div id="contact-tasks-container">${i}</div></div><div class="detail-section"><h3>Activity Log</h3><div id="contact-activities-container">${a}</div></div></div></div><div class="modal-footer"><button id="modal-save-changes-btn" class="btn btn-primary" disabled>${d}</button></div>`;DOM.contactDetailModal.querySelector(".modal-content").innerHTML=r,Events.setupContactModalEventListeners(t),Utils.showModal(DOM.contactDetailModal)},renderSettingsModal:()=>{const t=DOM.settingsModal.querySelector(".modal-content"),e=AppState.settings.fields.sort((t,e)=>t.order-e.order),o=e.map((t,o)=>`<li data-field-name="${t.name}"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up" ${0===o?"disabled":""}>▲</button><button class="field-order-btn" data-action="down" title="Move Down" ${o===e.length-1?"disabled":""}>▼</button></div><span class="field-name">${t.name}</span><select class="field-type-select">${FIELD_TYPES.map(e=>`<option value="${e}" ${t.type===e?"selected":""}>${e}</option>`).join("")}</select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" ${t.visible?"checked":""}> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li>`).join("");t.querySelector("#fields-list").innerHTML=o,t.querySelector("#ghostModeCheckbox").checked=AppState.settings.ghostMode,Utils.showModal(DOM.settingsModal)},showAddTaskModal:()=>{DOM.addTaskModal.querySelector('form').reset();Utils.showModal(DOM.addTaskModal)},showLogActivityModal:()=>{DOM.logActivityModal.querySelector('form').reset();DOM.logActivityModal.querySelector("#new-activity-type").innerHTML=AppState.settings.customActivityTypes.map(t=>`<option value="${t}">${t}</option>`).join(""),DOM.logActivityModal.querySelector("#new-activity-date").value=(new Date).toISOString().split("T")[0],Utils.showModal(DOM.logActivityModal)},showAddFieldModal:()=>{DOM.addFieldModal.querySelector('form').reset();const t=[...FIELD_TYPES,"relationship"].map(t=>`<option value="${t}">${t}</option>`).join("");DOM.addFieldModal.querySelector("#new-field-type").innerHTML=t,Utils.showModal(DOM.addFieldModal)},renderTaskView:()=>{DOM.appScreen.classList.add('hidden');DOM.taskScreen.classList.remove('hidden');const globalTaskForm=`<div class="detail-section"><h3>Add Global Task</h3><form class="add-item-form" data-form-type="global-task"><div class="form-group"><label for="global-task-title">New Task</label><input type="text" id="global-task-title" required></div><div class="form-group"><label for="global-task-due-date">Due Date</label><input type="date" id="global-task-due-date"></div><button type="submit" class="btn btn-secondary">Add Global Task</button></form></div>`;const today=new Date();today.setHours(0,0,0,0);const sortedTasks=AppState.tasks.sort((a,b)=>{const aDate=a.dueDate?new Date(a.dueDate):null;const bDate=b.dueDate?new Date(b.dueDate):null;if(a.status!==b.status)return a.status==='Completed'?1:-1;if(!aDate&&!bDate)return 0;if(!aDate)return 1;if(!bDate)return-1;const aOverdue=aDate<today,bOverdue=bDate<today;if(aOverdue!==bOverdue)return aOverdue?-1:1;return aDate-bDate});const tasksHTML=`<ul class="item-list">${sortedTasks.map(t=>{const e="Completed"===t.status,o=e?"⟲":"✓",n=t.sparrow_contact_id?AppState.contacts.find(c=>c.sparrow_contact_id===t.sparrow_contact_id):null;const contactLink=n?`<a href="#${n.sparrow_contact_id}" class="task-contact-link">${Utils.getContactDisplayName(n)}</a>`:'<em>Global</em>';return`<li data-task-id="${t.sparrow_task_id}"><span class="item-actions"><button data-action="toggle-task" title="Mark ${e?"Incomplete":"Complete"}">${o}</button></span><span class="item-title" style="${e?"text-decoration:line-through;opacity:0.6;":""}">${t.title}</span><span>${contactLink}</span><span class="item-date" data-action="edit-task-date">${t.dueDate?Utils.formatFieldValue(t.dueDate,'date'):"No date"}</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li>`}).join("")}</ul>`;DOM.taskScreen.querySelector('#global-task-container').innerHTML=globalTaskForm;DOM.taskScreen.querySelector('#all-tasks-list').innerHTML=tasksHTML}};
    const Events={init:()=>{Events.populateDomObject();const t=()=>DOM.csvFileInput.click();DOM.importCsvWelcomeBtn.addEventListener("click",t),DOM.importCsvHeaderBtn.addEventListener("click",t),DOM.csvFileInput.addEventListener("change",Events.handleFileSelect),DOM.fileDropZone.addEventListener("dragover",Events.handleDragOver),DOM.fileDropZone.addEventListener("dragleave",Events.handleDragLeave),DOM.fileDropZone.addEventListener("drop",Events.handleDrop),DOM.mainSearchInput.addEventListener("input",Utils.debounce(()=>{const t=DOM.mainSearchInput.value,e=new URL(window.location);t?e.searchParams.set("q",t):e.searchParams.delete("q"),history.replaceState(null,"",e.toString()),UI.renderContactGrid()},300)),document.querySelector(".actions-area .dropdown").addEventListener("click",t=>{const e=t.target.dataset.exportType;e&&Core.exportData(e)}),DOM.settingsBtn.addEventListener("click",UI.renderSettingsModal),DOM.tasksBtn.addEventListener("click",UI.renderTaskView),DOM.backToContactsBtn.addEventListener("click",UI.renderApp),DOM.saveNowBtn.addEventListener("click",Core.saveData),DOM.loadMoreBtn.addEventListener("click",()=>UI.renderContactGrid(!0)),document.body.addEventListener("click",t=>{t.target.classList.contains("modal-close-btn")&&Utils.hideModal(t.target.closest(".modal"))}),DOM.settingsModal.addEventListener("click",Events.handleSettingsModalClick),DOM.contactGrid.addEventListener("click",t=>{const e=t.target.closest(".contact-card");e&&(window.location.hash=e.dataset.contactId)}),DOM.taskScreen.addEventListener("submit",Events.handleTaskScreenSubmit),DOM.taskScreen.addEventListener("click",Events.handleTaskScreenClick),window.addEventListener("hashchange",()=>{const t=window.location.hash.substring(1),e=DOM.contactDetailModal.classList.contains("visible"),o=AppState.contacts.find(e=>e.sparrow_contact_id===t);t&&o?e||UI.renderContactModal(t):!t&&e&&Utils.hideModal(DOM.contactDetailModal)}),window.addEventListener("beforeunload",t=>{if(AppState.ui.unsavedChanges)return t.preventDefault(),t.returnValue=""})},populateDomObject:()=>{DOM={welcomeScreen:document.getElementById("welcomeScreen"),appScreen:document.getElementById("appScreen"),taskScreen:document.getElementById("taskScreen"),importCsvWelcomeBtn:document.getElementById("import-csv-btn-welcome"),importCsvHeaderBtn:document.getElementById("import-csv-btn-header"),csvFileInput:document.getElementById("csv-file-input"),fileDropZone:document.getElementById("file-drop-zone"),contactGrid:document.getElementById("contactGrid"),mainSearchInput:document.getElementById("main-search-input"),contactDetailModal:document.getElementById("contactDetailModal"),settingsModal:document.getElementById("settingsModal"),settingsBtn:document.getElementById("settings-btn"),tasksBtn:document.getElementById('tasks-btn'),backToContactsBtn:document.getElementById('back-to-contacts-btn'),saveReminder:document.getElementById("save-reminder"),saveReminderText:document.getElementById("save-reminder-text"),saveNowBtn:document.getElementById("save-now-btn"),loadMoreContainer:document.getElementById("loadMoreContainer"),loadMoreBtn:document.getElementById("loadMoreBtn"),ghostModeCheckbox:document.getElementById("ghostModeCheckbox"),notificationContainer:document.getElementById("notification-container"),confirmModal:{el:document.getElementById("confirmModal"),title:document.getElementById("confirm-title"),message:document.getElementById("confirm-message"),okBtn:document.getElementById("confirm-ok-btn"),cancelBtn:document.getElementById("confirm-cancel-btn")},addTaskModal:document.getElementById("addTaskModal"),logActivityModal:document.getElementById("logActivityModal"),addFieldModal:document.getElementById("addFieldModal")}},handleFileSelect:t=>{const e=t.target.files[0];e&&Events.readFile(e),t.target.value=""},handleDragOver:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.add("dragover")},handleDragLeave:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.remove("dragover")},handleDrop:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.remove("dragover");const e=t.dataTransfer.files[0];e&&("text/csv"===e.type||e.name.endsWith(".csv"))?Events.readFile(e):UI.showNotification("Please drop a valid .csv file.","danger")},readFile:t=>{const e=new FileReader;e.onload=e=>{try{const o=Core.parseCSV(e.target.result);o.length>0?Core.processCSVData(o):UI.showNotification("CSV file is empty or could not be parsed.","danger")}catch(e){console.error(`${LOG_PREFIX} Error processing file:`,e),UI.showNotification(`Error processing file: ${e.message}`,"danger")}},e.readAsText(t)},handleSettingsModalClick:t=>{const e=t.target.closest("button");if(!e)return;if("save-settings-btn"===e.id){const t=[];return DOM.settingsModal.querySelectorAll("#fields-list li").forEach((e,o)=>{const n=e.dataset.fieldName,s=AppState.settings.fields.find(t=>t.name===n);s&&t.push({...s,type:e.querySelector(".field-type-select").value,visible:e.querySelector(".field-visibility-toggle").checked,order:o})}),AppState.settings.fields=t,AppState.settings.ghostMode=DOM.settingsModal.querySelector("#ghostModeCheckbox").checked,AppState.settings.ghostMode&&(localStorage.removeItem("sparrow-crm-state"),UI.showNotification("Ghost Mode On: Session restore is disabled.","info")),Core.setUnsavedChanges(!0),Utils.hideModal(DOM.settingsModal),UI.renderContactGrid(),void UI.showNotification("Settings updated. Save the file to make them permanent.","success")}if("delete-all-btn"===e.id)return void Core.deleteAllData();{const o=e.dataset.action,n=e.closest("li")?.dataset.fieldName;if(!o||!n)return;let s=AppState.settings.fields;const c=s.findIndex(t=>t.name===n);if(-1===c)return;"up"===o&&c>0?([s[c],s[c-1]]=[s[c-1],s[c]]):"down"===o&&c<s.length-1?([s[c],s[c+1]]=[s[c+1],s[c]]):"delete"===o&&(Core.deleteField(n),t.stopImmediatePropagation()),s.forEach((t,e)=>t.order=e),UI.renderSettingsModal()}},setupContactModalEventListeners:t=>{const e=DOM.contactDetailModal.querySelector(".modal-content");e&&(e.addEventListener("click",Events.handleContactModalClick),e.addEventListener("focusout",Events.handleContactModalFocusOut),e.addEventListener("keydown",Events.handleContactModalKeyDown),e.addEventListener("input",Events.handleContactModalInput),document.getElementById("modal-save-changes-btn").addEventListener("click",Core.saveData));DOM.addTaskModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.logActivityModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.addFieldModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit)},handleTaskScreenSubmit:t=>{t.preventDefault();if("global-task"===t.target.dataset.formType){const e=document.getElementById("global-task-title").value,o=document.getElementById("global-task-due-date").value;e&&Core.addTask(null,{title:e,dueDate:o}),t.target.reset()}},handleTaskScreenClick:t=>{const e=t.target.closest("[data-action]");if(!e)return;const o=e.dataset.action,n=e.closest("li[data-task-id]")?.dataset.taskId;n&&("toggle-task"===o?Core.updateTask(n,{status:"Completed"===AppState.tasks.find(t=>t.sparrow_task_id===n).status?"To-Do":"Completed"}):"delete-task"===o&&Core.deleteTask(n))},handleModalFormSubmit:t=>{t.preventDefault();const e=t.target.id,o=window.location.hash.substring(1);if("add-task-form"===e){Core.addTask(o,{title:document.getElementById("new-task-title").value,dueDate:document.getElementById("new-task-due-date").value});Utils.hideModal(DOM.addTaskModal)}else if("log-activity-form"===e){const t=document.getElementById("new-activity-date").value.split("-"),e=new Date(t[0],t[1]-1,t[2]).toISOString();Core.logActivity(o,{type:document.getElementById("new-activity-type").value,description:document.getElementById("new-activity-desc").value,date:e});Utils.hideModal(DOM.logActivityModal)}else if("add-field-form"===e){const t=document.getElementById("new-field-name").value,e=document.getElementById("new-field-type").value;if("relationship"===e){const t=document.getElementById("relationship-search-results").querySelector(".selected")?.dataset.contactId;Core.addRelationship(o,t,document.getElementById("new-field-name").value)}else Core.addCustomField(o,t,e);Utils.hideModal(DOM.addFieldModal)}},handleContactModalClick:t=>{const e=window.location.hash.substring(1);if(t.target.closest("#modal-delete-contact-btn"))return void Core.deleteContact(e);if(t.target.closest("#add-task-btn-modal"))return void UI.showAddTaskModal();if(t.target.closest("#log-activity-btn-modal"))return void UI.showLogActivityModal();if(t.target.closest("#add-field-btn-modal"))return void UI.showAddFieldModal();const o=t.target.closest("[data-action]");if(o){const n=o.dataset.action;if("copy"===n)return void navigator.clipboard.writeText(o.dataset.value).then(()=>UI.showNotification("Copied!","info",1500));if("edit-task-date"===n){const e=o.closest("li").dataset.taskId,s=AppState.tasks.find(t=>t.sparrow_task_id===e).dueDate||"";return o.innerHTML=`<input type="date" class="inline-edit-input" value="${s}" data-task-id="${e}">`,void o.querySelector("input").focus()}const s=o.closest("li[data-task-id]")?.dataset.taskId;if(s)return void("toggle-task"===n?Core.updateTask(s,{status:"Completed"===AppState.tasks.find(t=>t.sparrow_task_id===s).status?"To-Do":"Completed"}):"delete-task"===n&&Core.deleteTask(s));const c=o.closest("li[data-activity-id]")?.dataset.activityId;if(c&&"delete-activity"===n)return void Core.deleteActivity(c)}const n=t.target.closest(".relationship-link");if(n)return t.preventDefault(),void(window.location.hash=n.dataset.contactId);const s=t.target.closest(".detail-field-group");s&&!s.querySelector("input, textarea")&&(s.querySelector(".detail-field-value").innerHTML=`<input type="text" class="inline-edit-input" value="${AppState.contacts.find(t=>t.sparrow_contact_id===e).fields[s.dataset.fieldName]||""}" data-original-value="${AppState.contacts.find(t=>t.sparrow_contact_id===e).fields[s.dataset.fieldName]||""}">`,s.querySelector(".inline-edit-input").focus())},handleContactModalFocusOut:t=>{if(t.target.classList.contains("inline-edit-input")){const e=t.target;if(e.dataset.taskId){const o=e.dataset.taskId,n=e.value;return void Core.updateTask(o,{dueDate:n})}const o=e.parentElement,n=o.closest(".detail-field-group").dataset.fieldName,s=window.location.hash.substring(1);Core.updateContactField(s,n,e.value,e.dataset.originalValue);const c=AppState.settings.fields.find(t=>t.name===n),i=Utils.formatFieldValue(e.value,c.type);let l=`<button title="Copy" data-action="copy" data-value="${e.value}">📋</button>`;"email"===c.type?l+=`<a href="mailto:${e.value}" title="Email"><button>📧</button></a>`:"phone"===c.type&&(l+=`<a href="tel:${e.value}" title="Call"><button>📞</button></a>`),o.innerHTML=`<span class="value-text">${i}</span><div class="contextual-actions">${l}</div>`}},handleContactModalKeyDown:t=>{if(t.target.classList.contains("inline-edit-input"))if("Enter"===t.key)t.target.blur();else if("Escape"===t.key){const e=t.target;e.value=e.dataset.originalValue,t.target.blur()}},handleContactModalInput:t=>{if("new-field-type"===t.target.id)document.getElementById("relationship-creator-ui").classList.toggle("hidden","relationship"!==t.target.value);else if("relationship-search"===t.target.id){const e=t.target.value.toLowerCase(),o=document.getElementById("relationship-search-results");if(o.innerHTML="",e.length<2)return;const n=window.location.hash.substring(1),s=AppState.contacts.filter(t=>t.sparrow_contact_id!==n&&Utils.getContactDisplayName(t).toLowerCase().includes(e));s.slice(0,5).forEach(t=>{const e=document.createElement("div");e.className="relationship-search-result",e.dataset.contactId=t.sparrow_contact_id,e.textContent=Utils.getContactDisplayName(t),o.appendChild(e)})}}};
    function init(){console.log(`${LOG_PREFIX} Initializing application...`),AppState={contacts:[],tasks:[],activities:[],links:[],relationships:[],settings:{fields:[],customActivityTypes:["Phone Call","SMS","Email","Meeting"],ghostMode:!1},ui:{isFsaSupported:!1,fileHandle:null,unsavedChanges:!1,currentFilter:"",renderedContactsCount:0}},DOM={},Events.populateDomObject();let e=null;const o=document.getElementById("sparrow-data");if(o&&o.textContent.trim().length>2)try{e=JSON.parse(o.textContent)}catch(t){console.error(`${LOG_PREFIX} Failed to parse data.`,t)}else if(localStorage.getItem("sparrow-crm-state"))try{e=JSON.parse(localStorage.getItem("sparrow-crm-state"))}catch(t){console.error(`${LOG_PREFIX} Failed to parse local storage data.`,t)}e&&(AppState={...AppState,...e,ui:AppState.ui},window.addEventListener("unload",()=>{AppState.settings.ghostMode?localStorage.removeItem("sparrow-crm-state"):(()=>{const t={...AppState};delete t.ui,localStorage.setItem("sparrow-crm-state",JSON.stringify(t))})()})),Events.init(),AppState.ui.isFsaSupported="showOpenFilePicker"in window,AppState.contacts.length>0?UI.renderApp():UI.resetToWelcomeScreen();const n=new URLSearchParams(window.location.search);if(n.has("q")){const t=n.get("q");DOM.mainSearchInput.value=t,UI.renderContactGrid()}const s=window.location.hash.substring(1);s&&AppState.contacts.find(t=>t.sparrow_contact_id===s)&&UI.renderContactModal(s)}
    document.addEventListener('DOMContentLoaded', init);
    }());
    </script>

</body></html>