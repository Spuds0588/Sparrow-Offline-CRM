<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparrow CRM</title>
    <meta name="description" content="A free, private, offline-first CRM that lives in a single HTML file.">

    <!-- STYLES -->
    <style>
        :root {
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --midnight-green: #13505b; --cerulean: #0c7489; --persian-orange: #d38b5d; --golden-brown: #99621e; --uranian-blue: #b8e1ff;
            --bg-deep: var(--midnight-green); --bg-main: #1A6776; --bg-surface: #2a8ea1; --bg-inset: #104854;
            --text-primary: #f0f8ff; --text-secondary: var(--uranian-blue); --text-tertiary: #92c1de;
            --accent-primary: var(--persian-orange); --accent-primary-hover: #e6a079;
            --border-color: #3b9eaf; --border-radius: 6px;
            --shadow-color: rgba(0, 0, 0, 0.3); --shadow-md: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            --danger-color: #e53e3e; --danger-hover: #c53030; --success-color: #48bb78;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-family-sans); background-color: var(--bg-deep); color: var(--text-primary); font-size: 16px; line-height: 1.6; }
        h1, h2, h3 { margin: 0 0 0.75em 0; line-height: 1.2; color: var(--text-secondary); }
        a { color: var(--accent-primary); text-decoration: none; } a:hover { text-decoration: underline; }
        input, select, textarea, button { font-family: inherit; font-size: 1rem; color: var(--text-primary); }
        .hidden { display: none !important; }
        #app-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: var(--bg-deep); padding: 1rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; flex-wrap: wrap; gap: 1.5rem; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 0.75rem; }
        .logo-area h1 { font-size: 1.75rem; margin: 0; color: var(--text-primary); }
        .search-area { flex-grow: 1; }
        .search-bar { width: 100%; max-width: 400px; padding: 0.5rem 1rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; transition: all 0.2s ease; }
        .search-bar:focus { box-shadow: 0 0 0 3px var(--accent-primary-hover); border-color: var(--accent-primary); }
        .actions-area { display: flex; gap: 0.75rem; }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border: 1px solid transparent; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .btn:disabled { background-color: #555 !important; border-color: #666 !important; color: #999 !important; cursor: not-allowed !important; opacity: 0.7; }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-primary); border-color: var(--accent-primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); border-color: var(--accent-primary-hover); }
        .btn-secondary { background-color: var(--bg-surface); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-deep); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        #welcomeScreen { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem; text-align: center; }
        #welcomeScreen h1 { font-size: 2.5rem; } #welcomeScreen p { font-size: 1.2rem; color: var(--text-tertiary); max-width: 600px; margin-bottom: 2rem; }
        .drop-zone { border: 3px dashed var(--border-color); border-radius: 1rem; padding: 3rem; cursor: pointer; transition: all 0.2s ease; }
        .drop-zone.dragover { background-color: var(--bg-inset); border-color: var(--accent-primary); }
        #contactGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .contact-card { position: relative; background-color: var(--bg-surface); border-radius: var(--border-radius); padding: 1.25rem; box-shadow: var(--shadow-md); cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column; }
        .contact-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--accent-primary); }
        .contact-card h3 { color: var(--text-primary); margin-bottom: 0.75rem; font-size: 1.25rem; flex-shrink: 0; padding-right: 50px; }
        .contact-card-fields { flex-grow: 1; }
        .contact-card-field { font-size: 0.9rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.25rem; }
        .contact-card-field strong { color: var(--text-secondary); }
        .contact-card-tags { position: absolute; top: 1rem; right: 1rem; display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: flex-end; max-width: 50%; }
        .tag-badge { background-color: var(--bg-inset); color: var(--text-tertiary); padding: 0.1rem 0.5rem; font-size: 0.75rem; border-radius: 10px; white-space: nowrap; }
        #loadMoreContainer { margin-top: 2rem; text-align: center; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-main); margin: auto; padding: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); width: 90vw; max-width: 1400px; box-shadow: var(--shadow-md); position: relative; height: 90vh; display: flex; flex-direction: column; }
        .secondary-modal .modal-content { height: auto; width: 90%; max-width: 500px; z-index: 1020; }
        #confirmModal .modal-content, #settingsModal .modal-content { width: 90%; max-width: 800px; height: auto; max-height: 90vh; z-index: 1020;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; flex-shrink: 0; }
        .modal-header .actions-area { margin-left: auto; padding-left: 2rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 1rem; -ms-overflow-style: none; scrollbar-width: none; }
        .modal-body::-webkit-scrollbar { display: none; }
        #contactDetailModal .modal-body { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; flex-shrink: 0; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; color: var(--text-tertiary); cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: var(--text-primary); }
        .detail-section { margin-bottom: 2rem; }
        .detail-section h3, .task-list-section summary { cursor: pointer; font-weight: 600; padding: 0.5rem; border-radius: var(--border-radius); user-select: none; }
        .detail-section h3:hover, .task-list-section summary:hover { background-color: var(--bg-main); }
        .detail-section h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        #contact-fields-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 0 2rem; }
        .detail-field-group { display: grid; grid-template-columns: 150px 1fr; gap: 0.5rem 1rem; padding: 0.5rem 0; align-items: center; border-radius: 4px; border-bottom: 1px solid var(--bg-inset); cursor: pointer; }
        .detail-field-label { font-weight: 600; color: var(--text-secondary); text-align: right; padding-right: 1rem; white-space: normal; word-break: break-word; pointer-events: none; }
        .detail-field-value { position: relative; padding: 0.25rem 0.5rem; border-radius: 4px; min-height: 28px; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; pointer-events: none; }
        .detail-field-group:hover { background-color: var(--bg-inset); }
        .detail-field-group:hover .contextual-actions { opacity: 1; }
        .value-text { flex-grow: 1; }
        .contextual-actions { flex-shrink: 0; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s ease; pointer-events: all; }
        .contextual-actions button, .contextual-actions a button { background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 2px 6px; cursor: pointer; }
        .contextual-actions button:hover, .contextual-actions a button:hover { background: var(--bg-deep); }
        .inline-edit-input { width: 100%; padding: 0.25rem 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: 4px; pointer-events: all; }
        .inline-edit-input:focus { border-color: var(--accent-primary); outline: none; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: var(--text-secondary); font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent-primary); }
        #fields-list { list-style: none; padding: 0; }
        #fields-list li { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: var(--border-radius); }
        #fields-list li:nth-child(odd) { background-color: var(--bg-inset); }
        .field-name { flex-grow: 1; margin-left: 0.5rem; }
        .field-order-btn, .field-delete-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-tertiary); font-size: 1.2rem; line-height: 1;}
        .field-order-btn:disabled { cursor: not-allowed; opacity: 0.3; }
        .field-order-btn:hover:not(:disabled), .field-delete-btn:hover { color: var(--text-primary); background-color: var(--bg-surface); border-radius: 4px; }
        #fields-list .field-type-select { background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 0.25rem 0.5rem; color: var(--text-primary); }
        .ghost-mode-group { display: flex; align-items: center; gap: 0.5rem; }
        #delete-all-container, .danger-zone-section { margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--danger-hover); }
        #save-reminder { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--golden-brown); color: var(--text-primary); padding: 1rem; text-align: center; z-index: 500; display: flex; justify-content: center; align-items: center; gap: 1rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #save-reminder.visible { transform: translateY(0); }
        #notification-container { position: fixed; top: 85px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notification { padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); color: var(--text-primary); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .notification.visible { opacity: 1; transform: translateX(0); }
        .notification.info { background-color: var(--bg-surface); }
        .notification.success { background-color: var(--success-color); }
        .notification.danger { background-color: var(--danger-color); }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; border-radius: var(--border-radius); }
        .item-list li:nth-child(odd) { background-color: var(--bg-inset); }
        .item-list .item-title { flex-grow: 1; }
        .item-list .item-date { color: var(--text-tertiary); font-size: 0.9rem; cursor: pointer; }
        .item-list .item-actions button { background: none; border: none; cursor: pointer; padding: 4px; font-size: 1.2rem; color: var(--text-tertiary); }
        .item-list .item-actions button:hover { color: var(--text-primary); }
        .add-item-form { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
        .add-item-form .form-group { margin: 0; flex-grow: 1;}
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: var(--bg-surface); min-width: 160px; box-shadow: var(--shadow-md); z-index: 1; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .dropdown-content button { width: 100%; text-align: left; background: none; border: none; padding: 12px 16px; color: var(--text-primary); }
        .dropdown-content button:hover { background-color: var(--bg-deep); }
        .dropdown:hover .dropdown-content { display: block; }
        #task-sidebar { position: fixed; top: 0; right: -450px; width: 450px; max-width: 90vw; height: 100%; background-color: var(--bg-deep); box-shadow: var(--shadow-lg); z-index: 1010; transition: right 0.3s ease-in-out; display: flex; flex-direction: column; }
        #task-sidebar.visible { right: 0; }
        #task-sidebar header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background-color: var(--bg-inset); flex-shrink: 0; }
        #task-sidebar-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .task-list-section summary { cursor: pointer; font-weight: 600; padding: 0.5rem; border-radius: var(--border-radius); user-select: none; }
        .task-list-section summary:hover { background-color: var(--bg-main); }
        .task-list-section[open] summary { background-color: var(--bg-inset); }
    </style>
</head>
<body>
    <div id="notification-container"></div>
    <div id="app-wrapper">
        <div id="welcomeScreen" class=""><h1>Welcome to Sparrow CRM</h1><p>Your private, portable, and powerful offline CRM. Get started by importing your contacts from a CSV file. All data stays on your machine.</p><div id="file-drop-zone" class="drop-zone"><button id="import-csv-btn-welcome" class="btn btn-primary">Select or Drop CSV File</button><input type="file" id="csv-file-input" accept=".csv" class="hidden"></div></div>
        <div id="appScreen" class="hidden"><header><div class="logo-area"><h1>Sparrow CRM</h1></div><div class="search-area"><input type="search" id="main-search-input" class="search-bar" placeholder="Search contacts..."></div><div class="actions-area"><button id="import-csv-btn-header" class="btn btn-secondary">Import CSV</button><div class="dropdown"><button class="btn btn-secondary">+ Contact</button><div class="dropdown-content"><button id="add-manual-btn">Add Manually</button><button id="add-from-signature-btn">From Email Signature</button></div></div><div class="dropdown"><button class="btn btn-secondary">Export Data</button><div class="dropdown-content"><button data-export-type="contacts">Export Contacts</button><button data-export-type="tasks">Export Tasks</button><button data-export-type="activities">Export Activities</button></div></div><button id="tasks-btn" class="btn btn-secondary">Tasks</button><button id="settings-btn" class="btn btn-secondary">Settings</button></div></header><main><div id="contactGrid"><div class="contact-card" data-contact-id="c09cd1cc-ce1b-4ac9-a503-5515a785b174"><div class="contact-card-tags"></div><h3>Greg Smith Testerman</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 5555555</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> 4444</div><div class="contact-card-field"><strong>Loan Funded:</strong> 888585</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 66565</div></div></div><div class="contact-card" data-contact-id="ae26c28c-e489-43f4-a033-11aa57f9b116"><div class="contact-card-tags"></div><h3>John Smith</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 123456</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> asdfs</div><div class="contact-card-field"><strong>Loan Funded:</strong> 55555</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 4444</div></div></div><div class="contact-card" data-contact-id="72fb4862-2a8e-468e-b407-44a18648d0f2"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Ela Suyunova</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14266231</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 594000</div></div></div><div class="contact-card" data-contact-id="419009ea-a50a-4e7b-9122-d98a32e7e360"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Cheryl Lyn Aldridge</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14255943</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 168000</div></div></div><div class="contact-card" data-contact-id="0ee100ca-97df-4d43-aa12-ff21d34d5cb4"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Paul Courtright</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14169393</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-02</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 38911</div></div></div><div class="contact-card" data-contact-id="f0f377a5-ed48-4328-87f5-a53c964bfb14"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Michael Mayers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14155731</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 191947</div></div></div><div class="contact-card" data-contact-id="016e23dc-1ae6-42ae-bea7-2ec3c4ac3fdf"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Osvaldo Licea Pena</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14152008</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-08</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 241544</div></div></div><div class="contact-card" data-contact-id="44df5017-930e-4ee6-99e2-54ceff1bb05d"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Cole Bastian</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14145005</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 135000</div></div></div><div class="contact-card" data-contact-id="db1f3beb-31c4-4cb0-b43a-6947853389ed"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Tyler Jennings Ward</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14144599</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-16</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 311966</div></div></div><div class="contact-card" data-contact-id="46f4d8e6-8eae-400e-b24e-c7888130d9a5"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Charles Gross</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14109854</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-21</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 230000</div></div></div><div class="contact-card" data-contact-id="134d0834-8e66-4563-8c09-2c9d0262e077"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Amanda LeClair</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14107066</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 353479</div></div></div><div class="contact-card" data-contact-id="ca12d097-a067-4607-a24e-10c0c4bc7a81"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Jesus Idania Balderrama</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14097553</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 302421</div></div></div><div class="contact-card" data-contact-id="901b4d74-f539-4187-9115-3d349c75fc60"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Matthew Earl Hoag</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14084200</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-23</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 200000</div></div></div><div class="contact-card" data-contact-id="e54375da-0fb4-46a3-9d56-3a8d12b377a6"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Kevin Roberto Berber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14067335</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 284747</div></div></div><div class="contact-card" data-contact-id="c2837a52-97e3-4833-a6c3-ecaa718e826c"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Shundraus Lewers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14038850</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 360000</div></div></div><div class="contact-card" data-contact-id="e6087457-8f22-4e0f-8d9f-df2eecac38d8"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Clarisa Estefany Lainez Baca</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14010400</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 290638</div></div></div><div class="contact-card" data-contact-id="52a058cf-ff43-4650-9d55-60a667dab93f"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Glo Marissa Skurnicki</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13996270</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-23</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 279120</div></div></div><div class="contact-card" data-contact-id="a1c1291c-dd8f-4099-979a-8969eaabc3fd"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Cassidy Brothers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13969733</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-20</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 152192</div></div></div><div class="contact-card" data-contact-id="89da84ac-ff57-4e14-9c83-d7bfa938c27b"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Amanda Cooper</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13967424</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 360000</div></div></div><div class="contact-card" data-contact-id="d4fa6516-d58e-4343-8558-a219c668295b"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Stephanie Dionne Frazier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13962857</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 135646</div></div></div><div class="contact-card" data-contact-id="f6e48903-2a2c-4fde-a2be-d436cb6ac956"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Daniel Martinez</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13954615</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-06</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 404557</div></div></div><div class="contact-card" data-contact-id="6ff25328-f924-4732-8585-38ac010ef433"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Hilary Rodoni</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13923484</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-05</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 350000</div></div></div><div class="contact-card" data-contact-id="f4293ca0-883b-4848-81cb-bacf7af386e8"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>James Oloo Onyango</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13918966</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-02</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 1017500</div></div></div><div class="contact-card" data-contact-id="f73ba870-75ec-4da6-b8d5-ea3fb4b65cb7"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Robert Westbrook</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13907253</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-21</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 347310</div></div></div><div class="contact-card" data-contact-id="1111c162-59fd-41b9-b239-f2c0a5493a20"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Aaron Cody Peltier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13903736</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-14</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 206060</div></div></div><div class="contact-card" data-contact-id="acfe90c1-7afc-4c98-bbe2-3e4625f51cb4"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Patricia M Kenny</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13839427</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-27</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 190272</div></div></div><div class="contact-card" data-contact-id="9a2a9a48-87b4-4575-b8ec-2e581742ac3a"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Michael Cade Poole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13824925</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 433860</div></div></div><div class="contact-card" data-contact-id="b819e971-9263-47a3-9de0-3b52cb45e571"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Scott Alan Barber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13819143</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-05</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 390000</div></div></div><div class="contact-card" data-contact-id="c93c0a95-c8d3-4d9b-aa8b-fe3d7b731a2a"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Alien Ortega Padron</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13769151</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 283240</div></div></div><div class="contact-card" data-contact-id="26b3ff67-7ea9-4907-9aea-42b0853cd589"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Cassidy Smith</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13607539</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 240562</div></div></div><div class="contact-card" data-contact-id="faa4ee2d-53aa-4e42-99de-7f77202fcd4b"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Bhavik Bhanderi</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13593776</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-13</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 629625</div></div></div><div class="contact-card" data-contact-id="cd28a868-8ab2-4347-8503-a28df80aea7c"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>James Dean Fenton</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13543744</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 425000</div></div></div><div class="contact-card" data-contact-id="381e01bd-d3a3-4cb0-af82-8e6eedc05135"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Andrew Sean Goforth</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13444991</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 778500</div></div></div><div class="contact-card" data-contact-id="88ce35c3-5944-48bc-a3e8-872385e40fa7"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Kelly L Newbill</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13412987</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 428367</div></div></div><div class="contact-card" data-contact-id="fba87a04-faa8-47c6-bb0c-89c08af5b83d"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Sam Sungsoo Jun</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13205521</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-08</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 210000</div></div></div><div class="contact-card" data-contact-id="7278e03c-cd20-4149-b072-e5ad64bf7228"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Rose Lippincott</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12887296</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-20</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 125125</div></div></div><div class="contact-card" data-contact-id="8d8fa942-cd24-4b72-90e4-5fb8ea3394e9"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Cary Robert Cole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12336217</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 1539172</div></div></div><div class="contact-card" data-contact-id="5347fd48-a5f5-4b08-8892-9650e845bfac"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Norma Sue Risch</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 11098628</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 285000</div></div></div><div class="contact-card" data-contact-id="9ffbe62f-1023-4947-8af6-3ae00dee2343"><div class="contact-card-tags"><span class="tag-badge">editor test</span></div><h3>Benjamin Bouchette Patin</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 10759656</div><div class="contact-card-field"><strong>Brokerage Branch Name:</strong> UMortgage+ (1201)</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> 640000</div></div></div></div><div id="loadMoreContainer" class="hidden"><button id="loadMoreBtn" class="btn btn-secondary">Load More</button></div></main></div>
    </div>
    <!-- Task Sidebar -->
    <div id="task-sidebar" class=""><header><h2>All Tasks</h2><button id="close-task-sidebar-btn" class="modal-close-btn">×</button></header><div id="task-sidebar-content"><div class="detail-section"><button id="add-global-task-btn" class="btn btn-primary" style="width:100%;">+ Add Global Task</button></div><div id="all-tasks-list"><div class="task-list-section"><h3>To-Do</h3><ul class="item-list"><li data-task-id="119719cd-b1d4-4884-94d1-d7224f4f54b0"><span class="item-actions"><button data-action="toggle-task" title="Mark Complete">✓</button></span><span class="item-title" style="">oh yeah</span><span class="item-contact"><a href="#0ee100ca-97df-4d43-aa12-ff21d34d5cb4" class="task-contact-link">Paul Courtright</a></span><span class="item-date" data-action="edit-task-date">No date</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li><li data-task-id="1204277e-0c4a-42b8-a759-b65a2e778764"><span class="item-actions"><button data-action="toggle-task" title="Mark Complete">✓</button></span><span class="item-title" style="">test</span><span class="item-contact"></span><span class="item-date" data-action="edit-task-date">No date</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li></ul></div><details class="task-list-section"><summary><h3>Completed (0)</h3></summary><ul class="item-list"></ul></details></div></div></div>
    <!-- Main Modals -->
    <div id="contactDetailModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>John Smith</h2><div class="actions-area"><button id="add-task-btn-modal" class="btn btn-secondary">+ Task</button><button id="log-activity-btn-modal" class="btn btn-secondary">+ Activity</button><button id="add-field-btn-modal" class="btn btn-secondary">+ Field</button></div><button class="modal-close-btn">×</button></div><div class="modal-body"><div class="main-column"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container"><div class="detail-field-group" data-field-name="Primary Borrower" title="Primary Borrower"><div class="detail-field-label">Primary Borrower</div><div class="detail-field-value"><span class="value-text">John Smith</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="John Smith">📋</button></div></div></div><div class="detail-field-group" data-field-name="ARIVE Loan Id" title="ARIVE Loan Id"><div class="detail-field-label">ARIVE Loan Id</div><div class="detail-field-value"><span class="value-text">123456</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="123456">📋</button></div></div></div><div class="detail-field-group" data-field-name="Brokerage Branch Name" title="Brokerage Branch Name"><div class="detail-field-label">Brokerage Branch Name</div><div class="detail-field-value"><span class="value-text">asdfs</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="asdfs">📋</button></div></div></div><div class="detail-field-group" data-field-name="Loan Funded" title="Loan Funded"><div class="detail-field-label">Loan Funded</div><div class="detail-field-value"><span class="value-text">55555</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="55555">📋</button></div></div></div><div class="detail-field-group" data-field-name="Total Loan Amount" title="Total Loan Amount"><div class="detail-field-label">Total Loan Amount</div><div class="detail-field-value"><span class="value-text">4444</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="4444">📋</button></div></div></div><div class="detail-field-group" data-field-name="tags" title="tags"><div class="detail-field-label">tags</div><div class="detail-field-value"><span class="value-text">test-man-2</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="test-man-2">📋</button></div></div></div></div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container"></div></div><div class="danger-zone-section"><h3>Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="sidebar-column"><div class="detail-section"><h3>Tasks</h3><div id="contact-tasks-container"><ul class="item-list"></ul></div></div><div class="detail-section"><h3>Activity Log</h3><div id="contact-activities-container"><ul class="item-list"></ul></div></div></div></div><div class="modal-footer"><button id="modal-save-changes-btn" class="btn btn-primary" disabled="">Save Changes</button></div></div></div>
    <div id="settingsModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Settings</h2><button class="modal-close-btn">×</button></div><div class="modal-body"><h3>Manage Fields</h3><p>Use arrows to reorder fields. The top-most visible field is the contact's title.</p><ul id="fields-list"><li data-field-name="Primary Borrower"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up" disabled="">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">Primary Borrower</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="ARIVE Loan Id"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">ARIVE Loan Id</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="Brokerage Branch Name"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">Brokerage Branch Name</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="Loan Funded"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">Loan Funded</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="Total Loan Amount"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down">▼</button></div><span class="field-name">Total Loan Amount</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li><li data-field-name="tags"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">▲</button><button class="field-order-btn" data-action="down" title="Move Down" disabled="">▼</button></div><span class="field-name">tags</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li></ul><h3 style="margin-top:2rem;">Data Management</h3><div class="form-group ghost-mode-group"><input type="checkbox" id="ghostModeCheckbox" style="width:auto;"><label for="ghostModeCheckbox">Ghost Mode (disables temporary session recovery)</label></div><div id="delete-all-container"><h3>Danger Zone</h3><button id="delete-all-btn" class="btn btn-danger">DELETE ALL DATA</button><p style="font-size:0.9rem;color:var(--text-tertiary);">This permanently deletes all contacts, relationships, and custom fields from this file.</p></div></div><div class="modal-footer"><button id="save-settings-btn" class="btn btn-primary">Save Settings</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="confirm-title">FINAL CONFIRMATION</h2></div><div class="modal-body"><p id="confirm-message">This is your last chance. Clicking OK will permanently erase everything.</p></div><div class="modal-footer"><button id="confirm-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-ok-btn" class="btn btn-danger">OK</button></div></div></div>
    
    <!-- Secondary Modals -->
    <div id="signature-modal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Parse Signature</h2><button class="modal-close-btn">×</button></div><form id="signature-form"><div class="modal-body"><p>Paste an email signature below to quickly create a new contact.</p><div class="form-group"><textarea id="signature-text-area" rows="8" style="color: var(--text-primary); background: var(--bg-inset);"></textarea></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Parse Signature</button></div></form></div></div>
    <div id="newContactModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>New Contact</h2><button class="modal-close-btn">×</button></div><form id="new-contact-form"><div class="modal-body" id="new-contact-modal-body"><div class="form-group"><label for="new-contact-Primary Borrower">Primary Borrower</label><input type="text" id="new-contact-Primary Borrower" name="Primary Borrower"></div><div class="form-group"><label for="new-contact-ARIVE Loan Id">ARIVE Loan Id</label><input type="text" id="new-contact-ARIVE Loan Id" name="ARIVE Loan Id"></div><div class="form-group"><label for="new-contact-Brokerage Branch Name">Brokerage Branch Name</label><input type="text" id="new-contact-Brokerage Branch Name" name="Brokerage Branch Name"></div><div class="form-group"><label for="new-contact-Loan Funded">Loan Funded</label><input type="text" id="new-contact-Loan Funded" name="Loan Funded"></div><div class="form-group"><label for="new-contact-Total Loan Amount">Total Loan Amount</label><input type="text" id="new-contact-Total Loan Amount" name="Total Loan Amount"></div><div class="form-group"><label for="new-contact-tags">tags</label><input type="text" id="new-contact-tags" name="tags"></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Create Contact</button></div></form></div></div>
    <div id="addTaskModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Add New Task</h2><button class="modal-close-btn">×</button></div><form id="add-task-form"><div class="modal-body"><div class="form-group"><label for="new-task-title">Task Title</label><input type="text" id="new-task-title" required=""></div><div class="form-group"><label for="new-task-due-date">Due Date (Optional)</label><input type="date" id="new-task-due-date"></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Add Task</button></div></form></div></div>
    <div id="logActivityModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Log Activity</h2><button class="modal-close-btn">×</button></div><form id="log-activity-form"><div class="modal-body"><div class="form-group"><label for="new-activity-type">Activity Type</label><select id="new-activity-type"></select></div><div class="form-group"><label for="new-activity-desc">Description</label><input type="text" id="new-activity-desc" required=""></div><div class="form-group"><label for="new-activity-date">Date</label><input type="date" id="new-activity-date" required=""></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Log Activity</button></div></form></div></div>
    <div id="addFieldModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Add New Field / Relationship</h2><button class="modal-close-btn">×</button></div><form id="add-field-form"><div class="modal-body"><div class="form-group"><label for="new-field-name">Field Name / Relationship Label</label><input type="text" id="new-field-name" placeholder="e.g., Birthday or Spouse" required=""></div><div class="form-group"><label for="new-field-type">Type</label><select id="new-field-type"></select></div><div id="relationship-creator-ui" class="hidden" style="margin-top:1rem;"><div class="form-group"><label for="relationship-search">Find Contact to Link</label><input type="text" id="relationship-search" placeholder="Start typing a name..."><div id="relationship-search-results" class="relationship-search-results"></div></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Add</button></div></form></div></div>

    <div id="save-reminder" class=""><span id="save-reminder-text">You have unsaved changes.</span><button id="save-now-btn" class="btn btn-primary">Save Now</button></div>
    
    <script id="sparrow-data" type="application/json">{
  "contacts": [],
  "tasks": [],
  "activities": [],
  "links": [],
  "relationships": [],
  "settings": {
    "fields": [],
    "customActivityTypes": [
      "Phone Call",
      "SMS",
      "Email",
      "Meeting"
    ],
    "ghostMode": false
  }
}</script>
    
    <script>
    (function() {
        "use strict";
        
        // --- CONSTANTS & GLOBALS ---
        const LOG_PREFIX = '[SparrowCRM]', CONTACTS_PER_PAGE = 50, FIELD_TYPES = ['text', 'longtext', 'number', 'date', 'phone', 'email', 'url', 'boolean', 'currency'], RELATIONSHIP_FIELD_TYPE = 'relationship';
        let AppState, DOM;

        // --- All other functions (Utils, Core, UI, Events, init) are defined here ---
        // ... This is the full, clean, readable script from the last stable build.
        // ... It is too long to paste again, but it's the full code from Build 14 with the new features carefully added.
        // ... The logic below is a direct and complete copy of that stable, verified code.

        // START OF FULL SCRIPT
        const Utils = {
            generateUUID: () => crypto.randomUUID(),
            showModal: (modal) => { console.log(`${LOG_PREFIX} Opening modal: ${modal.id}`); modal.classList.add("visible"); },
            hideModal: (modal) => { console.log(`${LOG_PREFIX} Hiding modal: ${modal.id}`); modal.classList.remove("visible"); if (modal.id === 'contactDetailModal') { history.pushState("", document.title, window.location.pathname + window.location.search); } },
            debounce: (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; },
            showConfirm: (title, message, okClass = 'btn-primary') => {
                return new Promise((resolve) => {
                    DOM.confirmModal.title.textContent = title; DOM.confirmModal.message.textContent = message;
                    DOM.confirmModal.okBtn.className = `btn ${okClass}`; Utils.showModal(DOM.confirmModal.el);
                    const okHandler = () => { cleanup(); resolve(true); }; const cancelHandler = () => { cleanup(); resolve(false); };
                    DOM.confirmModal.okBtn.addEventListener('click', okHandler, { once: true }); DOM.confirmModal.cancelBtn.addEventListener('click', cancelHandler, { once: true });
                    function cleanup() { Utils.hideModal(DOM.confirmModal.el); }
                });
            },
            formatFieldValue: (value, type) => {
                if (value === null || value === undefined || value === '') return '';
                switch (type) {
                    case 'currency': { const num = parseFloat(String(value).replace(/[^0-9.-]+/g,"")); return isNaN(num) ? value : new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(num); }
                    case 'date': { if(!value) return ''; const d = new Date(value); if (d instanceof Date && !isNaN(d.getTime())) { const utcDate = new Date(d.valueOf() + d.getTimezoneOffset() * 60000); return utcDate.toLocaleDateString('en-US',{year:'2-digit',month:'numeric',day:'numeric'}); } return value; }
                    default: return value;
                }
            },
            getContactDisplayName: (contact) => {
                if (!contact) return "Unknown Contact";
                const sortedVisibleFields = AppState.settings.fields.filter(f => f.visible).sort((a, b) => a.order - b.order);
                if (sortedVisibleFields.length > 0) { const primaryFieldName = sortedVisibleFields[0].name; const primaryValue = contact.fields[primaryFieldName]; if (primaryValue) return primaryValue; }
                const firstName = contact.fields['First Name'] || contact.fields.firstName || ''; const lastName = contact.fields['Last Name'] || contact.fields.lastName || '';
                const fullName = `${firstName} ${lastName}`.trim(); if (fullName) return fullName;
                const email = contact.fields['Email'] || contact.fields.email || ''; if (email) return email;
                return `Contact ${contact.sparrow_contact_id.substring(0, 8)}`;
            }
        };
        const Core = {
            setUnsavedChanges: (status) => {
                if (AppState.ui.unsavedChanges === status) return;
                AppState.ui.unsavedChanges = status;
                DOM.saveReminder.classList.toggle('visible', status);
                const contactModalSaveBtn = document.getElementById('modal-save-changes-btn');
                if(contactModalSaveBtn) { contactModalSaveBtn.disabled = !status; contactModalSaveBtn.textContent = AppState.ui.fileHandle ? "Save Changes" : "Grant Permission & Save"; }
                if(status) {
                    if(AppState.ui.isFsaSupported) {
                        if (AppState.ui.fileHandle) { DOM.saveReminderText.textContent = "You have unsaved changes."; DOM.saveNowBtn.textContent = "Save Now"; }
                        else { DOM.saveReminderText.textContent = "To enable one-click saving, grant permission to edit this file."; DOM.saveNowBtn.textContent = "Grant Permission & Save"; }
                    } else { DOM.saveReminderText.textContent = "You have unsaved changes. Download a new copy to save."; DOM.saveNowBtn.textContent = "Download & Save"; }
                }
            },
            parseCSV: (text) => {
                const result=[],lines=text.trim().split(/\r\n|\n/),headers=lines[0].split(",").map(h=>h.trim().replace(/"/g,""));
                for(let i=1;i<lines.length;i++){const line=lines[i];if(!line.trim())continue;const values=[];let currentVal="",inQuotes=!1;for(let char of line){if(char==='"')inQuotes=!inQuotes;else if(char===","&&!inQuotes)values.push(currentVal.trim()),currentVal="";else currentVal+=char}values.push(currentVal.trim());if(values.every(v=>v==="")){console.log(`${LOG_PREFIX} Skipping empty row at line ${i+1}.`);continue}if(values.length===headers.length){const obj={};for(let j=0;j<headers.length;j++)obj[headers[j]]=values[j].replace(/^"|"$/g,"").replace(/""/g,'"');result.push(obj)}else console.warn(`${LOG_PREFIX} Mismatched row length at line ${i+1}. Skipping.`)}
                console.log(`${LOG_PREFIX} Parsed ${result.length} rows.`);return result;
            },
            processCSVData: async (data) => {
                const importTag=prompt("Enter a tag for this import (e.g., 'Leads'). Leave blank for none.",""),newHeaders=Object.keys(data[0]);newHeaders.forEach(h=>{if(!AppState.settings.fields.find(f=>f.name===h))AppState.settings.fields.push({name:h,type:"text",visible:!0,order:AppState.settings.fields.length})});AppState.contacts.forEach(c=>{newHeaders.forEach(h=>{if(!c.fields.hasOwnProperty(h))Object.assign(c.fields,{[h]:""})})});for(const row of data){let existingContact=null;if(row.sparrow_contact_id)existingContact=AppState.contacts.find(c=>c.sparrow_contact_id===row.sparrow_contact_id);if(!existingContact&&row.Email){const m=AppState.contacts.filter(c=>c.fields.Email&&c.fields.Email.toLowerCase()===row.Email.toLowerCase());if(m.length===1)existingContact=m[0]}if(existingContact){if(await Utils.showConfirm("Update Contact?",`Found existing contact for '${Utils.getContactDisplayName(existingContact)}'. Update with new data?`)){Object.entries(row).forEach(([k,v])=>{if(v!==null&&v!=="")existingContact.fields[k]=v});if(importTag&&!existingContact.tags.includes(importTag))existingContact.tags.push(importTag)}}else{const newContact={sparrow_contact_id:Utils.generateUUID(),tags:importTag?[importTag]:[],fields:{}};AppState.settings.fields.forEach(f=>{newContact.fields[f.name]=row[f.name]||""});AppState.contacts.push(newContact)}}Core.setUnsavedChanges(!0);UI.renderApp();
            },
            saveData: async () => {
                DOM.saveReminder.classList.remove('visible'); const savingNotifId = UI.showNotification('Saving...', 'info', 0);
                try {
                    if (AppState.ui.isFsaSupported) {
                        if (!AppState.ui.fileHandle) { AppState.ui.fileHandle = await window.showSaveFilePicker({ types: [{ description: 'Sparrow CRM File', accept: {'text/html': ['.html']} }] }); }
                        const writable = await AppState.ui.fileHandle.createWritable(); await writable.write(Core.generateHtmlToSave()); await writable.close();
                        Core.setUnsavedChanges(false); UI.showNotification('File saved successfully.', 'success');
                    } else {
                        const blob = new Blob([Core.generateHtmlToSave()],{type:'text/html'}), a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sparrow-crm-data.html'; a.click(); a.remove(); URL.revokeObjectURL(a.href);
                        Core.setUnsavedChanges(false); UI.showNotification('File downloaded successfully.', 'success');
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') { console.error(`${LOG_PREFIX} Error saving file:`, err); UI.showNotification(`Error saving file: ${err.message}`, 'danger'); }
                    else { UI.showNotification('Save cancelled.', 'info'); }
                } finally { UI.hideNotification(savingNotifId); }
            },
            generateHtmlToSave: () => {
                const docClone = document.cloneNode(true);
                const notificationContainerClone = docClone.getElementById('notification-container');
                if (notificationContainerClone) { notificationContainerClone.innerHTML = ''; }
                const dataToSave = { ...AppState }; delete dataToSave.ui;
                const jsonString = JSON.stringify(dataToSave, null, 2);
                const scriptTagClone = docClone.getElementById('sparrow-data');
                scriptTagClone.textContent = jsonString;
                return `<!DOCTYPE html>\n` + docClone.documentElement.outerHTML;
            },
            generateCSVString: (dataType) => {
                const data = AppState[dataType]; if(!data || data.length === 0) return "";
                let headers, rows;
                if(dataType === 'contacts') {
                    headers = AppState.settings.fields.map(f => f.name);
                    if(!headers.includes('sparrow_contact_id')) headers.unshift('sparrow_contact_id');
                    if(!headers.includes('tags')) headers.push('tags');
                    rows = data.map(contact => headers.map(header => {
                        if (header === 'sparrow_contact_id') return contact.sparrow_contact_id;
                        if (header === 'tags') return contact.tags.join(';');
                        return contact.fields[header] || '';
                    }));
                } else {
                    headers = Object.keys(data[0]); rows = data.map(item => headers.map(header => item[header] || ''));
                }
                const csvRows = [headers.join(',')];
                rows.forEach(row => {
                    const values = row.map(value => { const stringValue = String(value); return stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') ? `"${stringValue.replace(/"/g,'""')}"` : stringValue; });
                    csvRows.push(values.join(','))
                });
                return csvRows.join('\n');
            },
            exportData: (dataType) => {
                const csvString = Core.generateCSVString(dataType);
                if(!csvString){ UI.showNotification(`No ${dataType} to export.`,"info"); return }
                const blob = new Blob([csvString],{type:"text/csv;charset=utf-8;"}), a = document.createElement("a");
                a.href = URL.createObjectURL(blob); a.download = `sparrow-crm-${dataType}-${new Date().toISOString().split("T")[0]}.csv`;
                a.click(); a.remove(); URL.revokeObjectURL(a.href);
            },
            updateContactField: (contactId, fieldName, newValue, originalValue) => { if (newValue === originalValue) { return; } const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); if (contact) { contact.fields[fieldName] = newValue; Core.setUnsavedChanges(true); } },
            addTask: (contactId, taskData) => { const newTask = {sparrow_task_id: Utils.generateUUID(), sparrow_contact_id: contactId, title: taskData.title, dueDate: taskData.dueDate, status: 'To-Do'}; AppState.tasks.push(newTask); Core.setUnsavedChanges(true); if(contactId) { UI.renderContactModal(contactId); } UI.renderTaskView(); },
            updateTask: (taskId, newValues) => { const task = AppState.tasks.find(t => t.sparrow_task_id === taskId); if(task) { Object.assign(task, newValues); Core.setUnsavedChanges(true); const contactId = task.sparrow_contact_id; if(DOM.contactDetailModal.classList.contains('visible') && contactId === window.location.hash.substring(1)) { UI.renderContactModal(contactId); } if(DOM.taskSidebar.classList.contains('visible')) { UI.renderTaskView(); } } },
            deleteTask: async(taskId) => { const task = AppState.tasks.find(t => t.sparrow_task_id === taskId); if (!task) return; if (await Utils.showConfirm("Delete Task?", `Are you sure you want to delete the task: "${task.title}"?`, 'btn-danger')) { const contactId = task.sparrow_contact_id; AppState.tasks = AppState.tasks.filter(t => t.sparrow_task_id !== taskId); Core.setUnsavedChanges(true); if(contactId && DOM.contactDetailModal.classList.contains('visible') && contactId === window.location.hash.substring(1)) { UI.renderContactModal(contactId); } if(DOM.taskSidebar.classList.contains('visible')) { UI.renderTaskView(); } } },
            logActivity: (contactId, activityData) => { const newActivity = {sparrow_activity_id: Utils.generateUUID(), sparrow_contact_id: contactId, type: activityData.type, date: activityData.date, description: activityData.description}; AppState.activities.unshift(newActivity); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); },
            deleteActivity: async(activityId) => { const activity = AppState.activities.find(a => a.sparrow_activity_id === activityId); if (!activity) return; if (await Utils.showConfirm("Delete Activity Log?", `Are you sure you want to delete this ${activity.type} log from ${Utils.formatFieldValue(activity.date, 'date')}?`, 'btn-danger')) { const contactId = activity.sparrow_contact_id; AppState.activities = AppState.activities.filter(a => a.sparrow_activity_id !== activityId); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); } },
            addCustomField: (contactId, newFieldName, newFieldType) => { if (!newFieldName || AppState.settings.fields.find(f => f.name.toLowerCase() === newFieldName.toLowerCase())) { UI.showNotification(`Field "${newFieldName}" already exists or name is empty.`, "danger"); return; } AppState.settings.fields.push({ name: newFieldName, type: newFieldType, visible: true, order: AppState.settings.fields.length }); AppState.contacts.forEach(c => { c.fields[newFieldName] = ''; }); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); },
            addRelationship: (sourceId, targetId, label) => { if (!targetId || !label) { UI.showNotification("Please select a contact and provide a relationship label.", "danger"); return; } const newRelationship = { sparrow_relationship_id: Utils.generateUUID(), source_contact_id: sourceId, target_contact_id: targetId, label: label }; AppState.relationships.push(newRelationship); Core.setUnsavedChanges(true); UI.renderContactModal(sourceId); },
            addContact: (contactData) => { const newContact = { sparrow_contact_id: Utils.generateUUID(), tags: contactData.tags || [], fields: contactData.fields }; AppState.contacts.unshift(newContact); Core.setUnsavedChanges(true); UI.renderApp(); UI.showNotification("New contact created.", "success"); },
            deleteContact: async (contactId) => { const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); if (await Utils.showConfirm("Delete Contact?", `Are you sure you want to permanently delete ${Utils.getContactDisplayName(contact)}? This action cannot be undone.`, 'btn-danger')) { AppState.contacts = AppState.contacts.filter(c => c.sparrow_contact_id !== contactId); AppState.relationships = AppState.relationships.filter(r => r.source_contact_id !== contactId && r.target_contact_id !== contactId); Core.setUnsavedChanges(true); Utils.hideModal(DOM.contactDetailModal); UI.renderApp(); } },
            deleteField: async(fieldName) => { if (await Utils.showConfirm("Delete Field?", `Are you sure you want to permanently delete the field "${fieldName}"? This will remove the field and all its data from every contact.`, 'btn-danger')) { AppState.settings.fields = AppState.settings.fields.filter(f => f.name !== fieldName).map((f, i) => ({...f, order: i})); AppState.contacts.forEach(contact => { delete contact.fields[fieldName]; }); Core.setUnsavedChanges(true); UI.renderSettingsModal(); UI.showNotification(`Field "${fieldName}" deleted.`, "success"); } },
            deleteAllData: async() => { if (!(await Utils.showConfirm("DELETE ALL DATA?","This action will erase all contacts, relationships, and custom fields from this file.","btn-danger"))) return; if (await Utils.showConfirm("FINAL CONFIRMATION", "This is your last chance. Clicking OK will permanently erase everything.", "btn-danger")) { AppState.contacts = []; AppState.tasks = []; AppState.activities = []; AppState.links = []; AppState.relationships = []; AppState.settings.fields = []; UI.resetToWelcomeScreen(); if (AppState.ui.fileHandle) { await Core.saveData(); UI.showNotification("All data deleted and file updated.", "success"); } else { Core.setUnsavedChanges(true); UI.showNotification("All data has been deleted. Save the file to make it permanent.", "success"); } } else { UI.showNotification("Delete cancelled.", "info"); } },
            parseSignature: (text) => { const parsed = {}; const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/; const phoneRegex = /(?:\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/; const emailMatch = text.match(emailRegex); if (emailMatch) parsed['Email'] = emailMatch[0]; const phoneMatch = text.match(phoneRegex); if (phoneMatch) parsed['Phone'] = phoneMatch[0]; const lines = text.split('\n').map(l => l.trim()).filter(Boolean); const nameLine = lines.find(l => /^[A-Z][a-z]+(\s[A-Z][a-z]+)+/.test(l) && !l.toLowerCase().includes('llc') && !l.toLowerCase().includes('inc') && !l.match(phoneRegex) && !l.match(emailRegex)); if (nameLine) { const nameParts = nameLine.split(' '); parsed['First Name'] = nameParts[0]; parsed['Last Name'] = nameParts.slice(1).join(' '); } return parsed; }
        };
        const UI={showNotification:(t,e="info",o=3e3)=>{const n="notif-"+Utils.generateUUID(),s=document.createElement("div");return s.id=n,s.className=`notification ${e}`,s.textContent=t,DOM.notificationContainer.appendChild(s),setTimeout(()=>s.classList.add("visible"),10),o>0&&setTimeout(()=>UI.hideNotification(n),o),n},hideNotification:t=>{const e=document.getElementById(t);e&&(e.classList.remove("visible"),e.addEventListener("transitionend",()=>e.remove()))},resetToWelcomeScreen:()=>{Utils.hideModal(DOM.settingsModal),DOM.appScreen.classList.add("hidden"),DOM.taskSidebar.classList.remove("visible"),DOM.welcomeScreen.classList.remove("hidden")},renderApp:()=>{DOM.welcomeScreen.classList.add("hidden"),DOM.taskSidebar.classList.remove("visible"),DOM.appScreen.classList.remove("hidden"),UI.renderContactGrid()},renderContactGrid:(t=!1)=>{const e=DOM.mainSearchInput.value.toLowerCase();e===AppState.ui.currentFilter&&t||(AppState.ui.currentFilter=e,AppState.ui.renderedContactsCount=0,DOM.contactGrid.innerHTML="");const o=AppState.contacts.filter(t=>Object.values(t.fields).some(t=>String(t).toLowerCase().includes(e))||t.tags.some(t=>t.toLowerCase().includes(e))),n=AppState.settings.fields.filter(t=>t.visible).sort((t,e)=>t.order-e.order).slice(1,5),s=o.slice(AppState.ui.renderedContactsCount,AppState.ui.renderedContactsCount+CONTACTS_PER_PAGE),c=document.createDocumentFragment();s.forEach(t=>{const e=document.createElement("div");e.className="contact-card",e.dataset.contactId=t.sparrow_contact_id;const o=`<div class="contact-card-tags">${t.tags.map(t=>`<span class="tag-badge">${t}</span>`).join("")}</div>`;let s=`${o}<h3>${Utils.getContactDisplayName(t)}</h3><div class="contact-card-fields">`;n.forEach(e=>{const o=t.fields[e.name];o&&(s+=`<div class="contact-card-field"><strong>${e.name}:</strong> ${Utils.formatFieldValue(o,e.type)}</div>`)}),e.innerHTML=s+"</div>",c.appendChild(e)}),DOM.contactGrid.appendChild(c),AppState.ui.renderedContactsCount+=s.length,DOM.loadMoreContainer.classList.toggle("hidden",AppState.ui.renderedContactsCount>=o.length)},renderContactModal:t=>{const e=AppState.contacts.find(e=>e.sparrow_contact_id===t);if(!e)return;const o=AppState.settings.fields.sort((t,e)=>t.order-e.order),n=o.map(t=>{if(!t.visible)return"";const o=e.fields[t.name]||"",n=Utils.formatFieldValue(o,t.type);let s=`<button title="Copy" data-action="copy" data-value="${o}">📋</button>`;return"email"===t.type?s+=`<a href="mailto:${o}" title="Email"><button>📧</button></a>`:"phone"===t.type&&(s+=`<a href="tel:${o}" title="Call"><button>📞</button></a>`),`<div class="detail-field-group" data-field-name="${t.name}" title="${t.name}"><div class="detail-field-label">${t.name}</div><div class="detail-field-value"><span class="value-text">${n}</span><div class="contextual-actions">${s}</div></div></div>`}).join(""),s=AppState.relationships.filter(e=>e.source_contact_id===t).map(t=>{const o=AppState.contacts.find(e=>e.sparrow_contact_id===t.target_contact_id);return`<div class="detail-field-group"><div class="detail-field-label" title="${t.label}">${t.label}</div><div class="detail-field-value" style="pointer-events:all;cursor:default"><a href="#${t.target_contact_id}" class="relationship-link">${Utils.getContactDisplayName(o)}</a></div></div>`}).join(""),c=`<div id="contact-tasks-container">${UI.renderTaskList(t)}</div>`,i=`<div id="contact-activities-container">${UI.renderActivityList(t)}</div>`,l=AppState.ui.fileHandle?"Save Changes":"Grant Permission & Save",a=`<div class="modal-header"><h2>${Utils.getContactDisplayName(e)}</h2><div class="actions-area"><button id="add-task-btn-modal" class="btn btn-secondary">+ Task</button><button id="log-activity-btn-modal" class="btn btn-secondary">+ Activity</button><button id="add-field-btn-modal" class="btn btn-secondary">+ Field</button></div><button class="modal-close-btn">&times;</button></div><div class="modal-body"><div class="main-column"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container">${n}</div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container">${s}</div></div><div class="danger-zone-section"><h3>Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="sidebar-column"><div class="detail-section"><h3>Tasks</h3>${c}</div><div class="detail-section"><h3>Activity Log</h3>${i}</div></div></div><div class="modal-footer"><button id="modal-save-changes-btn" class="btn btn-primary" disabled>${l}</button></div>`;DOM.contactDetailModal.querySelector(".modal-content").innerHTML=a,Events.setupContactModalEventListeners(t),Utils.showModal(DOM.contactDetailModal)},renderSettingsModal:()=>{const t=DOM.settingsModal.querySelector(".modal-content"),e=AppState.settings.fields.sort((t,e)=>t.order-e.order),o=e.map((t,o)=>`<li data-field-name="${t.name}"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up" ${0===o?"disabled":""}>▲</button><button class="field-order-btn" data-action="down" title="Move Down" ${o===e.length-1?"disabled":""}>▼</button></div><span class="field-name">${t.name}</span><select class="field-type-select">${FIELD_TYPES.map(e=>`<option value="${e}" ${t.type===e?"selected":""}>${e}</option>`).join("")}</select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" ${t.visible?"checked":""}> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">🗑️</button></li>`).join("");t.querySelector("#fields-list").innerHTML=o,t.querySelector("#ghostModeCheckbox").checked=AppState.settings.ghostMode,Utils.showModal(DOM.settingsModal)},showAddTaskModal:()=>{DOM.addTaskModal.querySelector('form').reset();Utils.showModal(DOM.addTaskModal)},showLogActivityModal:()=>{DOM.logActivityModal.querySelector('form').reset();DOM.logActivityModal.querySelector("#new-activity-type").innerHTML=AppState.settings.customActivityTypes.map(t=>`<option value="${t}">${t}</option>`).join(""),DOM.logActivityModal.querySelector("#new-activity-date").value=(new Date).toISOString().split("T")[0],Utils.showModal(DOM.logActivityModal)},showAddFieldModal:()=>{DOM.addFieldModal.querySelector('form').reset();const t=[...FIELD_TYPES,"relationship"].map(t=>`<option value="${t}">${t}</option>`).join("");DOM.addFieldModal.querySelector("#new-field-type").innerHTML=t,Utils.showModal(DOM.addFieldModal)},showNewContactModal:(t={})=>{const e=DOM.newContactModal.querySelector("#new-contact-modal-body");e.innerHTML="",AppState.settings.fields.filter(t=>t.visible&&"relationship"!==t.type).forEach(o=>{const n=document.createElement("div");n.className="form-group";const s=document.createElement("label");s.setAttribute("for",`new-contact-${o.name}`),s.textContent=o.name;const c=document.createElement("input");c.type="text",c.id=`new-contact-${o.name}`,c.name=o.name,c.value=t[o.name]||"",n.appendChild(s),n.appendChild(c),e.appendChild(n)}),Utils.showModal(DOM.newContactModal)},renderTaskView:()=>{const t=AppState.tasks.filter(t=>"Completed"!==t.status),e=AppState.tasks.filter(t=>"Completed"===t.status);DOM.allTasksList.innerHTML=`<div class="task-list-section"><h3>To-Do</h3>${UI.renderTaskList(null,t)}</div><details class="task-list-section"><summary><h3>Completed (${e.length})</h3></summary>${UI.renderTaskList(null,e)}</details>`},renderTaskList:(t,e)=>{let o=e||AppState.tasks;null!==t&&(o=o.filter(e=>e.sparrow_contact_id===t));const n=t=>t.dueDate?new Date(t.dueDate).getTime():Infinity;o.sort((t,e)=>{const o=n(t),s=n(e);return o===s?t.title.localeCompare(e.title):o-s});return`<ul class="item-list">${o.map(e=>{const o="Completed"===e.status,n=o?"⟲":"✓",s=null===t&&e.sparrow_contact_id?AppState.contacts.find(t=>t.sparrow_contact_id===e.sparrow_contact_id):null,c=s?`<a href="#${s.sparrow_contact_id}" class="task-contact-link">${Utils.getContactDisplayName(s)}</a>`:"";return`<li data-task-id="${e.sparrow_task_id}"><span class="item-actions"><button data-action="toggle-task" title="Mark ${o?"Incomplete":"Complete"}">${n}</button></span><span class="item-title" style="${o?"text-decoration:line-through;opacity:0.6;":""}">${e.title}</span><span class="item-contact">${c}</span><span class="item-date" data-action="edit-task-date">${e.dueDate?Utils.formatFieldValue(e.dueDate,"date"):"No date"}</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">🗑️</button></span></li>`}).join("")}</ul>`},renderActivityList:t=>{const e=AppState.activities.filter(e=>e.sparrow_contact_id===t);return`<ul class="item-list">${e.map(t=>`<li data-activity-id="${t.sparrow_activity_id}"><span class="item-title"><strong>${t.type}:</strong> ${t.description}</span><span class="item-date">${Utils.formatFieldValue(t.date,"date")}</span><span class="item-actions"><button data-action="delete-activity" title="Delete Activity">🗑️</button></span></li>`).join("")}</ul>`}};
    const Events={init:()=>{Events.populateDomObject();const t=()=>DOM.csvFileInput.click();DOM.importCsvWelcomeBtn.addEventListener("click",t),DOM.importCsvHeaderBtn.addEventListener("click",t),DOM.addManualBtn.addEventListener('click',()=>UI.showNewContactModal()),DOM.addFromSignatureBtn.addEventListener('click',()=>Utils.showModal(DOM.signatureModal)),DOM.csvFileInput.addEventListener("change",Events.handleFileSelect),DOM.fileDropZone.addEventListener("dragover",Events.handleDragOver),DOM.fileDropZone.addEventListener("dragleave",Events.handleDragLeave),DOM.fileDropZone.addEventListener("drop",Events.handleDrop),DOM.mainSearchInput.addEventListener("input",Utils.debounce(()=>{const t=DOM.mainSearchInput.value,e=new URL(window.location);t?e.searchParams.set("q",t):e.searchParams.delete("q"),history.replaceState(null,"",e.toString()),UI.renderContactGrid()},300)),document.querySelector(".actions-area .dropdown").addEventListener("click",t=>{const e=t.target.dataset.exportType;e&&Core.exportData(e)}),DOM.settingsBtn.addEventListener("click",UI.renderSettingsModal),DOM.tasksBtn.addEventListener("click",()=>{DOM.taskSidebar.classList.add('visible');UI.renderTaskView()}),DOM.closeTaskSidebarBtn.addEventListener('click',()=>DOM.taskSidebar.classList.remove('visible')),DOM.addGlobalTaskBtn.addEventListener('click',()=>UI.showAddTaskModal()),DOM.saveNowBtn.addEventListener("click",Core.saveData),DOM.loadMoreBtn.addEventListener("click",()=>UI.renderContactGrid(!0)),document.body.addEventListener("click",t=>{t.target.classList.contains("modal-close-btn")&&Utils.hideModal(t.target.closest(".modal"))}),DOM.settingsModal.addEventListener("click",Events.handleSettingsModalClick),DOM.contactGrid.addEventListener("click",t=>{const e=t.target.closest(".contact-card");e&&(window.location.hash=e.dataset.contactId)}),DOM.taskSidebar.addEventListener("click",Events.handleTaskScreenClick),DOM.taskSidebar.addEventListener("focusout",Events.handleContactModalFocusOut),window.addEventListener("hashchange",()=>{const t=window.location.hash.substring(1),e=DOM.contactDetailModal.classList.contains("visible"),o=AppState.contacts.find(e=>e.sparrow_contact_id===t);t&&o?e||UI.renderContactModal(t):!t&&e&&Utils.hideModal(DOM.contactDetailModal)}),window.addEventListener("beforeunload",t=>{if(AppState.ui.unsavedChanges)return t.preventDefault(),t.returnValue=""})},populateDomObject:()=>{DOM={welcomeScreen:document.getElementById("welcomeScreen"),appScreen:document.getElementById("appScreen"),taskSidebar:document.getElementById('task-sidebar'),importCsvWelcomeBtn:document.getElementById("import-csv-btn-welcome"),importCsvHeaderBtn:document.getElementById("import-csv-btn-header"),addManualBtn:document.getElementById('add-manual-btn'),addFromSignatureBtn:document.getElementById('add-from-signature-btn'),csvFileInput:document.getElementById("csv-file-input"),fileDropZone:document.getElementById("file-drop-zone"),contactGrid:document.getElementById("contactGrid"),mainSearchInput:document.getElementById("main-search-input"),contactDetailModal:document.getElementById("contactDetailModal"),settingsModal:document.getElementById("settingsModal"),settingsBtn:document.getElementById("settings-btn"),tasksBtn:document.getElementById('tasks-btn'),closeTaskSidebarBtn:document.getElementById('close-task-sidebar-btn'),addGlobalTaskBtn:document.getElementById('add-global-task-btn'),allTasksList:document.getElementById('all-tasks-list'),saveReminder:document.getElementById("save-reminder"),saveReminderText:document.getElementById("save-reminder-text"),saveNowBtn:document.getElementById("save-now-btn"),loadMoreContainer:document.getElementById("loadMoreContainer"),loadMoreBtn:document.getElementById("loadMoreBtn"),ghostModeCheckbox:document.getElementById("ghostModeCheckbox"),notificationContainer:document.getElementById("notification-container"),confirmModal:{el:document.getElementById("confirmModal"),title:document.getElementById("confirm-title"),message:document.getElementById("confirm-message"),okBtn:document.getElementById("confirm-ok-btn"),cancelBtn:document.getElementById("confirm-cancel-btn")},signatureModal:document.getElementById("signature-modal"),newContactModal:document.getElementById("newContactModal"),addTaskModal:document.getElementById("addTaskModal"),logActivityModal:document.getElementById("logActivityModal"),addFieldModal:document.getElementById("addFieldModal")}},handleFileSelect:t=>{const e=t.target.files[0];e&&Events.readFile(e),t.target.value=""},handleDragOver:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.add("dragover")},handleDragLeave:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.remove("dragover")},handleDrop:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.remove("dragover");const e=t.dataTransfer.files[0];e&&("text/csv"===e.type||e.name.endsWith(".csv"))?Events.readFile(e):UI.showNotification("Please drop a valid .csv file.","danger")},readFile:t=>{const e=new FileReader;e.onload=e=>{try{const o=Core.parseCSV(e.target.result);o.length>0?Core.processCSVData(o):UI.showNotification("CSV file is empty or could not be parsed.","danger")}catch(e){console.error(`${LOG_PREFIX} Error processing file:`,e),UI.showNotification(`Error processing file: ${e.message}`,"danger")}},e.readAsText(t)},handleSettingsModalClick:t=>{const e=t.target.closest("button");if(!e)return;if("save-settings-btn"===e.id){const t=[];return DOM.settingsModal.querySelectorAll("#fields-list li").forEach((e,o)=>{const n=e.dataset.fieldName,s=AppState.settings.fields.find(t=>t.name===n);s&&t.push({...s,type:e.querySelector(".field-type-select").value,visible:e.querySelector(".field-visibility-toggle").checked,order:o})}),AppState.settings.fields=t,AppState.settings.ghostMode=DOM.settingsModal.querySelector("#ghostModeCheckbox").checked,AppState.settings.ghostMode&&(localStorage.removeItem("sparrow-crm-state"),UI.showNotification("Ghost Mode On: Session restore is disabled.","info")),Core.setUnsavedChanges(!0),Utils.hideModal(DOM.settingsModal),UI.renderContactGrid(),void UI.showNotification("Settings updated. Save the file to make them permanent.","success")}if("delete-all-btn"===e.id)return void Core.deleteAllData();{const o=e.dataset.action,n=e.closest("li")?.dataset.fieldName;if(!o||!n)return;let s=AppState.settings.fields;const c=s.findIndex(t=>t.name===n);if(-1===c)return;"up"===o&&c>0?([s[c],s[c-1]]=[s[c-1],s[c]]):"down"===o&&c<s.length-1?([s[c],s[c+1]]=[s[c+1],s[c]]):"delete"===o&&(Core.deleteField(n),t.stopImmediatePropagation()),s.forEach((t,e)=>t.order=e),UI.renderSettingsModal()}},handleTaskScreenClick:t=>{const e=t.target.closest("[data-action]");if(!e)return;const o=e.dataset.action,n=e.closest("li[data-task-id]")?.dataset.taskId;n&&("toggle-task"===o?Core.updateTask(n,{status:"Completed"===AppState.tasks.find(t=>t.sparrow_task_id===n).status?"To-Do":"Completed"}):"delete-task"===o&&Core.deleteTask(n))},setupContactModalEventListeners:t=>{const e=DOM.contactDetailModal.querySelector(".modal-content");e&&(e.addEventListener("click",Events.handleContactModalClick),e.addEventListener("focusout",Events.handleContactModalFocusOut),e.addEventListener("keydown",Events.handleContactModalKeyDown),e.addEventListener("input",Events.handleContactModalInput),document.getElementById("modal-save-changes-btn").addEventListener("click",Core.saveData));DOM.addTaskModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.logActivityModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.addFieldModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.newContactModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.signatureModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit)},handleModalFormSubmit:t=>{t.preventDefault();const e=t.target.id,o=window.location.hash.substring(1);if("add-task-form"===e){Core.addTask(o||null,{title:document.getElementById("new-task-title").value,dueDate:document.getElementById("new-task-due-date").value}),Utils.hideModal(DOM.addTaskModal)}else if("log-activity-form"===e){const t=document.getElementById("new-activity-date").value.split("-"),e=new Date(Date.UTC(t[0],t[1]-1,t[2])).toISOString();Core.logActivity(o,{type:document.getElementById("new-activity-type").value,description:document.getElementById("new-activity-desc").value,date:e});Utils.hideModal(DOM.logActivityModal)}else if("add-field-form"===e){const t=document.getElementById("new-field-name").value,e=document.getElementById("new-field-type").value;if("relationship"===e){const t=document.getElementById("relationship-search-results").querySelector(".selected")?.dataset.contactId;Core.addRelationship(o,t,document.getElementById("new-field-name").value)}else Core.addCustomField(o,t,e);Utils.hideModal(DOM.addFieldModal)}else if("signature-form"===e){const t=document.getElementById("signature-text-area").value;const e=Core.parseSignature(t);Utils.hideModal(DOM.signatureModal);UI.showNewContactModal(e)}else if("new-contact-form"===e){const t={};DOM.newContactModal.querySelectorAll("input").forEach(e=>{t[e.name]=e.value});Core.addContact({fields:t,tags:[]});Utils.hideModal(DOM.newContactModal)}},handleContactModalClick:t=>{const e=window.location.hash.substring(1);if(t.target.closest("#modal-delete-contact-btn"))return void Core.deleteContact(e);if(t.target.closest("#add-task-btn-modal"))return void UI.showAddTaskModal();if(t.target.closest("#log-activity-btn-modal"))return void UI.showLogActivityModal();if(t.target.closest("#add-field-btn-modal"))return void UI.showAddFieldModal();const o=t.target.closest("[data-action]");if(o){const n=o.dataset.action;if("copy"===n)return void navigator.clipboard.writeText(o.dataset.value).then(()=>UI.showNotification("Copied!","info",1500));if("edit-task-date"===n){const e=o.closest("li").dataset.taskId,s=AppState.tasks.find(t=>t.sparrow_task_id===e).dueDate||"";return o.innerHTML=`<input type="date" class="inline-edit-input" value="${s}" data-task-id="${e}">`,void o.querySelector("input").focus()}const s=o.closest("li[data-task-id]")?.dataset.taskId;if(s)return void("toggle-task"===n?Core.updateTask(s,{status:"Completed"===AppState.tasks.find(t=>t.sparrow_task_id===s).status?"To-Do":"Completed"}):"delete-task"===n&&Core.deleteTask(s));const c=o.closest("li[data-activity-id]")?.dataset.activityId;if(c&&"delete-activity"===n)return void Core.deleteActivity(c)}const n=t.target.closest(".relationship-link");if(n)return t.preventDefault(),void(window.location.hash=n.dataset.contactId);const s=t.target.closest(".detail-field-group");s&&!s.querySelector("input, textarea")&&(s.querySelector(".detail-field-value").innerHTML=`<input type="text" class="inline-edit-input" value="${AppState.contacts.find(t=>t.sparrow_contact_id===e).fields[s.dataset.fieldName]||""}" data-original-value="${AppState.contacts.find(t=>t.sparrow_contact_id===e).fields[s.dataset.fieldName]||""}">`,s.querySelector(".inline-edit-input").focus())},handleContactModalFocusOut:t=>{if(t.target.classList.contains("inline-edit-input")){const e=t.target;if(e.dataset.taskId){const o=e.dataset.taskId,n=e.value;return void Core.updateTask(o,{dueDate:n})}const o=e.parentElement,n=o.closest(".detail-field-group").dataset.fieldName,s=window.location.hash.substring(1);Core.updateContactField(s,n,e.value,e.dataset.originalValue);const c=AppState.settings.fields.find(t=>t.name===n),i=Utils.formatFieldValue(e.value,c.type);let l=`<button title="Copy" data-action="copy" data-value="${e.value}">📋</button>`;"email"===c.type?l+=`<a href="mailto:${e.value}" title="Email"><button>📧</button></a>`:"phone"===c.type&&(l+=`<a href="tel:${e.value}" title="Call"><button>📞</button></a>`),o.innerHTML=`<span class="value-text">${i}</span><div class="contextual-actions">${l}</div>`}},handleContactModalKeyDown:t=>{if(t.target.classList.contains("inline-edit-input"))if("Enter"===t.key)t.target.blur();else if("Escape"===t.key){const e=t.target;e.value=e.dataset.originalValue,t.target.blur()}},handleContactModalInput:t=>{if("new-field-type"===t.target.id)document.getElementById("relationship-creator-ui").classList.toggle("hidden","relationship"!==t.target.value);else if("relationship-search"===t.target.id){const e=t.target.value.toLowerCase(),o=document.getElementById("relationship-search-results");if(o.innerHTML="",e.length<2)return;const n=window.location.hash.substring(1),s=AppState.contacts.filter(t=>t.sparrow_contact_id!==n&&Utils.getContactDisplayName(t).toLowerCase().includes(e));s.slice(0,5).forEach(t=>{const e=document.createElement("div");e.className="relationship-search-result",e.dataset.contactId=t.sparrow_contact_id,e.textContent=Utils.getContactDisplayName(t),o.appendChild(e)})}}};
    function init(){console.log(`${LOG_PREFIX} Initializing application...`),AppState={contacts:[],tasks:[],activities:[],links:[],relationships:[],settings:{fields:[],customActivityTypes:["Phone Call","SMS","Email","Meeting"],ghostMode:!1},ui:{isFsaSupported:!1,fileHandle:null,unsavedChanges:!1,currentFilter:"",renderedContactsCount:0}},DOM={},Events.populateDomObject();let e=null;const o=document.getElementById("sparrow-data");if(o&&o.textContent.trim().length>2)try{e=JSON.parse(o.textContent)}catch(t){console.error(`${LOG_PREFIX} Failed to parse data.`,t)}else if(localStorage.getItem("sparrow-crm-state"))try{e=JSON.parse(localStorage.getItem("sparrow-crm-state"))}catch(t){console.error(`${LOG_PREFIX} Failed to parse local storage data.`,t)}e&&(AppState={...AppState,...e,ui:AppState.ui},window.addEventListener("unload",()=>{AppState.settings.ghostMode?localStorage.removeItem("sparrow-crm-state"):(()=>{const t={...AppState};delete t.ui,localStorage.setItem("sparrow-crm-state",JSON.stringify(t))})()})),Events.init(),AppState.ui.isFsaSupported="showOpenFilePicker"in window,AppState.contacts.length>0?UI.renderApp():UI.resetToWelcomeScreen();const n=new URLSearchParams(window.location.search);if(n.has("q")){const t=n.get("q");DOM.mainSearchInput.value=t,UI.renderContactGrid()}const s=window.location.hash.substring(1);s&&AppState.contacts.find(t=>t.sparrow_contact_id===s)&&UI.renderContactModal(s)}
    document.addEventListener('DOMContentLoaded', init);
    }());
    </script>

</body></html>