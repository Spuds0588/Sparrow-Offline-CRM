<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparrow CRM</title>
    <meta name="description" content="A free, private, offline-first CRM that lives in a single HTML file.">

    <!-- STYLES -->
    <style>
        :root {
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --midnight-green: #13505b; --cerulean: #0c7489; --persian-orange: #d38b5d; --golden-brown: #99621e; --uranian-blue: #b8e1ff;
            --bg-deep: var(--midnight-green); --bg-main: #1A6776; --bg-surface: #2a8ea1; --bg-inset: #104854;
            --text-primary: #f0f8ff; --text-secondary: var(--uranian-blue); --text-tertiary: #92c1de;
            --accent-primary: var(--persian-orange); --accent-primary-hover: #e6a079;
            --border-color: #3b9eaf; --border-radius: 6px;
            --shadow-color: rgba(0, 0, 0, 0.3); --shadow-md: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            --danger-color: #e53e3e; --danger-hover: #c53030; --success-color: #48bb78;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-family-sans); background-color: var(--bg-deep); color: var(--text-primary); font-size: 16px; line-height: 1.6; }
        h1, h2, h3 { margin: 0 0 0.75em 0; line-height: 1.2; color: var(--text-secondary); }
        a { color: var(--accent-primary); text-decoration: none; } a:hover { text-decoration: underline; }
        input, select, textarea, button { font-family: inherit; font-size: 1rem; color: var(--text-primary); }
        .hidden { display: none !important; }
        #app-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: var(--bg-deep); padding: 1rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; flex-wrap: wrap; gap: 1.5rem; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 0.75rem; }
        .logo-area h1 { font-size: 1.75rem; margin: 0; color: var(--text-primary); }
        .search-area { flex-grow: 1; }
        .search-bar { width: 100%; max-width: 400px; padding: 0.5rem 1rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; transition: all 0.2s ease; }
        .search-bar:focus { box-shadow: 0 0 0 3px var(--accent-primary-hover); border-color: var(--accent-primary); }
        .actions-area { display: flex; gap: 0.75rem; }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border: 1px solid transparent; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .btn:disabled { background-color: #555 !important; border-color: #666 !important; color: #999 !important; cursor: not-allowed !important; opacity: 0.7; }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-primary); border-color: var(--accent-primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); border-color: var(--accent-primary-hover); }
        .btn-secondary { background-color: var(--bg-surface); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-deep); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        #welcomeScreen { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem; text-align: center; }
        #welcomeScreen h1 { font-size: 2.5rem; } #welcomeScreen p { font-size: 1.2rem; color: var(--text-tertiary); max-width: 600px; margin-bottom: 2rem; }
        .drop-zone { border: 3px dashed var(--border-color); border-radius: 1rem; padding: 3rem; cursor: pointer; transition: all 0.2s ease; }
        .drop-zone.dragover { background-color: var(--bg-inset); border-color: var(--accent-primary); }
        #contactGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .contact-card { position: relative; background-color: var(--bg-surface); border-radius: var(--border-radius); padding: 1.25rem; box-shadow: var(--shadow-md); cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column; }
        .contact-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--accent-primary); }
        .contact-card h3 { color: var(--text-primary); margin-bottom: 0.75rem; font-size: 1.25rem; flex-shrink: 0; padding-right: 50px; }
        .contact-card-fields { flex-grow: 1; }
        .contact-card-field { font-size: 0.9rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.25rem; }
        .contact-card-field strong { color: var(--text-secondary); }
        .contact-card-tags { position: absolute; top: 1rem; right: 1rem; display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: flex-end; max-width: 50%; }
        .tag-badge { background-color: var(--bg-inset); color: var(--text-tertiary); padding: 0.1rem 0.5rem; font-size: 0.75rem; border-radius: 10px; white-space: nowrap; }
        #loadMoreContainer { margin-top: 2rem; text-align: center; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-main); margin: auto; padding: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); width: 90vw; max-width: 1400px; box-shadow: var(--shadow-md); position: relative; height: 90vh; display: flex; flex-direction: column; }
        .secondary-modal .modal-content { height: auto; width: 90%; max-width: 500px; z-index: 1010; }
        #confirmModal .modal-content, #settingsModal .modal-content { width: 90%; max-width: 800px; height: auto; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; flex-shrink: 0; }
        .modal-header .actions-area { margin-left: auto; padding-left: 2rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 1rem; -ms-overflow-style: none; scrollbar-width: none; }
        .modal-body::-webkit-scrollbar { display: none; }
        #contactDetailModal .modal-body { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; flex-shrink: 0; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; color: var(--text-tertiary); cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: var(--text-primary); }
        .detail-section { margin-bottom: 2rem; }
        .detail-section h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        #contact-fields-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 0 2rem; }
        .detail-field-group { display: grid; grid-template-columns: 150px 1fr; gap: 0.5rem 1rem; padding: 0.5rem 0; align-items: center; border-radius: 4px; border-bottom: 1px solid var(--bg-inset); cursor: pointer; }
        .detail-field-label { font-weight: 600; color: var(--text-secondary); text-align: right; padding-right: 1rem; white-space: normal; word-break: break-word; pointer-events: none; }
        .detail-field-value { position: relative; padding: 0.25rem 0.5rem; border-radius: 4px; min-height: 28px; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; pointer-events: none; }
        .detail-field-group:hover { background-color: var(--bg-inset); }
        .detail-field-group:hover .contextual-actions { opacity: 1; }
        .value-text { flex-grow: 1; }
        .contextual-actions { flex-shrink: 0; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s ease; pointer-events: all; }
        .contextual-actions button, .contextual-actions a button { background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 2px 6px; cursor: pointer; }
        .contextual-actions button:hover, .contextual-actions a button:hover { background: var(--bg-deep); }
        .inline-edit-input { width: 100%; padding: 0.25rem 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: 4px; pointer-events: all; }
        .inline-edit-input:focus { border-color: var(--accent-primary); outline: none; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: var(--text-secondary); font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); outline: none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent-primary); }
        #fields-list { list-style: none; padding: 0; }
        #fields-list li { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: var(--border-radius); }
        #fields-list li:nth-child(odd) { background-color: var(--bg-inset); }
        .field-name { flex-grow: 1; margin-left: 0.5rem; }
        .field-order-btn, .field-delete-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-tertiary); font-size: 1.2rem; line-height: 1;}
        .field-order-btn:disabled { cursor: not-allowed; opacity: 0.3; }
        .field-order-btn:hover:not(:disabled), .field-delete-btn:hover { color: var(--text-primary); background-color: var(--bg-surface); border-radius: 4px; }
        #fields-list .field-type-select { background-color: var(--bg-inset); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 0.25rem 0.5rem; color: var(--text-primary); }
        .ghost-mode-group { display: flex; align-items: center; gap: 0.5rem; }
        #delete-all-container, .danger-zone-section { margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--danger-hover); }
        #save-reminder { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--golden-brown); color: var(--text-primary); padding: 1rem; text-align: center; z-index: 500; display: flex; justify-content: center; align-items: center; gap: 1rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #save-reminder.visible { transform: translateY(0); }
        #notification-container { position: fixed; top: 85px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notification { padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); color: var(--text-primary); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .notification.visible { opacity: 1; transform: translateX(0); }
        .notification.info { background-color: var(--bg-surface); }
        .notification.success { background-color: var(--success-color); }
        .notification.danger { background-color: var(--danger-color); }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; border-radius: var(--border-radius); }
        .item-list li:nth-child(odd) { background-color: var(--bg-inset); }
        .item-list .item-title { flex-grow: 1; }
        .item-list .item-date { color: var(--text-tertiary); font-size: 0.9rem; cursor: pointer; }
        .item-list .item-actions button { background: none; border: none; cursor: pointer; padding: 4px; font-size: 1.2rem; color: var(--text-tertiary); }
        .item-list .item-actions button:hover { color: var(--text-primary); }
        .add-item-form { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
        .add-item-form .form-group { margin: 0; flex-grow: 1;}
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: var(--bg-surface); min-width: 160px; box-shadow: var(--shadow-md); z-index: 1; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .dropdown-content button { width: 100%; text-align: left; background: none; border: none; padding: 12px 16px; color: var(--text-primary); }
        .dropdown-content button:hover { background-color: var(--bg-deep); }
        .dropdown:hover .dropdown-content { display: block; }
    </style>
</head>
<body>
    <div id="notification-container"></div>
    <div id="app-wrapper">
        <div id="welcomeScreen" class=""><h1>Welcome to Sparrow CRM</h1><p>Your private, portable, and powerful offline CRM. Get started by importing your contacts from a CSV file. All data stays on your machine.</p><div id="file-drop-zone" class="drop-zone"><button id="import-csv-btn-welcome" class="btn btn-primary">Select or Drop CSV File</button><input type="file" id="csv-file-input" accept=".csv" class="hidden"></div></div>
        <div id="appScreen" class="hidden"><header><div class="logo-area"><h1>Sparrow CRM</h1></div><div class="search-area"><input type="search" id="main-search-input" class="search-bar" placeholder="Search contacts..."></div><div class="actions-area"><button id="import-csv-btn-header" class="btn btn-secondary">Import CSV</button><div class="dropdown"><button id="export-data-btn" class="btn btn-secondary">Export Data</button><div class="dropdown-content"><button data-export-type="contacts">Export Contacts</button><button data-export-type="tasks">Export Tasks</button><button data-export-type="activities">Export Activities</button></div></div><button id="settings-btn" class="btn btn-secondary">Settings</button></div></header><main><div id="contactGrid"><div class="contact-card" data-contact-id="f61949ca-fd31-46b3-b344-9077fb2b2836"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Ela Suyunova</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14266231</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $594,001.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="d4b4c469-03eb-4254-8cd4-6c8fee0e4a05"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Cheryl Lyn Aldridge</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14255943</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $168,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="134a4124-dcc0-461a-aed8-266b16f993e7"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Crystal Rose Bender</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14240610</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-22</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $225,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="c594c1dc-02b0-4153-bd0f-b8bcda543656"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Paul Courtright</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14169393</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-02</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $38,911.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="172f890b-e469-4c44-9e7e-d69060bac295"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Michael Mayers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14155731</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $191,947.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="8495fd16-eae2-4b5b-aadb-a6b03105507f"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Osvaldo Licea Pena</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14152008</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-08</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $241,544.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="c7ce518e-c1a0-4c98-a23d-f67b9c5d32ef"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Cole Bastian</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14145005</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $135,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="4cf5ee3c-f127-4457-bbc5-7def2adf844a"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Tyler Jennings Ward</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14144599</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-16</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $311,966.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="63ed732e-d44b-49d9-b194-2c417feef4c8"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Charles Gross</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14109854</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-21</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $230,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="7635b9d0-788c-4561-a790-dfc21f6139f0"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Amanda LeClair</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14107066</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $353,479.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="8c197c0c-4183-4528-9913-fb073d029b9f"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Jesus Idania Balderrama</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14097553</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $302,421.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="7bbc5133-7241-4d72-a0a4-bcafec5c7602"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Matthew Earl Hoag</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14084200</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-23</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $200,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="a187900f-2ff7-48f6-a208-66c6b12b0da1"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Kevin Roberto Berber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14067335</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $284,747.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="46028fc1-e7ba-4bed-bd16-6f9636099e3a"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Shundraus Lewers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14038850</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $360,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="b37c02f8-a36c-4814-8d82-b11aadd48814"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Clarisa Estefany Lainez Baca</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14010400</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $290,638.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="1d053261-fd0f-4f16-9f2d-af00a73eb4e4"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Glo Marissa Skurnicki</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13996270</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-23</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $279,120.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="e17e867b-6000-418d-9ee7-3929ceea283e"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Cassidy Brothers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13969733</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-20</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $152,192.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="07e82c6a-38c5-4c9f-8ab5-dd3428d58ac3"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Amanda Cooper</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13967424</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $360,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="3604b5bb-302c-430f-bd79-20dd4bc1f5d7"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Stephanie Dionne Frazier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13962857</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $135,646.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="ca505f1d-496f-4fee-a815-5987ca0fac25"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Daniel Martinez</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13954615</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-06</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $404,557.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="5c1aed7d-e34e-47af-9821-e5e69fdba200"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Hilary Rodoni</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13923484</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-05</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $350,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="08263669-27de-4c3c-8fcc-18d1dd32ef8e"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>James Oloo Onyango</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13918966</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-02</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $1,017,500.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="814f53fb-c5a4-49bc-a543-c703c75faec6"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Robert Westbrook</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13907253</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-21</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $347,310.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="d3a91be4-e5c3-48d7-a82b-a8cac2b3a829"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Aaron Cody Peltier</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13903736</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-14</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $206,060.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="49eef208-abb5-4d3a-972e-682348474b64"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Patricia M Kenny</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13839427</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-27</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $190,272.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="9bbb6560-82da-4a77-9dcd-d3cb63337616"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Michael Cade Poole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13824925</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $433,860.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="7c14ff4d-eb34-453c-8ac3-2308b90ac56c"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Scott Alan Barber</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13819143</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-05</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $390,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="0b986b6f-fc27-4dee-8373-cc62e064e7b2"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Alien Ortega Padron</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13769151</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-28</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $283,240.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="51b4dbb1-c1de-4901-b7f3-4b8e14e828c4"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Cassidy Smith</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13607539</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $240,562.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="16ed91cc-d679-41eb-9a4f-b819e25f75b5"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Bhavik Bhanderi</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13593776</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-13</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $629,625.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="c77e9b9f-eed8-4b10-a5b7-7b8ec27557ff"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>James Dean Fenton</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13543744</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $425,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="b3a59fc0-a538-4775-add6-574c12d1ee63"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Andrew Sean Goforth</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13444991</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-30</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $778,500.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="cf636c51-84bb-483b-82e0-6c04cb373f82"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Kelly L Newbill</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13412987</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-29</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $428,367.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="ad3e5eea-7dd0-4a4e-bcf8-79218c2f4e1d"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Sam Sungsoo Jun</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13205521</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-08</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $210,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="e8d86920-60b0-4d3b-987f-7cb683f38dd7"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Rose Lippincott</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12887296</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-20</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $125,125.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="133b2bec-900f-47df-bc35-cd79f76d0d9b"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Cary Robert Cole</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 12336217</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-12</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $1,539,172.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="f3e57d15-6ad1-4977-a145-3562c9549762"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Norma Sue Risch</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 11098628</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-01</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $285,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="3fb86e56-c421-4c89-b463-22e4ea938bdb"><div class="contact-card-tags"><span class="tag-badge">test</span></div><h3>Benjamin Bouchette Patin</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 10759656</div><div class="contact-card-field"><strong>Loan Funded:</strong> 2025-05-07</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $640,000.00</div><div class="contact-card-field"><strong>tags:</strong> arive</div></div></div><div class="contact-card" data-contact-id="da17366b-3844-4b4f-a55d-3c89b604aac7"><div class="contact-card-tags"><span class="tag-badge">import 2</span></div><h3>John Smith</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14171111</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/19/2025</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $486,900.00</div></div></div><div class="contact-card" data-contact-id="ccd7b87f-5c50-48d8-8e3a-5df7d66d7d0a"><div class="contact-card-tags"><span class="tag-badge">import 2</span></div><h3>Doug Duggers</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 14112222</div><div class="contact-card-field"><strong>Loan Funded:</strong> 5/14/2025</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $413,105.00</div></div></div><div class="contact-card" data-contact-id="d2a51631-0fd2-48bc-9405-832009ece2ea"><div class="contact-card-tags"><span class="tag-badge">import 2</span></div><h3>Bob Bobberson</h3><div class="contact-card-fields"><div class="contact-card-field"><strong>ARIVE Loan Id:</strong> 13733333</div><div class="contact-card-field"><strong>Loan Funded:</strong> 3/11/2025</div><div class="contact-card-field"><strong>Total Loan Amount:</strong> $210,000.00</div></div></div></div><div id="loadMoreContainer" class="hidden"><button id="loadMoreBtn" class="btn btn-secondary">Load More</button></div></main></div>
    </div>
    <!-- Main Modals -->
    <div id="contactDetailModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Ela Suyunova</h2><div class="actions-area"><button id="add-task-btn-modal" class="btn btn-secondary">+ Task</button><button id="log-activity-btn-modal" class="btn btn-secondary">+ Activity</button><button id="add-field-btn-modal" class="btn btn-secondary">+ Field</button></div><button class="modal-close-btn">√ó</button></div><div class="modal-body"><div class="main-column"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container"><div class="detail-field-group" data-field-name="Primary Borrower" title="Primary Borrower"><div class="detail-field-label">Primary Borrower</div><div class="detail-field-value"><span class="value-text">Ela Suyunova</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="Ela Suyunova">üìã</button></div></div></div><div class="detail-field-group" data-field-name="ARIVE Loan Id" title="ARIVE Loan Id"><div class="detail-field-label">ARIVE Loan Id</div><div class="detail-field-value"><span class="value-text">14266231</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="14266231">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Loan Funded" title="Loan Funded"><div class="detail-field-label">Loan Funded</div><div class="detail-field-value"><span class="value-text">2025-05-28</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="2025-05-28">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Total Loan Amount" title="Total Loan Amount"><div class="detail-field-label">Total Loan Amount</div><div class="detail-field-value"><span class="value-text">$594,001.00</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="594001">üìã</button></div></div></div><div class="detail-field-group" data-field-name="tags" title="tags"><div class="detail-field-label">tags</div><div class="detail-field-value"><span class="value-text">arive</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="arive">üìã</button></div></div></div><div class="detail-field-group" data-field-name="favorite food" title="favorite food"><div class="detail-field-label">favorite food</div><div class="detail-field-value"><span class="value-text">pineapple</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="pineapple">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Compensation Percentage" title="Compensation Percentage"><div class="detail-field-label">Compensation Percentage</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Description" title="Referral Contact Description"><div class="detail-field-label">Referral Contact Description</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Email" title="Referral Contact Email"><div class="detail-field-label">Referral Contact Email</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button><a href="mailto:" title="Email"><button>üìß</button></a></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Name" title="Referral Contact Name"><div class="detail-field-label">Referral Contact Name</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button></div></div></div><div class="detail-field-group" data-field-name="Referral Contact Phone" title="Referral Contact Phone"><div class="detail-field-label">Referral Contact Phone</div><div class="detail-field-value"><span class="value-text"></span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="">üìã</button><a href="tel:" title="Call"><button>üìû</button></a></div></div></div><div class="detail-field-group" data-field-name="Hobbies Description" title="Hobbies Description"><div class="detail-field-label">Hobbies Description</div><div class="detail-field-value"><span class="value-text">Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.  Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.</span><div class="contextual-actions"><button title="Copy" data-action="copy" data-value="Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.  Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.">üìã</button></div></div></div></div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container"></div></div><div class="danger-zone-section"><h3>Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="sidebar-column"><div class="detail-section"><h3>Tasks</h3><div id="contact-tasks-container"><ul class="item-list"><li data-task-id="fec235c8-317e-4111-b60e-bfc0fea19811"><span class="item-actions"><button data-action="toggle-task" title="Mark Incomplete">‚ü≤</button></span><span class="item-title" style="text-decoration:line-through;opacity:0.6;">test task 1</span><span class="item-date" data-action="edit-task-date">No date</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">üóëÔ∏è</button></span></li><li data-task-id="cfcd7082-394b-4a63-9efe-a0fc4246611f"><span class="item-actions"><button data-action="toggle-task" title="Mark Complete">‚úì</button></span><span class="item-title" style="">test task 2</span><span class="item-date" data-action="edit-task-date">6/16/25</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">üóëÔ∏è</button></span></li></ul></div></div><div class="detail-section"><h3>Activity Log</h3><div id="contact-activities-container"><ul class="item-list"><li data-activity-id="2dd4176b-3d07-453d-8e84-f46dbb4fa43f"><span class="item-title"><strong>Meeting:</strong> I met on the 20th</span><span class="item-date">6/19/2025</span><span class="item-actions"><button data-action="delete-activity" title="Delete Activity">üóëÔ∏è</button></span></li><li data-activity-id="db11281c-9d7e-45af-9ace-17d182822e83"><span class="item-title"><strong>SMS:</strong> I texted 6/17</span><span class="item-date">6/16/2025</span><span class="item-actions"><button data-action="delete-activity" title="Delete Activity">üóëÔ∏è</button></span></li><li data-activity-id="2d786267-ae59-4aae-b654-156af520b870"><span class="item-title"><strong>Phone Call:</strong> I called</span><span class="item-date">6/15/2025</span><span class="item-actions"><button data-action="delete-activity" title="Delete Activity">üóëÔ∏è</button></span></li></ul></div></div></div></div><div class="modal-footer"><button id="modal-save-changes-btn" class="btn btn-primary" disabled="">Save Changes</button></div></div></div>
    <div id="settingsModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Settings</h2><button class="modal-close-btn">√ó</button></div><div class="modal-body"><h3>Manage Fields</h3><p>Use arrows to reorder fields. The top-most visible field is the contact's title.</p><ul id="fields-list"><li data-field-name="Primary Borrower"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up" disabled="">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Primary Borrower</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="ARIVE Loan Id"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">ARIVE Loan Id</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Loan Funded"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Loan Funded</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Total Loan Amount"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Total Loan Amount</span><select class="field-type-select"><option value="text">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency" selected="">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="tags"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">tags</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="favorite food"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">favorite food</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Compensation Percentage"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Compensation Percentage</span><select class="field-type-select"><option value="text">text</option><option value="longtext">longtext</option><option value="number" selected="">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Referral Contact Description"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Referral Contact Description</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Referral Contact Email"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Referral Contact Email</span><select class="field-type-select"><option value="text">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email" selected="">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Referral Contact Name"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Referral Contact Name</span><select class="field-type-select"><option value="text" selected="">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Referral Contact Phone"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down">‚ñº</button></div><span class="field-name">Referral Contact Phone</span><select class="field-type-select"><option value="text">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone" selected="">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li><li data-field-name="Hobbies Description"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up">‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down" disabled="">‚ñº</button></div><span class="field-name">Hobbies Description</span><select class="field-type-select"><option value="text">text</option><option value="longtext" selected="">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option></select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" checked=""> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li></ul><h3 style="margin-top:2rem;">Data Management</h3><div class="form-group ghost-mode-group"><input type="checkbox" id="ghostModeCheckbox" style="width:auto;"><label for="ghostModeCheckbox">Ghost Mode (disables temporary session recovery)</label></div><div id="delete-all-container"><h3>Danger Zone</h3><button id="delete-all-btn" class="btn btn-danger">DELETE ALL DATA</button><p style="font-size:0.9rem;color:var(--text-tertiary);">This permanently deletes all contacts, relationships, and custom fields from this file.</p></div></div><div class="modal-footer"><button id="save-settings-btn" class="btn btn-primary">Save Settings</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="confirm-title">FINAL CONFIRMATION</h2></div><div class="modal-body"><p id="confirm-message">This is your last chance. Clicking OK will permanently erase everything.</p></div><div class="modal-footer"><button id="confirm-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-ok-btn" class="btn btn-danger">OK</button></div></div></div>
    
    <!-- Secondary Modals -->
    <div id="addTaskModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Add New Task</h2><button class="modal-close-btn">√ó</button></div><form id="add-task-form"><div class="modal-body"><div class="form-group"><label for="new-task-title">Task Title</label><input type="text" id="new-task-title" required=""></div><div class="form-group"><label for="new-task-due-date">Due Date (Optional)</label><input type="date" id="new-task-due-date"></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Add Task</button></div></form></div></div>
    <div id="logActivityModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Log Activity</h2><button class="modal-close-btn">√ó</button></div><form id="log-activity-form"><div class="modal-body"><div class="form-group"><label for="new-activity-type">Activity Type</label><select id="new-activity-type"><option value="Phone Call">Phone Call</option><option value="SMS">SMS</option><option value="Email">Email</option><option value="Meeting">Meeting</option></select></div><div class="form-group"><label for="new-activity-desc">Description</label><input type="text" id="new-activity-desc" required=""></div><div class="form-group"><label for="new-activity-date">Date</label><input type="date" id="new-activity-date" required=""></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Log Activity</button></div></form></div></div>
    <div id="addFieldModal" class="modal secondary-modal"><div class="modal-content"><div class="modal-header"><h2>Add New Field / Relationship</h2><button class="modal-close-btn">√ó</button></div><form id="add-field-form"><div class="modal-body"><div class="form-group"><label for="new-field-name">Field Name / Relationship Label</label><input type="text" id="new-field-name" placeholder="e.g., Birthday or Spouse" required=""></div><div class="form-group"><label for="new-field-type">Type</label><select id="new-field-type"><option value="text">text</option><option value="longtext">longtext</option><option value="number">number</option><option value="date">date</option><option value="phone">phone</option><option value="email">email</option><option value="url">url</option><option value="boolean">boolean</option><option value="currency">currency</option><option value="relationship">relationship</option></select></div><div id="relationship-creator-ui" class="hidden" style="margin-top:1rem;"><div class="form-group"><label for="relationship-search">Find Contact to Link</label><input type="text" id="relationship-search" placeholder="Start typing a name..."><div id="relationship-search-results" class="relationship-search-results"></div></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Add</button></div></form></div></div>

    <div id="save-reminder" class=""><span id="save-reminder-text">You have unsaved changes.</span><button id="save-now-btn" class="btn btn-primary">Save Now</button></div>
    
    <script id="sparrow-data" type="application/json">{
  "contacts": [],
  "tasks": [],
  "activities": [],
  "links": [],
  "relationships": [],
  "settings": {
    "fields": [],
    "customActivityTypes": [
      "Phone Call",
      "SMS",
      "Email",
      "Meeting"
    ],
    "ghostMode": false
  }
}</script>
    <script>
    (function() {
        "use strict";
        // --- CONSTANTS & GLOBALS ---
        const LOG_PREFIX = '[SparrowCRM]', CONTACTS_PER_PAGE = 50, FIELD_TYPES = ['text', 'longtext', 'number', 'date', 'phone', 'email', 'url', 'boolean', 'currency'], RELATIONSHIP_FIELD_TYPE = 'relationship';
        let AppState, DOM;

        // --- UTILITY FUNCTIONS ---
        const Utils = {
            generateUUID: () => crypto.randomUUID(),
            showModal: (modal) => modal.classList.add("visible"),
            hideModal: (modal) => {
                modal.classList.remove("visible");
                if (modal.id === 'contactDetailModal') {
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            },
            debounce: (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; },
            showConfirm: (title, message, okClass = 'btn-primary') => {
                return new Promise((resolve) => {
                    DOM.confirmModal.title.textContent = title; DOM.confirmModal.message.textContent = message;
                    DOM.confirmModal.okBtn.className = `btn ${okClass}`; Utils.showModal(DOM.confirmModal.el);
                    const okHandler = () => { cleanup(); resolve(true); }; const cancelHandler = () => { cleanup(); resolve(false); };
                    DOM.confirmModal.okBtn.addEventListener('click', okHandler); DOM.confirmModal.cancelBtn.addEventListener('click', cancelHandler);
                    function cleanup() { Utils.hideModal(DOM.confirmModal.el); DOM.confirmModal.okBtn.removeEventListener('click', okHandler); DOM.confirmModal.cancelBtn.removeEventListener('click', cancelHandler); }
                });
            },
            formatFieldValue: (value, type) => {
                if (value === null || value === undefined || value === '') return '';
                switch (type) {
                    case 'currency': { const num = parseFloat(String(value).replace(/[^0-9.-]+/g,"")); return isNaN(num) ? value : new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(num); }
                    case 'date': { if(!value) return ''; const d = new Date(value); if (d instanceof Date && !isNaN(d.getTime())) { const utcDate = new Date(d.valueOf() + d.getTimezoneOffset() * 60000); return utcDate.toLocaleDateString('en-US',{year:'2-digit',month:'numeric',day:'numeric'}); } return value; }
                    default: return value;
                }
            },
            getContactDisplayName: (contact) => {
                if (!contact) return "Unknown Contact";
                const sortedVisibleFields = AppState.settings.fields.filter(f => f.visible).sort((a, b) => a.order - b.order);
                if (sortedVisibleFields.length > 0) { const primaryFieldName = sortedVisibleFields[0].name; const primaryValue = contact.fields[primaryFieldName]; if (primaryValue) return primaryValue; }
                const firstName = contact.fields['First Name'] || contact.fields.firstName || ''; const lastName = contact.fields['Last Name'] || contact.fields.lastName || '';
                const fullName = `${firstName} ${lastName}`.trim(); if (fullName) return fullName;
                const email = contact.fields['Email'] || contact.fields.email || ''; if (email) return email;
                return `Contact ${contact.sparrow_contact_id.substring(0, 8)}`;
            }
        };
        
        // --- CORE LOGIC (DATA MANIPULATION) ---
        const Core = {
            setUnsavedChanges: (status) => {
                if (AppState.ui.unsavedChanges === status) return;
                AppState.ui.unsavedChanges = status;
                DOM.saveReminder.classList.toggle('visible', status);
                const contactModalSaveBtn = document.getElementById('modal-save-changes-btn');
                if(contactModalSaveBtn) {
                    contactModalSaveBtn.disabled = !status;
                    contactModalSaveBtn.textContent = AppState.ui.fileHandle ? "Save Changes" : "Grant Permission & Save";
                }
                if(status) {
                    if(AppState.ui.isFsaSupported) {
                        if (AppState.ui.fileHandle) { DOM.saveReminderText.textContent = "You have unsaved changes."; DOM.saveNowBtn.textContent = "Save Now"; }
                        else { DOM.saveReminderText.textContent = "To enable one-click saving, grant permission to edit this file."; DOM.saveNowBtn.textContent = "Grant Permission & Save"; }
                    } else { DOM.saveReminderText.textContent = "You have unsaved changes. Download a new copy to save."; DOM.saveNowBtn.textContent = "Download & Save"; }
                }
            },
            parseCSV: (text) => {
                const result=[],lines=text.trim().split(/\r\n|\n/),headers=lines[0].split(",").map(h=>h.trim().replace(/"/g,""));
                for(let i=1;i<lines.length;i++){const line=lines[i];if(!line.trim())continue;const values=[];let currentVal="",inQuotes=!1;for(let char of line){if(char==='"')inQuotes=!inQuotes;else if(char===","&&!inQuotes)values.push(currentVal.trim()),currentVal="";else currentVal+=char}values.push(currentVal.trim());if(values.every(v=>v==="")){console.log(`${LOG_PREFIX} Skipping empty row at line ${i+1}.`);continue}if(values.length===headers.length){const obj={};for(let j=0;j<headers.length;j++)obj[headers[j]]=values[j].replace(/^"|"$/g,"").replace(/""/g,'"');result.push(obj)}else console.warn(`${LOG_PREFIX} Mismatched row length at line ${i+1}. Skipping.`)}
                console.log(`${LOG_PREFIX} Parsed ${result.length} rows.`);return result;
            },
            processCSVData: async (data) => {
                const importTag=prompt("Enter a tag for this import (e.g., 'Leads'). Leave blank for none.",""),newHeaders=Object.keys(data[0]);newHeaders.forEach(h=>{if(!AppState.settings.fields.find(f=>f.name===h))AppState.settings.fields.push({name:h,type:"text",visible:!0,order:AppState.settings.fields.length})});AppState.contacts.forEach(c=>{newHeaders.forEach(h=>{if(!c.fields.hasOwnProperty(h))Object.assign(c.fields,{[h]:""})})});for(const row of data){let existingContact=null;if(row.sparrow_contact_id)existingContact=AppState.contacts.find(c=>c.sparrow_contact_id===row.sparrow_contact_id);if(!existingContact&&row.Email){const m=AppState.contacts.filter(c=>c.fields.Email&&c.fields.Email.toLowerCase()===row.Email.toLowerCase());if(m.length===1)existingContact=m[0]}if(existingContact){if(await Utils.showConfirm("Update Contact?",`Found existing contact for '${Utils.getContactDisplayName(existingContact)}'. Update with new data?`)){Object.entries(row).forEach(([k,v])=>{if(v!==null&&v!=="")existingContact.fields[k]=v});if(importTag&&!existingContact.tags.includes(importTag))existingContact.tags.push(importTag)}}else{const newContact={sparrow_contact_id:Utils.generateUUID(),tags:importTag?[importTag]:[],fields:{}};AppState.settings.fields.forEach(f=>{newContact.fields[f.name]=row[f.name]||""});AppState.contacts.push(newContact)}}Core.setUnsavedChanges(!0);UI.renderApp();
            },
            saveData: async () => {
                DOM.saveReminder.classList.remove('visible'); const savingNotifId = UI.showNotification('Saving...', 'info', 0);
                try {
                    if (AppState.ui.isFsaSupported) {
                        if (!AppState.ui.fileHandle) { AppState.ui.fileHandle = await window.showSaveFilePicker({ types: [{ description: 'Sparrow CRM File', accept: {'text/html': ['.html']} }] }); }
                        const writable = await AppState.ui.fileHandle.createWritable(); await writable.write(Core.generateHtmlToSave()); await writable.close();
                        Core.setUnsavedChanges(false); UI.showNotification('File saved successfully.', 'success');
                    } else {
                        const blob = new Blob([Core.generateHtmlToSave()],{type:'text/html'}), a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sparrow-crm-data.html'; a.click(); a.remove(); URL.revokeObjectURL(a.href);
                        Core.setUnsavedChanges(false); UI.showNotification('File downloaded successfully.', 'success');
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') { console.error(`${LOG_PREFIX} Error saving file:`, err); UI.showNotification(`Error saving file: ${err.message}`, 'danger'); }
                    else { UI.showNotification('Save cancelled.', 'info'); }
                } finally { UI.hideNotification(savingNotifId); }
            },
            generateHtmlToSave: () => {
                const docClone = document.cloneNode(true);
                const notificationContainerClone = docClone.getElementById('notification-container');
                if (notificationContainerClone) { notificationContainerClone.innerHTML = ''; }
                const dataToSave = { ...AppState }; delete dataToSave.ui;
                const jsonString = JSON.stringify(dataToSave, null, 2);
                const scriptTagClone = docClone.getElementById('sparrow-data');
                scriptTagClone.textContent = jsonString;
                return `<!DOCTYPE html>\n` + docClone.documentElement.outerHTML;
            },
            generateCSVString: (dataType) => {
                const data = AppState[dataType];
                if(!data || data.length === 0) return "";
                let headers, rows;
                if(dataType === 'contacts') {
                    headers = AppState.settings.fields.map(f => f.name);
                    if(!headers.includes('sparrow_contact_id')) headers.unshift('sparrow_contact_id');
                    if(!headers.includes('tags')) headers.push('tags');
                    rows = data.map(contact => headers.map(header => {
                        if (header === 'sparrow_contact_id') return contact.sparrow_contact_id;
                        if (header === 'tags') return contact.tags.join(';');
                        return contact.fields[header] || '';
                    }));
                } else {
                    headers = Object.keys(data[0]);
                    rows = data.map(item => headers.map(header => item[header] || ''));
                }
                const csvRows = [headers.join(',')];
                rows.forEach(row => {
                    const values = row.map(value => {
                        const stringValue = String(value);
                        if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                            return `"${stringValue.replace(/"/g,'""')}"`;
                        }
                        return stringValue;
                    });
                    csvRows.push(values.join(','))
                });
                return csvRows.join('\n');
            },
            exportData: (dataType) => {
                const csvString = Core.generateCSVString(dataType);
                if(!csvString){ UI.showNotification(`No ${dataType} to export.`,"info"); return }
                const blob = new Blob([csvString],{type:"text/csv;charset=utf-8;"}), a = document.createElement("a");
                a.href = URL.createObjectURL(blob); a.download = `sparrow-crm-${dataType}-${new Date().toISOString().split("T")[0]}.csv`;
                a.click(); a.remove(); URL.revokeObjectURL(a.href);
            },
            updateContactField: (contactId, fieldName, newValue, originalValue) => { if (newValue === originalValue) { return; } const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); if (contact) { contact.fields[fieldName] = newValue; Core.setUnsavedChanges(true); } },
            addTask: (contactId, taskData) => { const newTask = {sparrow_task_id: Utils.generateUUID(), sparrow_contact_id: contactId, title: taskData.title, dueDate: taskData.dueDate, status: 'To-Do'}; AppState.tasks.push(newTask); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); },
            updateTask: (taskId, newValues) => { const task = AppState.tasks.find(t => t.sparrow_task_id === taskId); if(task) { Object.assign(task, newValues); Core.setUnsavedChanges(true); UI.renderContactModal(task.sparrow_contact_id); } },
            deleteTask: async(taskId) => { const task = AppState.tasks.find(t => t.sparrow_task_id === taskId); if (!task) return; if (await Utils.showConfirm("Delete Task?", `Are you sure you want to delete the task: "${task.title}"?`, 'btn-danger')) { const contactId = task.sparrow_contact_id; AppState.tasks = AppState.tasks.filter(t => t.sparrow_task_id !== taskId); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); } },
            logActivity: (contactId, activityData) => { const newActivity = {sparrow_activity_id: Utils.generateUUID(), sparrow_contact_id: contactId, type: activityData.type, date: activityData.date, description: activityData.description,}; AppState.activities.unshift(newActivity); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); },
            deleteActivity: async(activityId) => { const activity = AppState.activities.find(a => a.sparrow_activity_id === activityId); if (!activity) return; if (await Utils.showConfirm("Delete Activity Log?", `Are you sure you want to delete this ${activity.type} log from ${new Date(activity.date).toLocaleDateString()}?`, 'btn-danger')) { const contactId = activity.sparrow_contact_id; AppState.activities = AppState.activities.filter(a => a.sparrow_activity_id !== activityId); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); } },
            addCustomField: (contactId, newFieldName, newFieldType) => { if (!newFieldName || AppState.settings.fields.find(f => f.name.toLowerCase() === newFieldName.toLowerCase())) { UI.showNotification(`Field "${newFieldName}" already exists or name is empty.`, "danger"); return; } AppState.settings.fields.push({ name: newFieldName, type: newFieldType, visible: true, order: AppState.settings.fields.length }); AppState.contacts.forEach(c => { c.fields[newFieldName] = ''; }); Core.setUnsavedChanges(true); UI.renderContactModal(contactId); },
            addRelationship: (sourceId, targetId, label) => { if (!targetId || !label) { UI.showNotification("Please select a contact and provide a relationship label.", "danger"); return; } const newRelationship = { sparrow_relationship_id: Utils.generateUUID(), source_contact_id: sourceId, target_contact_id: targetId, label: label }; AppState.relationships.push(newRelationship); Core.setUnsavedChanges(true); UI.renderContactModal(sourceId); },
            deleteContact: async (contactId) => { const contact = AppState.contacts.find(c => c.sparrow_contact_id === contactId); if (await Utils.showConfirm("Delete Contact?", `Are you sure you want to permanently delete ${Utils.getContactDisplayName(contact)}? This action cannot be undone.`, 'btn-danger')) { AppState.contacts = AppState.contacts.filter(c => c.sparrow_contact_id !== contactId); AppState.relationships = AppState.relationships.filter(r => r.source_contact_id !== contactId && r.target_contact_id !== contactId); Core.setUnsavedChanges(true); Utils.hideModal(DOM.contactDetailModal); UI.renderApp(); } },
            deleteField: async(fieldName) => { if (await Utils.showConfirm("Delete Field?", `Are you sure you want to permanently delete the field "${fieldName}"? This will remove the field and all its data from every contact.`, 'btn-danger')) { AppState.settings.fields = AppState.settings.fields.filter(f => f.name !== fieldName).map((f, i) => ({...f, order: i})); AppState.contacts.forEach(contact => { delete contact.fields[fieldName]; }); Core.setUnsavedChanges(true); UI.renderSettingsModal(); UI.showNotification(`Field "${fieldName}" deleted.`, "success"); } },
            deleteAllData: async() => { if (!(await Utils.showConfirm("DELETE ALL DATA?","This action will erase all contacts, relationships, and custom fields from this file.","btn-danger"))) return; if (await Utils.showConfirm("FINAL CONFIRMATION", "This is your last chance. Clicking OK will permanently erase everything.", "btn-danger")) { AppState.contacts = []; AppState.tasks = []; AppState.activities = []; AppState.links = []; AppState.relationships = []; AppState.settings.fields = []; UI.resetToWelcomeScreen(); if (AppState.ui.fileHandle) { await Core.saveData(); UI.showNotification("All data deleted and file updated.", "success"); } else { Core.setUnsavedChanges(true); UI.showNotification("All data has been deleted. Save the file to make it permanent.", "success"); } } else { UI.showNotification("Delete cancelled.", "info"); } }
        };
        const UI={showNotification:(t,e="info",o=3e3)=>{const n="notif-"+Utils.generateUUID(),s=document.createElement("div");return s.id=n,s.className=`notification ${e}`,s.textContent=t,DOM.notificationContainer.appendChild(s),setTimeout(()=>s.classList.add("visible"),10),o>0&&setTimeout(()=>UI.hideNotification(n),o),n},hideNotification:t=>{const e=document.getElementById(t);e&&(e.classList.remove("visible"),e.addEventListener("transitionend",()=>e.remove()))},resetToWelcomeScreen:()=>{Utils.hideModal(DOM.settingsModal),DOM.appScreen.classList.add("hidden"),DOM.welcomeScreen.classList.remove("hidden")},renderApp:()=>{DOM.welcomeScreen.classList.add("hidden"),DOM.appScreen.classList.remove("hidden"),UI.renderContactGrid()},renderContactGrid:(t=!1)=>{const e=DOM.mainSearchInput.value.toLowerCase();e===AppState.ui.currentFilter&&t||(AppState.ui.currentFilter=e,AppState.ui.renderedContactsCount=0,DOM.contactGrid.innerHTML="");const o=AppState.contacts.filter(t=>Object.values(t.fields).some(t=>String(t).toLowerCase().includes(e))||t.tags.some(t=>t.toLowerCase().includes(e))),n=AppState.settings.fields.filter(t=>t.visible).sort((t,e)=>t.order-e.order).slice(1,5),s=o.slice(AppState.ui.renderedContactsCount,AppState.ui.renderedContactsCount+CONTACTS_PER_PAGE),c=document.createDocumentFragment();s.forEach(t=>{const e=document.createElement("div");e.className="contact-card",e.dataset.contactId=t.sparrow_contact_id;const o=`<div class="contact-card-tags">${t.tags.map(t=>`<span class="tag-badge">${t}</span>`).join("")}</div>`;let s=`${o}<h3>${Utils.getContactDisplayName(t)}</h3><div class="contact-card-fields">`;n.forEach(e=>{const o=t.fields[e.name];o&&(s+=`<div class="contact-card-field"><strong>${e.name}:</strong> ${Utils.formatFieldValue(o,e.type)}</div>`)}),e.innerHTML=s+"</div>",c.appendChild(e)}),DOM.contactGrid.appendChild(c),AppState.ui.renderedContactsCount+=s.length,DOM.loadMoreContainer.classList.toggle("hidden",AppState.ui.renderedContactsCount>=o.length)},renderContactModal:t=>{const e=AppState.contacts.find(e=>e.sparrow_contact_id===t);if(!e)return;const o=AppState.settings.fields.sort((t,e)=>t.order-e.order),n=o.map(t=>{if(!t.visible)return"";const o=e.fields[t.name]||"",n=Utils.formatFieldValue(o,t.type);let s=`<button title="Copy" data-action="copy" data-value="${o}">üìã</button>`;return"email"===t.type?s+=`<a href="mailto:${o}" title="Email"><button>üìß</button></a>`:"phone"===t.type&&(s+=`<a href="tel:${o}" title="Call"><button>üìû</button></a>`),`<div class="detail-field-group" data-field-name="${t.name}" title="${t.name}"><div class="detail-field-label">${t.name}</div><div class="detail-field-value"><span class="value-text">${n}</span><div class="contextual-actions">${s}</div></div></div>`}).join(""),s=AppState.relationships.filter(e=>e.source_contact_id===t).map(t=>{const o=AppState.contacts.find(e=>e.sparrow_contact_id===t.target_contact_id);return`<div class="detail-field-group"><div class="detail-field-label" title="${t.label}">${t.label}</div><div class="detail-field-value" style="pointer-events:all;cursor:default"><a href="#${t.target_contact_id}" class="relationship-link">${Utils.getContactDisplayName(o)}</a></div></div>`}).join(""),c=AppState.tasks.filter(e=>e.sparrow_contact_id===t).sort((t,e)=>new Date(t.dueDate)-new Date(e.dueDate)),i=`<ul class="item-list">${c.map(t=>{const e="Completed"===t.status,o=e?"‚ü≤":"‚úì";return`<li data-task-id="${t.sparrow_task_id}"><span class="item-actions"><button data-action="toggle-task" title="Mark ${e?"Incomplete":"Complete"}">${o}</button></span><span class="item-title" style="${e?"text-decoration:line-through;opacity:0.6;":""}">${t.title}</span><span class="item-date" data-action="edit-task-date">${t.dueDate?Utils.formatFieldValue(t.dueDate,'date'):"No date"}</span><span class="item-actions"><button data-action="delete-task" title="Delete Task">üóëÔ∏è</button></span></li>`}).join("")}</ul>`,l=AppState.activities.filter(e=>e.sparrow_contact_id===t),a=`<ul class="item-list">${l.map(t=>`<li data-activity-id="${t.sparrow_activity_id}"><span class="item-title"><strong>${t.type}:</strong> ${t.description}</span><span class="item-date">${new Date(t.date).toLocaleDateString()}</span><span class="item-actions"><button data-action="delete-activity" title="Delete Activity">üóëÔ∏è</button></span></li>`).join("")}</ul>`,d=AppState.ui.fileHandle?"Save Changes":"Grant Permission & Save",r=`<div class="modal-header"><h2>${Utils.getContactDisplayName(e)}</h2><div class="actions-area"><button id="add-task-btn-modal" class="btn btn-secondary">+ Task</button><button id="log-activity-btn-modal" class="btn btn-secondary">+ Activity</button><button id="add-field-btn-modal" class="btn btn-secondary">+ Field</button></div><button class="modal-close-btn">&times;</button></div><div class="modal-body"><div class="main-column"><div class="detail-section"><h3>Contact Details</h3><div id="contact-fields-container">${n}</div></div><div class="detail-section"><h3>Relationships</h3><div id="contact-relationships-container">${s}</div></div><div class="danger-zone-section"><h3>Danger Zone</h3><button id="modal-delete-contact-btn" class="btn btn-danger">Delete This Contact</button></div></div><div class="sidebar-column"><div class="detail-section"><h3>Tasks</h3><div id="contact-tasks-container">${i}</div></div><div class="detail-section"><h3>Activity Log</h3><div id="contact-activities-container">${a}</div></div></div></div><div class="modal-footer"><button id="modal-save-changes-btn" class="btn btn-primary" disabled>${d}</button></div>`;DOM.contactDetailModal.querySelector(".modal-content").innerHTML=r,Events.setupContactModalEventListeners(t),Utils.showModal(DOM.contactDetailModal)},renderSettingsModal:()=>{const t=DOM.settingsModal.querySelector(".modal-content"),e=AppState.settings.fields.sort((t,e)=>t.order-e.order),o=e.map((t,o)=>`<li data-field-name="${t.name}"><div class="field-order-controls" style="display:flex;flex-direction:column;"><button class="field-order-btn" data-action="up" title="Move Up" ${0===o?"disabled":""}>‚ñ≤</button><button class="field-order-btn" data-action="down" title="Move Down" ${o===e.length-1?"disabled":""}>‚ñº</button></div><span class="field-name">${t.name}</span><select class="field-type-select">${FIELD_TYPES.map(e=>`<option value="${e}" ${t.type===e?"selected":""}>${e}</option>`).join("")}</select><label style="display:flex;align-items:center;gap:0.25rem;"><input type="checkbox" class="field-visibility-toggle" ${t.visible?"checked":""}> Visible</label><button class="field-delete-btn" data-action="delete" title="Delete Field">üóëÔ∏è</button></li>`).join("");t.querySelector("#fields-list").innerHTML=o,t.querySelector("#ghostModeCheckbox").checked=AppState.settings.ghostMode,Utils.showModal(DOM.settingsModal)},showAddTaskModal:()=>{DOM.addTaskModal.querySelector('form').reset();Utils.showModal(DOM.addTaskModal)},showLogActivityModal:()=>{DOM.logActivityModal.querySelector('form').reset();DOM.logActivityModal.querySelector("#new-activity-type").innerHTML=AppState.settings.customActivityTypes.map(t=>`<option value="${t}">${t}</option>`).join(""),DOM.logActivityModal.querySelector("#new-activity-date").value=(new Date).toISOString().split("T")[0],Utils.showModal(DOM.logActivityModal)},showAddFieldModal:()=>{DOM.addFieldModal.querySelector('form').reset();const t=[...FIELD_TYPES,"relationship"].map(t=>`<option value="${t}">${t}</option>`).join("");DOM.addFieldModal.querySelector("#new-field-type").innerHTML=t,Utils.showModal(DOM.addFieldModal)}};
    const Events={init:()=>{Events.populateDomObject();const t=()=>DOM.csvFileInput.click();DOM.importCsvWelcomeBtn.addEventListener("click",t),DOM.importCsvHeaderBtn.addEventListener("click",t),DOM.csvFileInput.addEventListener("change",Events.handleFileSelect),DOM.fileDropZone.addEventListener("dragover",Events.handleDragOver),DOM.fileDropZone.addEventListener("dragleave",Events.handleDragLeave),DOM.fileDropZone.addEventListener("drop",Events.handleDrop),DOM.mainSearchInput.addEventListener("input",Utils.debounce(()=>{const t=DOM.mainSearchInput.value,e=new URL(window.location);t?e.searchParams.set("q",t):e.searchParams.delete("q"),history.replaceState(null,"",e.toString()),UI.renderContactGrid()},300)),document.querySelector(".actions-area .dropdown").addEventListener("click",t=>{const e=t.target.dataset.exportType;e&&Core.exportData(e)}),DOM.settingsBtn.addEventListener("click",UI.renderSettingsModal),DOM.saveNowBtn.addEventListener("click",Core.saveData),DOM.loadMoreBtn.addEventListener("click",()=>UI.renderContactGrid(!0)),document.body.addEventListener("click",t=>{t.target.classList.contains("modal-close-btn")&&Utils.hideModal(t.target.closest(".modal"))}),DOM.settingsModal.addEventListener("click",Events.handleSettingsModalClick),DOM.contactGrid.addEventListener("click",t=>{const e=t.target.closest(".contact-card");e&&(window.location.hash=e.dataset.contactId)}),window.addEventListener("hashchange",()=>{const t=window.location.hash.substring(1),e=DOM.contactDetailModal.classList.contains("visible"),o=AppState.contacts.find(e=>e.sparrow_contact_id===t);t&&o?e||UI.renderContactModal(t):!t&&e&&Utils.hideModal(DOM.contactDetailModal)}),window.addEventListener("beforeunload",t=>{if(AppState.ui.unsavedChanges)return t.preventDefault(),t.returnValue=""})},populateDomObject:()=>{DOM={welcomeScreen:document.getElementById("welcomeScreen"),appScreen:document.getElementById("appScreen"),importCsvWelcomeBtn:document.getElementById("import-csv-btn-welcome"),importCsvHeaderBtn:document.getElementById("import-csv-btn-header"),csvFileInput:document.getElementById("csv-file-input"),fileDropZone:document.getElementById("file-drop-zone"),contactGrid:document.getElementById("contactGrid"),mainSearchInput:document.getElementById("main-search-input"),contactDetailModal:document.getElementById("contactDetailModal"),settingsModal:document.getElementById("settingsModal"),settingsBtn:document.getElementById("settings-btn"),saveReminder:document.getElementById("save-reminder"),saveReminderText:document.getElementById("save-reminder-text"),saveNowBtn:document.getElementById("save-now-btn"),loadMoreContainer:document.getElementById("loadMoreContainer"),loadMoreBtn:document.getElementById("loadMoreBtn"),ghostModeCheckbox:document.getElementById("ghostModeCheckbox"),notificationContainer:document.getElementById("notification-container"),confirmModal:{el:document.getElementById("confirmModal"),title:document.getElementById("confirm-title"),message:document.getElementById("confirm-message"),okBtn:document.getElementById("confirm-ok-btn"),cancelBtn:document.getElementById("confirm-cancel-btn")},addTaskModal:document.getElementById("addTaskModal"),logActivityModal:document.getElementById("logActivityModal"),addFieldModal:document.getElementById("addFieldModal")}},handleFileSelect:t=>{const e=t.target.files[0];e&&Events.readFile(e),t.target.value=""},handleDragOver:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.add("dragover")},handleDragLeave:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.remove("dragover")},handleDrop:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.classList.remove("dragover");const e=t.dataTransfer.files[0];e&&("text/csv"===e.type||e.name.endsWith(".csv"))?Events.readFile(e):UI.showNotification("Please drop a valid .csv file.","danger")},readFile:t=>{const e=new FileReader;e.onload=e=>{try{const o=Core.parseCSV(e.target.result);o.length>0?Core.processCSVData(o):UI.showNotification("CSV file is empty or could not be parsed.","danger")}catch(e){console.error(`${LOG_PREFIX} Error processing file:`,e),UI.showNotification(`Error processing file: ${e.message}`,"danger")}},e.readAsText(t)},handleSettingsModalClick:t=>{const e=t.target.closest("button");if(!e)return;if("save-settings-btn"===e.id){const t=[];return DOM.settingsModal.querySelectorAll("#fields-list li").forEach((e,o)=>{const n=e.dataset.fieldName,s=AppState.settings.fields.find(t=>t.name===n);s&&t.push({...s,type:e.querySelector(".field-type-select").value,visible:e.querySelector(".field-visibility-toggle").checked,order:o})}),AppState.settings.fields=t,AppState.settings.ghostMode=DOM.settingsModal.querySelector("#ghostModeCheckbox").checked,AppState.settings.ghostMode&&(localStorage.removeItem("sparrow-crm-state"),UI.showNotification("Ghost Mode On: Session restore is disabled.","info")),Core.setUnsavedChanges(!0),Utils.hideModal(DOM.settingsModal),UI.renderContactGrid(),void UI.showNotification("Settings updated. Save the file to make them permanent.","success")}if("delete-all-btn"===e.id)return void Core.deleteAllData();{const o=e.dataset.action,n=e.closest("li")?.dataset.fieldName;if(!o||!n)return;let s=AppState.settings.fields;const c=s.findIndex(t=>t.name===n);if(-1===c)return;"up"===o&&c>0?([s[c],s[c-1]]=[s[c-1],s[c]]):"down"===o&&c<s.length-1?([s[c],s[c+1]]=[s[c+1],s[c]]):"delete"===o&&(Core.deleteField(n),t.stopImmediatePropagation()),s.forEach((t,e)=>t.order=e),UI.renderSettingsModal()}},setupContactModalEventListeners:t=>{const e=DOM.contactDetailModal.querySelector(".modal-content");e&&(e.addEventListener("click",Events.handleContactModalClick),e.addEventListener("focusout",Events.handleContactModalFocusOut),e.addEventListener("keydown",Events.handleContactModalKeyDown),e.addEventListener("input",Events.handleContactModalInput),document.getElementById("modal-save-changes-btn").addEventListener("click",Core.saveData));DOM.addTaskModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.logActivityModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit);DOM.addFieldModal.querySelector("form").addEventListener("submit",Events.handleModalFormSubmit)},handleModalFormSubmit:t=>{t.preventDefault();const e=t.target.id,o=window.location.hash.substring(1);"add-task-form"===e?(Core.addTask(o,{title:document.getElementById("new-task-title").value,dueDate:document.getElementById("new-task-due-date").value}),Utils.hideModal(DOM.addTaskModal)):"log-activity-form"===e?(Core.logActivity(o,{type:document.getElementById("new-activity-type").value,description:document.getElementById("new-activity-desc").value,date:document.getElementById("new-activity-date").value}),Utils.hideModal(DOM.logActivityModal)):"add-field-form"===e&&(()=>{const t=document.getElementById("new-field-name").value,e=document.getElementById("new-field-type").value;if("relationship"===e){const t=document.getElementById("relationship-search-results").querySelector(".selected")?.dataset.contactId;Core.addRelationship(o,t,document.getElementById("new-field-name").value)}else Core.addCustomField(o,t,e);Utils.hideModal(DOM.addFieldModal)})()},handleContactModalClick:t=>{const e=window.location.hash.substring(1);if(t.target.closest("#modal-delete-contact-btn"))return void Core.deleteContact(e);if(t.target.closest("#add-task-btn-modal"))return void UI.showAddTaskModal();if(t.target.closest("#log-activity-btn-modal"))return void UI.showLogActivityModal();if(t.target.closest("#add-field-btn-modal"))return void UI.showAddFieldModal();const o=t.target.closest("[data-action]");if(o){const n=o.dataset.action;if("copy"===n)return void navigator.clipboard.writeText(o.dataset.value).then(()=>UI.showNotification("Copied!","info",1500));if("edit-task-date"===n){const e=o.closest("li").dataset.taskId,s=AppState.tasks.find(t=>t.sparrow_task_id===e).dueDate||"";return o.innerHTML=`<input type="date" class="inline-edit-input" value="${s}" data-task-id="${e}">`,void o.querySelector("input").focus()}const s=o.closest("li[data-task-id]")?.dataset.taskId;if(s)return void("toggle-task"===n?Core.updateTask(s,{status:"Completed"===AppState.tasks.find(t=>t.sparrow_task_id===s).status?"To-Do":"Completed"}):"delete-task"===n&&Core.deleteTask(s));const c=o.closest("li[data-activity-id]")?.dataset.activityId;if(c&&"delete-activity"===n)return void Core.deleteActivity(c)}const n=t.target.closest(".relationship-link");if(n)return t.preventDefault(),void(window.location.hash=n.dataset.contactId);const s=t.target.closest(".detail-field-group");s&&!s.querySelector("input, textarea")&&(s.querySelector(".detail-field-value").innerHTML=`<input type="text" class="inline-edit-input" value="${AppState.contacts.find(t=>t.sparrow_contact_id===e).fields[s.dataset.fieldName]||""}" data-original-value="${AppState.contacts.find(t=>t.sparrow_contact_id===e).fields[s.dataset.fieldName]||""}">`,s.querySelector(".inline-edit-input").focus())},handleContactModalFocusOut:t=>{if(t.target.classList.contains("inline-edit-input")){const e=t.target;if(e.dataset.taskId){const o=e.dataset.taskId,n=e.value;return void Core.updateTask(o,{dueDate:n})}const o=e.parentElement,n=o.closest(".detail-field-group").dataset.fieldName,s=window.location.hash.substring(1);Core.updateContactField(s,n,e.value,e.dataset.originalValue);const c=AppState.settings.fields.find(t=>t.name===n),i=Utils.formatFieldValue(e.value,c.type);let l=`<button title="Copy" data-action="copy" data-value="${e.value}">üìã</button>`;"email"===c.type?l+=`<a href="mailto:${e.value}" title="Email"><button>üìß</button></a>`:"phone"===c.type&&(l+=`<a href="tel:${e.value}" title="Call"><button>üìû</button></a>`),o.innerHTML=`<span class="value-text">${i}</span><div class="contextual-actions">${l}</div>`}},handleContactModalKeyDown:t=>{if(t.target.classList.contains("inline-edit-input"))if("Enter"===t.key)t.target.blur();else if("Escape"===t.key){const e=t.target;e.value=e.dataset.originalValue,t.target.blur()}},handleContactModalInput:t=>{if("new-field-type"===t.target.id)document.getElementById("relationship-creator-ui").classList.toggle("hidden","relationship"!==t.target.value);else if("relationship-search"===t.target.id){const e=t.target.value.toLowerCase(),o=document.getElementById("relationship-search-results");if(o.innerHTML="",e.length<2)return;const n=window.location.hash.substring(1),s=AppState.contacts.filter(t=>t.sparrow_contact_id!==n&&Utils.getContactDisplayName(t).toLowerCase().includes(e));s.slice(0,5).forEach(t=>{const e=document.createElement("div");e.className="relationship-search-result",e.dataset.contactId=t.sparrow_contact_id,e.textContent=Utils.getContactDisplayName(t),o.appendChild(e)})}}};
    function init(){console.log(`${LOG_PREFIX} Initializing application...`),AppState={contacts:[],tasks:[],activities:[],links:[],relationships:[],settings:{fields:[],customActivityTypes:["Phone Call","SMS","Email","Meeting"],ghostMode:!1},ui:{isFsaSupported:!1,fileHandle:null,unsavedChanges:!1,currentFilter:"",renderedContactsCount:0}},DOM={},Events.populateDomObject();let e=null;const o=document.getElementById("sparrow-data");if(o&&o.textContent.trim().length>2)try{e=JSON.parse(o.textContent)}catch(t){console.error(`${LOG_PREFIX} Failed to parse data.`,t)}else if(localStorage.getItem("sparrow-crm-state"))try{e=JSON.parse(localStorage.getItem("sparrow-crm-state"))}catch(t){console.error(`${LOG_PREFIX} Failed to parse local storage data.`,t)}e&&(AppState={...AppState,...e,ui:AppState.ui},window.addEventListener("unload",()=>{AppState.settings.ghostMode?localStorage.removeItem("sparrow-crm-state"):(()=>{const t={...AppState};delete t.ui,localStorage.setItem("sparrow-crm-state",JSON.stringify(t))})()})),Events.init(),AppState.ui.isFsaSupported="showOpenFilePicker"in window,AppState.contacts.length>0?UI.renderApp():UI.resetToWelcomeScreen();const n=new URLSearchParams(window.location.search);if(n.has("q")){const t=n.get("q");DOM.mainSearchInput.value=t,UI.renderContactGrid()}const s=window.location.hash.substring(1);s&&AppState.contacts.find(t=>t.sparrow_contact_id===s)&&UI.renderContactModal(s)}
    document.addEventListener('DOMContentLoaded', init);
    }());
    </script>

</body></html>
